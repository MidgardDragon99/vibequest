<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="icon" type="image/x-icon" href="./favicon.ico">
    <link rel="shortcut icon" href="./favicon.ico">


    <meta name="theme-color" content="#1a1a2e">
    <meta name="description" content="A retro RPG adventure. Defeat the Dragon and save the Kingdom of Vibe!">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Vibe Quest">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">

    <title>Vibe Quest</title>
    <style>
        :root {
    --bg-color: #2c3e50;
    --panel-bg: #34495e;
    --accent: #e74c3c;
    --gold: #f1c40f;
    --text: #ecf0f1;
    --fog: #1a252f;
    --select-border: #f1c40f;
    --select-bg: #d35400;
    
    /* Responsive sizing */
    --container-width: min(800px, 96vw);
    --container-height: min(600px, calc(100vh - 120px));
    --tile-size: min(calc(var(--container-width) / 15), calc(var(--container-height) / 15));
}

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        /* --- UI & HUD --- */
        #ui-panel {
    width: var(--container-width);
    background: var(--panel-bg);
    padding: clamp(5px, 1.5vw, 10px);
    border-radius: 8px;
    margin-bottom: 10px;
    display: flex;
    flex-wrap: nowrap;
    gap: clamp(5px, 1vw, 10px);
    box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    font-size: clamp(0.7rem, 1.5vw, 0.85rem);
    align-items: flex-start;
}

        .stats-area {
            display: flex;
            gap: clamp(5px, 1vw, 10px);
            flex-shrink: 0;
        }
        
        .buttons-area {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-left: auto;
            justify-content: flex-end;
            max-width: 60%;
        }
        
        .stat-col { display: flex; flex-direction: column; gap: 4px; }
        .stat-row { display: flex; align-items: center; gap: 5px; white-space: nowrap; }
        .gold-text { color: var(--gold); font-weight: bold; }
        .res-text { color: #3498db; }
        .wood-text { color: #e67e22; }
        .stone-text { color: #95a5a6; }

        .icon-btn {
            background: #9b59b6; border: none; padding: 10px; font-size: 1.2rem; height: 100%;
            border-radius: 4px; cursor: pointer; transition: 0.2s; width: 45px;
            display: flex; align-items: center; justify-content: center;
        }
        .icon-btn:hover { background: #8e44ad; }
        #map-btn { background: #2980b9; }
        #map-btn:hover { background: #3498db; }
        #journal-btn { background: #8e44ad; }
        #journal-btn:hover { background: #9b59b6; }
        #manual-btn { background: #27ae60; }
        #manual-btn:hover { background: #2ecc71; }
        #luminos-btn { background: #f39c12; display: none; }
        #luminos-btn:hover { background: #f1c40f; }
        
        /* Manual Screen - 90s Game Manual Style */
        #manual-screen {
            display: none;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 4px solid #f1c40f;
            box-shadow: 0 0 20px rgba(241, 196, 15, 0.3), inset 0 0 60px rgba(0,0,0,0.5);
        }
        
        .manual-container {
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 20px;
            font-family: 'Courier New', monospace;
        }
        
        .manual-header {
            text-align: center;
            border-bottom: 3px double #f1c40f;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        
        .manual-title {
            font-size: 2rem;
            color: #f1c40f;
            text-shadow: 2px 2px 0 #c0392b, 4px 4px 0 #000;
            letter-spacing: 3px;
            margin-bottom: 5px;
        }
        
        .manual-subtitle {
            font-size: 0.9rem;
            color: #e74c3c;
            font-style: italic;
        }
        
        .manual-section {
            margin-bottom: 25px;
            background: rgba(0,0,0,0.3);
            border: 2px solid #34495e;
            border-radius: 5px;
            padding: 15px;
        }
        
        .manual-section-title {
            font-size: 1.2rem;
            color: #3498db;
            border-bottom: 1px solid #3498db;
            padding-bottom: 5px;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        .manual-text {
            font-size: 0.85rem;
            line-height: 1.6;
            color: #bdc3c7;
        }
        
        .manual-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 8px 15px;
            margin: 10px 0;
        }
        
        .manual-icon {
            font-size: 1.5rem;
            text-align: center;
        }
        
        .manual-desc {
            font-size: 0.8rem;
            color: #ecf0f1;
            align-self: center;
        }
        
        .manual-tip {
            background: rgba(241, 196, 15, 0.1);
            border-left: 3px solid #f1c40f;
            padding: 10px;
            margin: 10px 0;
            font-size: 0.8rem;
            color: #f1c40f;
        }
        
        .manual-tip::before {
            content: "üí° TIP: ";
            font-weight: bold;
        }
        
        .manual-warning {
            background: rgba(231, 76, 60, 0.1);
            border-left: 3px solid #e74c3c;
            padding: 10px;
            margin: 10px 0;
            font-size: 0.8rem;
            color: #e74c3c;
        }
        
        .manual-warning::before {
            content: "‚ö†Ô∏è WARNING: ";
            font-weight: bold;
        }
        
        .manual-keys {
            display: inline-block;
            background: #2c3e50;
            border: 1px solid #7f8c8d;
            border-radius: 3px;
            padding: 2px 6px;
            font-size: 0.75rem;
            color: #ecf0f1;
            margin: 0 2px;
            box-shadow: 0 2px 0 #1a252f;
        }
        
        .manual-footer {
            text-align: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 3px double #f1c40f;
            font-size: 0.7rem;
            color: #7f8c8d;
        }
        
        /* Tooltips */
        .tooltip-btn { position: relative; }
        .tooltip-btn:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.95);
            color: #f1c40f;
            padding: 8px 12px;
            border-radius: 6px;
            white-space: nowrap;
            font-size: 0.85rem;
            z-index: 1000;
            margin-bottom: 8px;
            border: 1px solid #f1c40f;
            pointer-events: none;
        }
        .tooltip-btn:hover::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #f1c40f;
            z-index: 1000;
            margin-bottom: 2px;
            pointer-events: none;
        }

        /* --- Game Board --- */
      #game-container {
    position: relative;
    width: var(--container-width);
    height: var(--container-height);
    background: #000;
    border: 4px solid var(--panel-bg);
    border-radius: 4px;
    margin-bottom: 10px;
    touch-action: none;
    overflow: hidden;
}

      #grid {
            display: grid;
            grid-template-columns: repeat(15, 1fr);
            grid-template-rows: repeat(15, 1fr);
            width: 100%;
            height: 100%;
        }

       .tile {
    width: 100%; height: 100%;
    display: flex; align-items: center; justify-content: center;
   font-size: 24px;
    cursor: default; 
    user-select: none;
}

        .tile.grass { background-color: #2ecc71; }
        .tile.campfire { background-color: #e67e22; cursor: pointer; }
        .tile.campfire.fog { background-color: var(--fog) !important; }
        .tile.tree { background-color: #27ae60; cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" style="font-size:20px"><text y="15">ü™ì</text></svg>'), pointer; }
        .tile.tree:not(.fog):hover::after {
            content: 'ü™ì Chop tree!';
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: #f1c40f;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 0.9rem;
            pointer-events: none;
            z-index: 100;
            white-space: nowrap;
            border: 1px solid #f1c40f;
        }
        .tile.mountain { background-color: #7f8c8d; cursor: pointer; }
        
        /* Water Cursor */
        .tile.water { 
            background-color: #3498db; 
            cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32"><text y="20" font-size="20">üé£</text></svg>') 16 16, pointer;
        }
        .tile.water:not(.fog):hover::after {
            content: 'üé£ Fish!';
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: #f1c40f;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 0.9rem;
            pointer-events: none;
            z-index: 100;
            white-space: nowrap;
            border: 1px solid #f1c40f;
        }
        .tile.water.fished {
            background-color: #2980b9;
            cursor: default;
        }
        .tile.water.fished:not(.fog):hover::after {
            content: 'üö´ Fished out';
        }
        
        .tile.road { background-color: #95a5a6; border: 1px dashed #7f8c8d; box-sizing: border-box; }
        .tile.bridge { 
            background: linear-gradient(to bottom, #8B4513 0%, #8B4513 30%, #3498db 30%, #3498db 70%, #8B4513 70%, #8B4513 100%);
            cursor: pointer;
        }
        .tile.watchtower { 
            background-color: #8B7355; 
            border: 2px solid #5D4E37; 
            box-sizing: border-box;
            box-shadow: inset 0 0 8px rgba(241, 196, 15, 0.5);
        }
        .tile.chest { 
            background-color: #2ecc71; 
            cursor: pointer;
        }
        .tile.chest:not(.fog):hover::after {
            content: 'üì¶ Open chest!';
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: #f1c40f;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 0.9rem;
            pointer-events: none;
            z-index: 100;
            white-space: nowrap;
            border: 1px solid #f1c40f;
        }
        .tile.house { background-color: #e67e22; border: 1px solid #d35400; box-sizing: border-box; }
        .tile.castle { background-color: #9b59b6; box-shadow: inset 0 0 10px gold; cursor: pointer; }
        
        .tile.fog {
            background-color: var(--fog) !important;
            color: transparent !important;
            text-shadow: none !important;
            border: none !important;
            cursor: default !important;
        }

        /* --- Overlays --- */
        .overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.96);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            z-index: 10;
            padding: 20px;
            box-sizing: border-box;
            text-align: center;
            overflow-y: auto;
            overflow-x: hidden;
        }

        /* Start Screen Styling */
        #start-screen {
            z-index: 300;
            background: linear-gradient(135deg, #2c3e50 0%, #000000 100%);
            justify-content: center;
        }
        #welcome-screen {
            z-index: 300;
            background: linear-gradient(135deg, #1a252f 0%, #000000 100%);
            justify-content: flex-start;
            align-items: center;
            padding: 20px;
            overflow-y: auto;
        }
        .welcome-container {
            max-width: 600px;
            text-align: center;
            margin: auto;
            padding: 20px 0;
        }
        .welcome-title {
            font-size: 1.8rem;
            font-weight: bold;
            color: #f1c40f;
            margin-bottom: 20px;
            text-shadow: 0 0 20px rgba(241, 196, 15, 0.5);
        }
        .welcome-text {
            text-align: left;
            line-height: 1.7;
            color: #bdc3c7;
            font-size: 0.95rem;
            margin-bottom: 20px;
            padding: 0 10px;
        }
        .welcome-text p {
            margin-bottom: 12px;
        }
        .vibe-title {
            font-size: 4rem;
            font-weight: 900;
            text-transform: uppercase;
            background: linear-gradient(to right, #f1c40f, #e74c3c, #9b59b6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 30px;
            text-shadow: 0px 4px 10px rgba(0,0,0,0.5);
            letter-spacing: 2px;
        }
        .vibe-emojis { font-size: 3rem; margin-bottom: 20px; animation: bounce 2s infinite; }
        .quest-btn {
            font-size: 1.5rem;
            padding: 15px 50px;
            background: #27ae60;
            border: none;
            border-radius: 50px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 0 20px rgba(39, 174, 96, 0.4);
            transition: transform 0.2s, box-shadow 0.2s;
            animation: pulse 2s infinite;
        }
        .quest-btn:hover, .quest-btn:focus {
            transform: scale(1.1);
            background: #2ecc71;
            box-shadow: 0 0 30px rgba(46, 204, 113, 0.6);
            outline: none;
        }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* Keyboard Selection Highlight */
        .selected-btn {
            border: 2px solid var(--select-border) !important;
            background-color: var(--select-bg) !important;
            transform: scale(1.05);
            font-weight: bold;
            box-shadow: 0 0 10px rgba(241, 196, 15, 0.5);
        }

        #inventory-screen, #worldmap-screen { z-index: 50; background: rgba(0, 0, 0, 0.98); }
 #campfire-screen {
            overflow-y: auto !important;
            padding-bottom: 80px; /* Extra space for close button */
        }
#house-screen {
            overflow-y: auto !important;
            padding-bottom: 100px; /* Extra space for exit button */
        }

        #msg-screen { z-index: 200; background: rgba(0, 0, 0, 0.85); }

        /* Combat */
        .combat-avatar { font-size: 80px; margin: 5px; animation: bounce 2s infinite; }
        .combat-log { height: 40px; color: #bdc3c7; font-style: italic; margin-bottom: 10px; font-size: 0.85rem; }
        .action-bar { display: flex; flex-wrap: wrap; gap: 8px; width: 100%; justify-content: center; }

        /* General UI Elements */
        button {
            background: var(--panel-bg); border: 1px solid #7f8c8d; color: white;
            padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 0.9rem; transition: 0.1s;
        }
        button:hover { background: var(--accent); border-color: var(--accent); }
        button:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(100%); }
        .close-btn { margin-top: 20px; background: #c0392b; }
        
        .modal-btn-group { display: flex; flex-direction: column; gap: 10px; width: 80%; margin: 20px auto 0 auto; align-items: center; }
        .ng-plus-btn { background: gold; color: black; border-color: orange; font-weight: bold; }

        /* Inventory Screen */
        .inv-list { width: 100%; display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px; }
        .inv-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            background: #34495e; 
            padding: 10px; 
            border-radius: 4px; 
            border: 1px solid transparent;
            gap: 10px;
            min-width: 0;
        }
        
        .inv-item > span:first-child {
            flex: 1;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .inv-item.selected-btn { border-color: gold; }
        .inv-btn-use { background: #27ae60; padding: 5px 10px; font-size: 0.8rem; }

        /* House/Store Screen */
        .house-scene { font-size: 50px; margin-bottom: 10px; }
        .npc-text { 
            font-size: 1.1rem; color: #f1c40f; margin-bottom: 20px; font-style: italic; 
            border: 1px solid #f1c40f; padding: 15px; border-radius: 8px; background: rgba(0,0,0,0.5);
        }
        .store-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; margin: 0 auto 10px auto; max-width: 500px;}
        .store-item { background: #34495e; padding: 10px; border-radius: 4px; display: flex; flex-direction: column; gap: 5px;}
        .cost-text { color: var(--gold); font-size: 0.9rem; }
        .sell-text { color: #2ecc71; font-size: 0.9rem; }
        .section-header { width: 100%; max-width: 500px; border-bottom: 1px solid #7f8c8d; margin: 10px auto; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; color: #95a5a6; }

      /* Message Popup Box */
        .msg-box {
            background: #2c3e50;
            border: 3px solid #f1c40f;
            padding: 30px;
            border-radius: 12px;
            max-width: 80%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.9);
            text-align: center;
        }
        #msg-text { font-size: 1.2rem; margin-bottom: 20px; }
        #msg-ok-btn { margin-top: 10px; width: 100px; font-weight: bold; background: #27ae60; border-color: #2ecc71;}

        /* Cheat Code Modal */
        #cheat-screen { z-index: 250; background: rgba(0, 0, 0, 0.9); }
        #cheat-box {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 3px solid #9b59b6;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 0 30px rgba(155, 89, 182, 0.5);
        }
        #cheat-title {
            font-size: 1.3rem;
            color: #9b59b6;
            margin-bottom: 15px;
            text-shadow: 0 0 10px rgba(155, 89, 182, 0.5);
        }
        #cheat-input {
            width: 200px;
            padding: 10px 15px;
            font-size: 1.1rem;
            font-family: monospace;
            background: #0d0d1a;
            border: 2px solid #9b59b6;
            border-radius: 6px;
            color: #fff;
            text-align: center;
            margin-bottom: 15px;
        }
        #cheat-input:focus {
            outline: none;
            border-color: #e74c3c;
            box-shadow: 0 0 10px rgba(231, 76, 60, 0.5);
        }
        #cheat-input::placeholder {
            color: #555;
        }
        .cheat-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        .cheat-btn {
            padding: 8px 20px;
            font-size: 1rem;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid;
        }
        .cheat-ok {
            background: #9b59b6;
            border-color: #8e44ad;
            color: white;
        }
        .cheat-ok:hover {
            background: #8e44ad;
        }
        .cheat-cancel {
            background: #2c3e50;
            border-color: #34495e;
            color: #bdc3c7;
        }
        .cheat-cancel:hover {
            background: #34495e;
        }

        /* Level Up */
        .level-up-options { display: flex; flex-direction: column; gap: 10px; width: 80%; }
        button.spell-btn { border-color: #3498db; width: 100%; text-align: left; }
        button.spell-btn.selected-spell {
            background-color: #3498db !important;
            border-color: gold !important;
            box-shadow: 0 0 15px gold;
            transform: scale(1.02);
        }

          /* World Map Grid */
        #world-map-grid {
            display: grid;
            grid-template-columns: repeat(12, minmax(0, 1fr));
            grid-template-rows: repeat(12, 1fr);
            gap: 4px;
            width: 100%;
            aspect-ratio: 1;
        }
        
        .world-map-container {
            display: grid;
            grid-template-columns: 20px 1fr;
            grid-template-rows: 20px 1fr;
            gap: 4px;
            margin-bottom: 20px;
            width: min(520px, 85vw);
        }
        
        .wmap-corner {
            /* Empty corner cell */
        }
        
        .wmap-x-labels {
            display: grid;
            grid-template-columns: repeat(12, minmax(0, 1fr));
            gap: 4px;
        }
        
        .wmap-y-labels {
            display: grid;
            grid-template-rows: repeat(12, 1fr);
            gap: 4px;
        }
        
        .wmap-label {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            color: #7f8c8d;
            font-family: monospace;
        }
        
        .wmap-cell {
            background: #1a252f;
            border: 2px solid #34495e;
            border-radius: 4px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(0.8rem, 2vw, 1.2rem);
            color: #555;
            min-width: 0;
            min-height: 0;
        }

        .wmap-cell.visited {
            background: #2ecc71;
            border-color: #27ae60;
            color: rgba(255,255,255,0.3);
        }
        .wmap-cell.current {
            border: 2px solid #f1c40f;
            box-shadow: 0 0 10px rgba(241, 196, 15, 0.5);
            z-index: 2;
        }
        .wmap-cell.current::after { content: "üßô‚Äç‚ôÇÔ∏è"; font-size: 20px; }
        .road-ind { position: absolute; background: #95a5a6; }
        .road-n { top: 0; left: 50%; transform: translateX(-50%); width: 12px; height: 4px; }
        .road-s { bottom: 0; left: 50%; transform: translateX(-50%); width: 12px; height: 4px; }
        .road-w { left: 0; top: 50%; transform: translateY(-50%); width: 4px; height: 12px; }
        .road-e { right: 0; top: 50%; transform: translateY(-50%); width: 4px; height: 12px; }

 /* Mobile world map optimization */
        @media (max-width: 768px) {
            .world-map-container {
                width: 90vw;
                grid-template-columns: 16px 1fr;
                grid-template-rows: 16px 1fr;
            }
            
            #world-map-grid {
                gap: 2px;
            }
            
            .wmap-x-labels, .wmap-y-labels {
                gap: 2px;
            }
            
            .wmap-label {
                font-size: 0.5rem;
            }
            
            .wmap-cell {
                border-width: 1px;
                font-size: 0.9rem;
            }
            
            .modal-title {
                font-size: 1.3rem;
                margin-bottom: 10px;
            }
            
            #worldmap-screen {
                padding: 10px;
                padding-bottom: 100px;
                overflow-y: auto !important;
            }
            
            #worldmap-screen .close-btn {
                margin-top: 20px;
                margin-bottom: 20px;
            }
            
            /* Store/House screen fixes */
            #house-screen {
                padding: 15px;
                padding-bottom: 100px;
            }
            
            #house-screen .close-btn {
                margin-top: 20px;
                margin-bottom: 30px;
                position: relative;
                z-index: 10;
            }
            
            .store-grid {
                margin-bottom: 20px;
            }
            
            .tile {
                font-size: clamp(16px, 4vw, 22px);
            }
            
            /* Message box responsive sizing */
            .msg-box {
                max-width: 90vw;
                max-height: 70vh;
                padding: 20px;
                font-size: 0.9rem;
            }
            
            #msg-text {
                font-size: 1rem;
                line-height: 1.5;
            }
        }
        }
        
        @media (max-width: 768px) and (orientation: portrait) {
            #world-map-grid {
                width: 92vw;
                max-width: 400px;
            }
        }

        /* Animations */
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } 100% { transform: translateX(0); } }
        @keyframes flicker { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }
        .shake { animation: shake 0.3s; }
        .frozen { filter: hue-rotate(180deg) brightness(1.5); }
        .enraged { filter: hue-rotate(-30deg) saturate(2) brightness(1.2); animation: pulse-red 0.5s infinite; }
        @keyframes pulse-red { 0%, 100% { filter: hue-rotate(-30deg) saturate(2); } 50% { filter: hue-rotate(-30deg) saturate(3) brightness(1.3); } }
        
        /* Quest System Styles */
        .quest-card {
            background: #2c3e50;
            border: 2px solid #3498db;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            text-align: left;
        }
        .quest-card.completed {
            border-color: #27ae60;
            background: #1e3a2f;
        }
        .quest-card.ready {
            border-color: #f1c40f;
            animation: quest-glow 2s infinite;
        }
        @keyframes quest-glow {
            0%, 100% { box-shadow: 0 0 5px rgba(241, 196, 15, 0.3); }
            50% { box-shadow: 0 0 20px rgba(241, 196, 15, 0.8); }
        }
        .quest-title {
            color: #f1c40f;
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 8px;
        }
        .quest-giver {
            color: #3498db;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }
        .quest-journal {
            color: #bdc3c7;
            font-style: italic;
            font-size: 0.9rem;
            margin-bottom: 10px;
            line-height: 1.4;
        }
        .quest-progress {
            color: #e67e22;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }
        .quest-reward {
            color: #27ae60;
            font-size: 0.85rem;
        }
        .quest-location {
            color: #9b59b6;
            font-size: 0.85rem;
            margin-top: 5px;
        }
        .quest-turnin-btn {
            background: #27ae60;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            margin-top: 10px;
            font-weight: bold;
        }
        .quest-turnin-btn:hover { background: #2ecc71; }
        .no-quests {
            color: #7f8c8d;
            font-style: italic;
            padding: 20px;
            text-align: center;
        }
        .tile.quest-house {
            animation: house-glow 2s infinite;
        }
        @keyframes house-glow {
            0%, 100% { filter: brightness(1) drop-shadow(0 0 3px gold); }
            50% { filter: brightness(1.3) drop-shadow(0 0 8px gold); }
        }
        .wmap-cell.has-quest {
            border-color: #f1c40f !important;
            animation: wmap-quest-glow 2s infinite;
        }
        @keyframes wmap-quest-glow {
            0%, 100% { box-shadow: 0 0 5px #f1c40f; }
            50% { box-shadow: 0 0 15px #f1c40f, 0 0 25px #f39c12; }
        }
        #journal-btn { background: #8e44ad; }
        #journal-btn:hover { background: #9b59b6; }
        .journal-content {
            width: 100%;
            max-width: 550px;
            max-height: 55vh;
            overflow-y: auto;
        }
        
        .modal-title { font-size: 2rem; margin-bottom: 1rem; color: gold; }
/* Crafting Menu Styles */
.craft-section {
    background: var(--panel-bg);
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 15px;
    width: 100%;
    max-width: 550px;
}
.craft-title {
    font-size: 1.2rem;
    color: var(--gold);
    margin-bottom: 10px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
    user-select: none;
}
.craft-title:hover { color: #f39c12; }
.craft-items {
    display: grid;
    grid-template-columns: 1fr;
    gap: 10px;
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
}
.craft-items.expanded { max-height: 2000px; }
.craft-card {
    background: #2c3e50;
    padding: 12px;
    border-radius: 6px;
    border: 2px solid #555;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 10px;
}
.craft-info { text-align: left; flex: 1; }
.craft-name { font-weight: bold; color: var(--gold); margin-bottom: 4px; }
.craft-cost { color: #e67e22; font-size: 0.9rem; }
.craft-desc { color: #bbb; font-size: 0.85rem; margin-top: 4px; }
.craft-btn {
    padding: 8px 16px;
    background: #27ae60;
    border: none;
    border-radius: 4px;
    color: white;
    cursor: pointer;
    font-weight: bold;
    transition: 0.2s;
    white-space: nowrap;
}
.craft-btn:hover { background: #2ecc71; }
.craft-btn:disabled { background: #555; cursor: not-allowed; opacity: 0.5; }

/* Equipment Slots */
.equipment-section {
    background: var(--panel-bg);
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    width: 100%;
    max-width: 550px;
}
.equipment-title {
    font-size: 1.3rem;
    color: var(--gold);
    margin-bottom: 15px;
}
.equipment-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
}
.equipment-slot {
    background: #2c3e50;
    padding: 12px;
    border-radius: 6px;
    border: 2px solid #555;
    text-align: center;
}
.equipment-slot.has-item {
    border-color: var(--gold);
    background: #34495e;
}
.slot-label {
    font-size: 0.9rem;
    color: #95a5a6;
    margin-bottom: 8px;
}
.equipped-item { font-size: 1.5rem; margin: 8px 0; }
.equipped-name {
    color: var(--gold);
    font-weight: bold;
    margin-bottom: 5px;
}
.equipped-stats {
    font-size: 0.85rem;
    color: #3498db;
    margin-bottom: 8px;
}
.unequip-btn {
    padding: 6px 12px;
    background: #e74c3c;
    border: none;
    border-radius: 4px;
    color: white;
    cursor: pointer;
    font-size: 0.85rem;
    transition: 0.2s;
}
.unequip-btn:hover { background: #c0392b; }
/* --- MOBILE CONTROLS --- */
#mobile-controls {
    display: none;
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1000;
}

.dpad-container {
    position: relative;
    width: 150px;
    height: 150px;
}

.dpad-btn {
    position: absolute;
    width: 50px;
    height: 50px;
    background: rgba(52, 73, 94, 0.9);
    border: 2px solid var(--gold);
    border-radius: 8px;
    color: var(--text);
    font-size: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    user-select: none;
    touch-action: none;
    transition: all 0.1s ease;
}

.dpad-btn:active {
    background: var(--select-bg);
    transform: scale(0.95);
}

.dpad-btn.up {
    top: 0;
    left: 50px;
}

.dpad-btn.down {
    bottom: 0;
    left: 50px;
}

.dpad-btn.left {
    top: 50px;
    left: 0;
}

.dpad-btn.right {
    top: 50px;
    right: 0;
}

.dpad-btn.center {
    top: 50px;
    left: 50px;
    background: rgba(52, 73, 94, 0.7);
    border-color: rgba(241, 196, 15, 0.5);
    pointer-events: none;
}

/* Show controls on touch devices */
@media (hover: none) and (pointer: coarse) {
    #mobile-controls {
        display: block;
    }
}

/* Tablet and Mobile Landscape adjustments */
@media (max-width: 768px) and (orientation: landscape) {
    :root {
        --container-height: min(calc(100vh - 100px), 70vw);
        --container-width: min(70vw, calc(100vh - 100px));
    }    
    body {
        padding-top: 3px;
    }
    
    #ui-panel {
        grid-template-columns: repeat(6, auto);
        font-size: 0.65rem;
        gap: 4px;
        padding: 4px;
        margin-bottom: 4px;
    }
    
    .stat-col {
        font-size: 0.6rem;
        gap: 2px;
    }
    
    .icon-btn {
        width: 28px;
        height: 28px;
        font-size: 14px;
    }
    
    #mobile-controls {
        bottom: 10px;
    }
    
    .dpad-container {
        width: 110px;
        height: 110px;
    }
    
    .dpad-btn {
        width: 36px;
        height: 36px;
        font-size: 18px;
    }
    
    .dpad-btn.up { left: 37px; }
    .dpad-btn.down { left: 37px; }
    .dpad-btn.left { top: 37px; }
    .dpad-btn.right { top: 37px; }
    .dpad-btn.center { top: 37px; left: 37px; }
}
/* Small Phone Portrait (up to 600px) */
@media (max-width: 600px) and (orientation: portrait) {
    :root {
        --container-width: 95vw;
        --container-height: calc(100vh - 100px);
    }
    
    body {
        justify-content: flex-start;
        padding-top: 5px;
        overflow-y: auto;
        overflow-x: hidden;
    }
    
    #ui-panel {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        font-size: 0.7rem;
        gap: 5px;
        padding: 6px;
        margin-bottom: 5px;
    }
    
    .stat-col {
        font-size: 0.65rem;
        gap: 2px;
        flex: 0 0 auto;
    }
    
    .stat-row {
        gap: 3px;
    }
    
    /* Push buttons to the right and keep them together */
    .icon-btn {
        width: 32px;
        height: 32px;
        font-size: 16px;
        margin: 0;
    }
    
    /* First button gets pushed to the right */
    .icon-btn:first-of-type {
        margin-left: auto;
    }
}

/* Larger Phone/Tablet Portrait (601px - 768px) */
@media (min-width: 601px) and (max-width: 768px) and (orientation: portrait) {
    :root {
        --container-width: 90vw;
        --container-height: min(90vw, calc(100vh - 140px));
    }
    
    body {
        justify-content: flex-start;
        padding-top: 10px;
    }
    
    #ui-panel {
        display: flex;
        flex-wrap: nowrap;
        align-items: center;
        font-size: 0.75rem;
        gap: 8px;
        padding: 8px;
    }
    
    .stat-col {
        font-size: 0.7rem;
        flex: 0 0 auto;
    }
    
    /* Group buttons together on the right with no gaps */
    .icon-btn {
        width: 36px;
        height: 36px;
        font-size: 18px;
        margin: 0;
        margin-right: 2px; /* Small gap between buttons */
    }
    
    .icon-btn:first-of-type {
        margin-left: auto; /* Push buttons to right */
    }
    
    .icon-btn:last-of-type {
        margin-right: 0;
    }
}
/* Small phones */
@media (max-width: 480px) {
    :root {
        --container-height: calc(100vh - 90px);
    }
    
    body {
        padding-top: 3px;
    }
    
    #ui-panel {
        font-size: 0.65rem;
        gap: 4px;
        padding: 4px;
        margin-bottom: 3px;
    }
    
    .stat-col {
        font-size: 0.6rem;
    }
    
    .icon-btn {
        width: 28px;
        height: 28px;
        font-size: 14px;
    }
    
    .tile {
        font-size: 16px;
    }
    
    #mobile-controls {
        bottom: 5px;
    }
    
    .dpad-container {
        width: 100px;
        height: 100px;
    }
    
    .dpad-btn {
        width: 33px;
        height: 33px;
        font-size: 18px;
    }
    
    .dpad-btn.up { left: 33px; }
    .dpad-btn.down { left: 33px; }
    .dpad-btn.left { top: 33px; }
    .dpad-btn.right { top: 33px; }
    .dpad-btn.center { top: 33px; left: 33px; }
}
}
    </style>
</head>
<body>

    <div id="ui-panel">
        <div class="stats-area">
            <div class="stat-col">
                <div class="stat-row">üßô‚Äç‚ôÇÔ∏è Lvl <span id="ui-lvl">1</span></div>
                <div class="stat-row">üåü XP <span id="ui-xp">0</span>/<span id="ui-next-xp">100</span></div>
            </div>
            <div class="stat-col">
                <div class="stat-row">‚ù§Ô∏è <span id="ui-hp">100</span>/<span id="ui-max-hp">100</span></div>
                <div class="stat-row">üíô <span id="ui-mp">20</span>/<span id="ui-max-mp">20</span></div>
            </div>
            <div class="stat-col">
                <div class="stat-row">üí∞ <span id="ui-gold" class="gold-text">0</span></div>
                <div class="stat-row">
                    <span class="res-text">üêü <span id="ui-fish">0</span></span>
                    <span class="wood-text">ü™µ <span id="ui-wood">0</span></span>
                    <span class="stone-text">ü™® <span id="ui-stone">0</span></span>
                </div>
            </div>
        </div>
        <div class="buttons-area">
            <button id="inv-btn" class="icon-btn tooltip-btn" data-tooltip="Inventory - View items" onclick="openInventory()">üéí</button>
            <button id="journal-btn" class="icon-btn tooltip-btn" data-tooltip="Quest Journal - View active quests" onclick="openJournal()">üìú</button>
            <button id="map-btn" class="icon-btn tooltip-btn" data-tooltip="World Map - See explored areas" onclick="openWorldMap()">üó∫Ô∏è</button>
            <button id="manual-btn" class="icon-btn tooltip-btn" data-tooltip="Game Manual - How to play" onclick="openManual()">üìñ</button>
            <button id="music-btn" class="icon-btn tooltip-btn" data-tooltip="Toggle Music" onclick="toggleMusicBtn()">üéµ</button>
            <button id="luminos-btn" class="icon-btn tooltip-btn" data-tooltip="Luminos - Reveal map (20 MP)" onclick="castLuminos()" style="display: none;">‚òÄÔ∏è</button>
            <button id="reveal-shops-btn" class="icon-btn tooltip-btn" data-tooltip="Reveal Shops - Show stores (10 MP)" onclick="castRevealShops()" style="display: none;">üè™</button>
            <button id="reveal-camps-btn" class="icon-btn tooltip-btn" data-tooltip="Reveal Camps - Show campfires (20 MP)" onclick="castRevealCamps()" style="display: none;">üî•</button>
            <button id="reveal-chests-btn" class="icon-btn tooltip-btn" data-tooltip="Reveal Chests - Show chests (15 MP)" onclick="castRevealChests()" style="display: none;">üì¶</button>
            <button id="reveal-dragon-btn" class="icon-btn tooltip-btn" data-tooltip="Reveal Dragon - Find dragon (50 MP)" onclick="castRevealDragon()" style="display: none;">üêâ</button>
            <button id="reveal-castle-btn" class="icon-btn tooltip-btn" data-tooltip="Reveal Castle - Find castle (50 MP)" onclick="castRevealCastle()" style="display: none;">üè∞</button>
        </div>
    </div>

    <div id="game-container">
        <div id="grid"></div>

        <div id="start-screen" class="overlay" style="display: flex;">
            <div class="vibe-emojis">üßô‚Äç‚ôÇÔ∏è ‚ú® üêâ</div>
            <div class="vibe-title">VIBE QUEST</div>
            <button class="quest-btn" id="start-btn" onclick="showWelcomeScreen()">QUEST</button>
        </div>

        <div id="welcome-screen" class="overlay" style="display: none;">
            <div class="welcome-container">
                <div class="welcome-title">‚ú® Welcome to the World of Vibe ‚ú®</div>
                <div class="welcome-text">
                    <p>Long ago, the Kingdom of Vibe flourished under the benevolent rule of King Aldric and his daughter, Princess Elara. The land was peaceful, the harvests plentiful, and magic flowed freely through the realm.</p>
                    
                    <p>Then came the Dragon.</p>
                    
                    <p>From the shadowed peaks it descended: a beast of ancient malice, wreathed in dark flame. The King fell defending his people. The Princess fled to a hidden castle, clutching the last hope of the kingdom: the Blade of Dawn, a legendary sword said to be the only weapon capable of slaying the beast.</p>
                    
                    <p>Now the land lies shrouded in fog. Monsters roam freely. Villages cower in fear. The people whisper of a prophecy, that one day, a wandering wizard would rise to challenge the Dragon and restore peace to Vibe.</p>
                    
                    <p style="color: #f1c40f; margin-top: 20px;"><em>You are that wizard.</em></p>
                    
                    <p>Find the Princess. Claim the Blade of Dawn. Defeat the Dragon. Save the World of Vibe.</p>
                </div>
                <button class="quest-btn" id="begin-adventure-btn" onclick="beginAdventure()">Begin Your Quest</button>
                <p style="color: #7f8c8d; font-size: 0.85rem; margin-top: 10px;">(Press Enter to continue)</p>
            </div>
        </div>

        <div id="msg-screen" class="overlay">
            <div class="msg-box">
                <p id="msg-text">Message</p>
                <button id="msg-ok-btn" class="selected-btn" onclick="closeAlert()">OK</button>
            </div>
        </div>

        <div id="cheat-screen" class="overlay" style="display: none;">
            <div id="cheat-box">
                <div id="cheat-title">üéÆ Enter Code</div>
                <input type="text" id="cheat-input" placeholder="??????" maxlength="20" autocomplete="off" spellcheck="false">
                <div class="cheat-buttons">
                    <button class="cheat-btn cheat-ok" onclick="submitCheatCode()">OK</button>
                    <button class="cheat-btn cheat-cancel" onclick="closeCheatModal()">Cancel</button>
                </div>
            </div>
        </div>

        <div id="inventory-screen" class="overlay">
    <div class="modal-title">üéí Inventory</div>
    
    <!-- Equipment Section -->
    <div class="equipment-section">
        <div class="equipment-title">‚öî Equipment</div>
        <div class="equipment-grid">
            <div id="weapon-slot" class="equipment-slot">
                <div class="slot-label">Weapon</div>
                <div id="weapon-display"></div>
            </div>
            <div id="shield-slot" class="equipment-slot">
                <div class="slot-label">Shield</div>
                <div id="shield-display"></div>
            </div>
            <div id="helmet-slot" class="equipment-slot">
                <div class="slot-label">Helmet</div>
                <div id="helmet-display"></div>
            </div>
        </div>
    </div>

    <!-- Terrain Modification Section -->
    <div class="craft-section">
        <div class="craft-title" onclick="toggleTerrainMenu()">
            üõ†Ô∏è Terrain Modifications <span id="terrain-arrow">‚ñº</span>
        </div>
        <div id="terrain-menu" class="craft-items"></div>
    </div>

    <!-- Utility Spells Section -->
    <div class="craft-section">
        <div class="craft-title" onclick="toggleSpellsMenu()">
            ‚ú® Utility Spells <span id="spells-arrow">‚ñº</span>
        </div>
        <div id="spells-menu" class="craft-items"></div>
    </div>

    <!-- Items Section -->
    <div class="craft-section">
        <div class="craft-title" onclick="toggleItemsMenu()">
            üéí Items <span id="items-menu-arrow">‚ñº</span>
        </div>
        <div id="items-menu" class="craft-items"></div>
    </div>

    <button class="close-btn" onclick="closeInventory()">Close Bag (ESC)</button>
</div>

        <div id="worldmap-screen" class="overlay">
            <div class="modal-title">üó∫Ô∏è World Map</div>
            <div class="world-map-container">
                <div class="wmap-corner"></div>
                <div class="wmap-x-labels" id="wmap-x-labels"></div>
                <div class="wmap-y-labels" id="wmap-y-labels"></div>
                <div id="world-map-grid"></div>
            </div>
            <button class="close-btn" onclick="closeWorldMap()">Close Map (ESC)</button>
        </div>

        <div id="journal-screen" class="overlay">
            <div class="modal-title">üìú Quest Journal</div>
            <div id="journal-stats" style="margin-bottom: 15px; color: #f1c40f;"></div>
            <div id="journal-content" class="journal-content"></div>
            <button class="close-btn" onclick="closeJournal()">Close Journal (ESC)</button>
        </div>

        <div id="manual-screen" class="overlay">
            <div class="manual-container">
                <div class="manual-header">
                    <div class="manual-title">üìñ VIBE QUEST üìñ</div>
                    <div class="manual-subtitle">~ Official Player's Manual ~</div>
                    <div style="font-size: 0.7rem; color: #7f8c8d; margin-top: 5px;">Version 1.0 | Single Player | Ages 10+</div>
                </div>

                <div class="manual-section">
                    <div class="manual-section-title">üéÆ Controls</div>
                    <div class="manual-text">
                        <div class="manual-grid">
                            <div class="manual-icon">‚¨ÜÔ∏è‚¨áÔ∏è‚¨ÖÔ∏è‚û°Ô∏è</div>
                            <div class="manual-desc"><span class="manual-keys">Arrow Keys</span> or <span class="manual-keys">W</span><span class="manual-keys">A</span><span class="manual-keys">S</span><span class="manual-keys">D</span> - Move your wizard</div>
                            <div class="manual-icon">üì±</div>
                            <div class="manual-desc"><span class="manual-keys">Tap</span> or <span class="manual-keys">Swipe</span> - Touch controls on mobile</div>
                            <div class="manual-icon">üéí</div>
                            <div class="manual-desc"><span class="manual-keys">I</span> - Open Inventory</div>
                            <div class="manual-icon">üó∫Ô∏è</div>
                            <div class="manual-desc"><span class="manual-keys">M</span> - Open World Map</div>
                            <div class="manual-icon">üìú</div>
                            <div class="manual-desc"><span class="manual-keys">J</span> - Open Quest Journal</div>
                            <div class="manual-icon">‚ùå</div>
                            <div class="manual-desc"><span class="manual-keys">ESC</span> - Close menus</div>
                            <div class="manual-icon">‚úÖ</div>
                            <div class="manual-desc"><span class="manual-keys">Enter</span> or <span class="manual-keys">Space</span> - Confirm actions</div>
                        </div>
                    </div>
                </div>

                <div class="manual-section">
                    <div class="manual-section-title">üó∫Ô∏è World Tiles</div>
                    <div class="manual-text">
                        <div class="manual-grid">
                            <div class="manual-icon">üå≤</div>
                            <div class="manual-desc"><strong>Trees</strong> - Chop for wood!</div>
                            <div class="manual-icon">üèîÔ∏è</div>
                            <div class="manual-desc"><strong>Mountains</strong> - Clear with wood to get stone.</div>
                            <div class="manual-icon">üåä</div>
                            <div class="manual-desc"><strong>Water</strong> - Fish for food! May find gold coins.</div>
                            <div class="manual-icon">üü©</div>
                            <div class="manual-desc"><strong>Grass</strong> - Safe to walk. Watch for random encounters!</div>
                            <div class="manual-icon">üõ§Ô∏è</div>
                            <div class="manual-desc"><strong>Roads</strong> - Safe passage between map edges.</div>
                            <div class="manual-icon">üè†</div>
                            <div class="manual-desc"><strong>Houses</strong> - NPCs with quests and lore.</div>
                            <div class="manual-icon">üè™</div>
                            <div class="manual-desc"><strong>Shops</strong> - Buy potions, spells, and sell items.</div>
                            <div class="manual-icon">üî•</div>
                            <div class="manual-desc"><strong>Campfires</strong> - Rest to heal and craft items.</div>
                            <div class="manual-icon">üì¶üéÅüíé</div>
                            <div class="manual-desc"><strong>Chests</strong> - Treasure! Rarity varies by level.</div>
                            <div class="manual-icon">üè∞</div>
                            <div class="manual-desc"><strong>Castle</strong> - Where the Princess is rumored to be in hiding.</div>
                            <div class="manual-icon">üêâ</div>
                            <div class="manual-desc"><strong>Dragon</strong> - The final boss. Defeat to save Vibe!</div>
                        </div>
                    </div>
                </div>

                <div class="manual-section">
                    <div class="manual-section-title">üëæ Enemies & Combat</div>
                    <div class="manual-text">
                        <div class="manual-grid">
                            <div class="manual-icon">ü¶á</div>
                            <div class="manual-desc"><strong>Bat</strong> - Evasive! Use True Strike to hit.</div>
                            <div class="manual-icon">üê∫</div>
                            <div class="manual-desc"><strong>Wolf</strong> - Multi-attack. Use Slow spell!</div>
                            <div class="manual-icon">üëª</div>
                            <div class="manual-desc"><strong>Ghost</strong> - Evasive! Use True Strike to hit.</div>
                            <div class="manual-icon">üíß</div>
                            <div class="manual-desc"><strong>Slime</strong> - Regenerates HP. Use Bleed to stop!</div>
                            <div class="manual-icon">üêç</div>
                            <div class="manual-desc"><strong>Viper</strong> - Poisonous! Use Cleanse spell.</div>
                            <div class="manual-icon">üë∫</div>
                            <div class="manual-desc"><strong>Goblin</strong> - Enrages when low HP. Kill fast!</div>
                            <div class="manual-icon">üßå</div>
                            <div class="manual-desc"><strong>Orc</strong> - Enrages when low HP. Kill fast!</div>
                            <div class="manual-icon">üëπ</div>
                            <div class="manual-desc"><strong>Ogre</strong> - Heavy armor. Use Shatter spell!</div>
                            <div class="manual-icon">üóø</div>
                            <div class="manual-desc"><strong>Gargoyle</strong> - Heavy armor. Use Shatter spell!</div>
                            <div class="manual-icon">üêü</div>
                            <div class="manual-desc"><strong>Piranha</strong> - Swarms on bridges. Multi-attack!</div>
                        </div>
                        <div class="manual-tip">Each enemy type has a weakness. Learn their behaviors and counter with the right spell!</div>
                    </div>
                </div>

                <div class="manual-section">
                    <div class="manual-section-title">‚ú® Spells</div>
                    <div class="manual-text">
                        <p>Learn new spells when leveling up! Choose wisely.</p>
                        <div class="manual-grid">
                            <div class="manual-icon">üî•</div>
                            <div class="manual-desc"><strong>Fireball</strong> (8 MP) - Reliable damage spell.</div>
                            <div class="manual-icon">‚ö°</div>
                            <div class="manual-desc"><strong>Lightning</strong> (10 MP) - High damage output.</div>
                            <div class="manual-icon">‚ùÑÔ∏è</div>
                            <div class="manual-desc"><strong>Iceball</strong> (12 MP) - Freezes enemy for 2 turns!</div>
                            <div class="manual-icon">‚ù§Ô∏è</div>
                            <div class="manual-desc"><strong>Heal</strong> (5 MP) - Restore 30 HP.</div>
                            <div class="manual-icon">üíñ</div>
                            <div class="manual-desc"><strong>Mega Heal</strong> (15 MP) - Full HP restore!</div>
                            <div class="manual-icon">ü©∏</div>
                            <div class="manual-desc"><strong>Bleed</strong> (6 MP) - Damage over time, stops regen.</div>
                            <div class="manual-icon">üíö</div>
                            <div class="manual-desc"><strong>Cleanse</strong> (8 MP) - Remove poison/debuffs.</div>
                            <div class="manual-icon">üî®</div>
                            <div class="manual-desc"><strong>Shatter</strong> (10 MP) - Breaks enemy armor!</div>
                            <div class="manual-icon">üéØ</div>
                            <div class="manual-desc"><strong>True Strike</strong> (7 MP) - Never misses!</div>
                            <div class="manual-icon">üåÄ</div>
                            <div class="manual-desc"><strong>Slow</strong> (8 MP) - Reduces enemy attacks.</div>
                            <div class="manual-icon">üíÄ</div>
                            <div class="manual-desc"><strong>Drain Life</strong> (12 MP) - Damage + heal yourself.</div>
                        </div>
                    </div>
                </div>

                <div class="manual-section">
                    <div class="manual-section-title">‚öî Equipment</div>
                    <div class="manual-text">
                        <div class="manual-grid">
                            <div class="manual-icon">üó°Ô∏è</div>
                            <div class="manual-desc"><strong>Wooden Sword</strong> - Basic weapon. You start with this.</div>
                            <div class="manual-icon">ü™Ñ</div>
                            <div class="manual-desc"><strong>Reinforced Staff</strong> - Stronger weapon. Craft at campfire.</div>
                            <div class="manual-icon">üî∞</div>
                            <div class="manual-desc"><strong>Wooden Shield</strong> - Basic protection. Craft at campfire.</div>
                            <div class="manual-icon">ü™ñ</div>
                            <div class="manual-desc"><strong>Leather Helmet</strong> - Basic headgear. You start with this.</div>
                            <div class="manual-icon">‚öîÔ∏è</div>
                            <div class="manual-desc"><strong>Blade of Dawn</strong> - The King's legendary sword.</div>
                            <div class="manual-icon">üõ°Ô∏è</div>
                            <div class="manual-desc"><strong>Enchanted Shield</strong> - Rumored to seek out the worthy!</div>
                            <div class="manual-icon">‚õëÔ∏è</div>
                            <div class="manual-desc"><strong>Rock Helmet</strong> - If the Stones deem you worthy.</div>
                        </div>
                        <div class="manual-tip">Craft weapons and shields at campfires using wood!</div>
                    </div>
                </div>

                <div class="manual-section">
                    <div class="manual-section-title">üîÆ Reveal Spells</div>
                    <div class="manual-text">
                        <p>Learn these by buying from shops!</p>
                        <div class="manual-grid">
                            <div class="manual-icon">‚òÄÔ∏è</div>
                            <div class="manual-desc"><strong>Luminos</strong> (20 MP) - Reveal entire current map.</div>
                            <div class="manual-icon">üè™</div>
                            <div class="manual-desc"><strong>Reveal Shops</strong> (10 MP) - Show stores on map.</div>
                            <div class="manual-icon">üî•</div>
                            <div class="manual-desc"><strong>Reveal Camps</strong> (20 MP) - Show campfires.</div>
                            <div class="manual-icon">üì¶üéÅüíé</div>
                            <div class="manual-desc"><strong>Reveal Chests</strong> (15 MP) - Show treasure chests.</div>
                            <div class="manual-icon">üêâ</div>
                            <div class="manual-desc"><strong>Reveal Dragon</strong> (50 MP) - Find the Dragon's lair!</div>
                            <div class="manual-icon">üè∞</div>
                            <div class="manual-desc"><strong>Reveal Castle</strong> (50 MP) - Find the Princess!</div>
                        </div>
                    </div>
                </div>

                <div class="manual-section">
                    <div class="manual-section-title">üìã Quests</div>
                    <div class="manual-text">
                        <p>Talk to NPCs in houses to receive quests. Complete them for gold and XP!</p>
                        <p>Quest types include: Collect resources, defeat monsters, find locations, and more.</p>
                        <p>Check your <strong>Quest Journal</strong> (üìú) to track progress. Glowing houses on the world map have quests ready to turn in!</p>
                        <div class="manual-tip">You can have multiple active quests at once!</div>
                    </div>
                </div>

                <div class="manual-section">
                    <div class="manual-section-title">üè™ Shops & Economy</div>
                    <div class="manual-text">
                        <p>Find shops to buy potions and sell materials.</p>
                        <div class="manual-grid">
                            <div class="manual-icon">üç∑</div>
                            <div class="manual-desc"><strong>Health Potion</strong> - Buy for 20g, restores 25 HP.</div>
                            <div class="manual-icon">üíß</div>
                            <div class="manual-desc"><strong>Mana Potion</strong> - Buy for 15g, restores 10 MP.</div>
                            <div class="manual-icon">üêü</div>
                            <div class="manual-desc"><strong>Fish</strong> - Sell for 5g each or cook at campfires.</div>
                            <div class="manual-icon">ü™µ</div>
                            <div class="manual-desc"><strong>Wood</strong> - Sell for 3g each or use to craft at campfires.</div>
                            <div class="manual-icon">ü™®</div>
                            <div class="manual-desc"><strong>Stone</strong> - Sell for 8g, or throw for 10 damage!</div>
                        </div>
                    </div>
                </div>

                <div class="manual-section">
                    <div class="manual-section-title">üéØ Your Quest</div>
                    <div class="manual-text">
                        <p><strong>Primary Objective:</strong> Defeat the Dragon and save the Kingdom of Vibe!</p>
                        <ol style="margin: 10px 0; padding-left: 20px; color: #bdc3c7;">
                            <li>Explore the fog-covered world</li>
                            <li>Gain experience and level up</li>
                            <li>Find the hidden Castle (üè∞)</li>
                            <li>Receive a blessing from the Princess</li>
                            <li>Locate and defeat the Dragon (üêâ)</li>
                        </ol>
                        <div class="manual-warning">The Dragon is extremely powerful! Make sure you're well-equipped and high level before confronting it.</div>
                    </div>
                </div>

                <div class="manual-section">
                    <div class="manual-section-title">üåü Secrets</div>
                    <div class="manual-text" style="color: #7f8c8d; font-style: italic;">
                        <p>"They say the Dragon is not the true evil..."</p>
                        <p>"There is something older, darker..."</p>
                        <p>"If one were to pierce every veil of fog across the entire world..."</p>
                        <p style="text-align: center; margin-top: 15px;">???</p>
                    </div>
                </div>

                <div class="manual-footer">
                    <p>¬© 2024 VIBE QUEST‚Ñ¢ | All Rights Reserved</p>
                    <p>Made with ‚ú® magic and üíª code</p>
                    <p style="margin-top: 10px; font-size: 0.6rem;">Licensed to: A TRUE HERO</p>
                </div>
            </div>
            <button class="close-btn" onclick="closeManual()">Close Manual (ESC)</button>
        </div>

<div id="campfire-screen" class="overlay">
    <div class="modal-title">üî• Campfire</div>
    <p style="margin-bottom: 20px;">Rest and craft at the campfire.</p>
    
    <div id="campfire-rest-btn-container"></div>

    <div class="craft-section">
        <div class="craft-title" onclick="toggleCraftSection('items')">
            üî® Craft Items <span id="items-arrow">‚ñº</span>
        </div>
        <div id="craft-items-menu" class="craft-items"></div>
    </div>

    <div class="craft-section">
        <div class="craft-title" onclick="toggleCraftSection('enhancements')">
            ‚ö° Campfire Enhancements <span id="enhancements-arrow">‚ñº</span>
        </div>
        <div id="craft-enhancements-menu" class="craft-items"></div>
    </div>
<div class="craft-section">
        <div class="craft-title" onclick="toggleCraftSection('cooking')">
            üç≥ Cook Food <span id="cooking-arrow">‚ñº</span>
        </div>
        <div id="craft-cooking-menu" class="craft-items"></div>
    </div>
    <button class="close-btn" onclick="closeCampfireMenu()">Leave Campfire (ESC)</button>
</div>
        <div id="house-screen" class="overlay">
            <div class="house-scene" id="house-icon">üè†</div>
            <h2 id="house-title">Village House</h2>
            <div id="npc-dialogue" class="npc-text"></div>

            
            <div id="store-area" style="display:none; width:100%;">
                <div id="store-content"></div>
            </div>
            
            <button class="close-btn" onclick="exitHouse()">Leave (ESC)</button>
        </div>

        <div id="combat-screen" class="overlay">
            <div style="text-align: center;">
                <div class="combat-avatar" id="enemy-avatar">üë∫</div>
                <h3 id="enemy-name">Goblin</h3>
                <div id="enemy-hp-bar">Health: 50/50</div>
                <div id="enemy-status" style="color: #3498db; height: 20px;"></div>
            </div>
            <div class="combat-log" id="combat-log"></div>
            <div class="action-bar" id="combat-actions"></div>
        </div>

        <div id="levelup-screen" class="overlay">
            <div class="modal-title">üéâ LEVEL UP! üéâ</div>
            <p>HP & MP Increased! Choose a spell:</p>
            <div id="spell-options" class="level-up-options"></div>
        </div>

        <div id="modal-screen" class="overlay">
            <div style="text-align: center; width: 100%;">
                <div class="modal-title" id="modal-title">GAME OVER</div>
                <div class="modal-btn-group" id="modal-btns"></div>
            </div>
        </div>
    </div>

    <script>
        /* --- CHIPTUNE AUDIO SYSTEM --- */
        let audioCtx = null;
        let masterGain = null;
        let currentTrack = null;
        let isPlaying = false;
        let sequencerInterval = null;
        let audioInitialized = false;
        
        // Note frequencies (4th octave as base)
        const NOTES = {
            'C3': 130.81, 'D3': 146.83, 'E3': 164.81, 'F3': 174.61, 'G3': 196.00, 'A3': 220.00, 'B3': 246.94,
            'C4': 261.63, 'D4': 293.66, 'E4': 329.63, 'F4': 349.23, 'G4': 392.00, 'A4': 440.00, 'B4': 493.88,
            'C5': 523.25, 'D5': 587.33, 'E5': 659.25, 'F5': 698.46, 'G5': 783.99, 'A5': 880.00, 'B5': 987.77,
            'C6': 1046.50, 'D6': 1174.66, 'E6': 1318.51,
            // Sharps/Flats
            'Db3': 138.59, 'Eb3': 155.56, 'Gb3': 185.00, 'Ab3': 207.65, 'Bb3': 233.08,
            'Db4': 277.18, 'Eb4': 311.13, 'Gb4': 369.99, 'Ab4': 415.30, 'Bb4': 466.16,
            'Db5': 554.37, 'Eb5': 622.25, 'Gb5': 739.99, 'Ab5': 830.61, 'Bb5': 932.33,
            'REST': 0
        };
        
        // Initialize audio context (must be called after user interaction)
        function initAudio() {
            if (audioInitialized) return;
            try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                masterGain = audioCtx.createGain();
                masterGain.gain.value = 0.3;
                masterGain.connect(audioCtx.destination);
                audioInitialized = true;
            } catch (e) {
                console.log('Web Audio not supported');
            }
        }
        
        // Create an oscillator with NES-style waveform
        function createOscillator(type, frequency, duration, startTime, volume = 0.3) {
            if (!audioCtx || frequency === 0) return;
            
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            osc.type = type; // 'square', 'triangle', 'sawtooth'
            osc.frequency.value = frequency;
            
            gain.gain.setValueAtTime(volume, startTime);
            gain.gain.exponentialRampToValueAtTime(0.01, startTime + duration * 0.9);
            
            osc.connect(gain);
            gain.connect(masterGain);
            
            osc.start(startTime);
            osc.stop(startTime + duration);
        }
        
        // Play a note with optional arpeggio
        function playNote(note, duration, startTime, type = 'square', volume = 0.3) {
            const freq = NOTES[note] || 0;
            if (freq > 0) {
                createOscillator(type, freq, duration, startTime, volume);
            }
        }
        
        // Music tracks
        const TRACKS = {
            // üó∫Ô∏è OVERWORLD THEME - Adventurous, hopeful melody
            overworld: {
                bpm: 140,
                melody: [
                    // Main theme - hopeful adventure
                    'E4', 'E4', 'REST', 'E4', 'REST', 'C4', 'E4', 'REST',
                    'G4', 'REST', 'REST', 'REST', 'G3', 'REST', 'REST', 'REST',
                    'C4', 'REST', 'REST', 'G3', 'REST', 'REST', 'E3', 'REST',
                    'REST', 'A3', 'REST', 'B3', 'REST', 'Bb3', 'A3', 'REST',
                    'G3', 'E4', 'G4', 'A4', 'REST', 'F4', 'G4', 'REST',
                    'E4', 'REST', 'C4', 'D4', 'B3', 'REST', 'REST', 'REST',
                    // Repeat with variation
                    'C4', 'REST', 'REST', 'G3', 'REST', 'REST', 'E3', 'REST',
                    'REST', 'A3', 'REST', 'B3', 'REST', 'Bb3', 'A3', 'REST',
                    'G3', 'E4', 'G4', 'A4', 'REST', 'F4', 'G4', 'REST',
                    'E4', 'REST', 'C4', 'D4', 'B3', 'REST', 'REST', 'REST'
                ],
                bass: [
                    'C3', 'REST', 'G3', 'REST', 'C3', 'REST', 'G3', 'REST',
                    'G3', 'REST', 'D3', 'REST', 'G3', 'REST', 'D3', 'REST',
                    'C3', 'REST', 'G3', 'REST', 'C3', 'REST', 'G3', 'REST',
                    'A3', 'REST', 'E3', 'REST', 'A3', 'REST', 'E3', 'REST',
                    'G3', 'REST', 'D3', 'REST', 'G3', 'REST', 'D3', 'REST',
                    'C3', 'REST', 'G3', 'REST', 'G3', 'REST', 'D3', 'REST',
                    'C3', 'REST', 'G3', 'REST', 'C3', 'REST', 'G3', 'REST',
                    'A3', 'REST', 'E3', 'REST', 'A3', 'REST', 'E3', 'REST',
                    'G3', 'REST', 'D3', 'REST', 'G3', 'REST', 'D3', 'REST',
                    'C3', 'REST', 'G3', 'REST', 'C3', 'REST', 'G3', 'REST'
                ]
            },
            
            // ‚öîÔ∏è BATTLE THEME - Intense, driving rhythm
            battle: {
                bpm: 180,
                melody: [
                    // Aggressive, urgent melody
                    'E5', 'E5', 'E5', 'REST', 'C5', 'E5', 'REST', 'REST',
                    'B4', 'REST', 'REST', 'REST', 'REST', 'REST', 'REST', 'REST',
                    'E5', 'Eb5', 'D5', 'REST', 'C5', 'REST', 'B4', 'REST',
                    'C5', 'REST', 'REST', 'REST', 'REST', 'REST', 'REST', 'REST',
                    'E5', 'E5', 'E5', 'REST', 'C5', 'E5', 'REST', 'REST',
                    'G5', 'REST', 'REST', 'REST', 'REST', 'G4', 'REST', 'REST',
                    'A4', 'B4', 'C5', 'REST', 'B4', 'A4', 'G4', 'REST',
                    'E4', 'REST', 'REST', 'REST', 'REST', 'REST', 'REST', 'REST'
                ],
                bass: [
                    'E3', 'E3', 'E4', 'E3', 'E3', 'E4', 'E3', 'E4',
                    'B3', 'B3', 'B3', 'B3', 'B3', 'B3', 'B3', 'B3',
                    'C3', 'C3', 'C4', 'C3', 'C3', 'C4', 'C3', 'C4',
                    'A3', 'A3', 'A3', 'A3', 'G3', 'G3', 'G3', 'G3',
                    'E3', 'E3', 'E4', 'E3', 'E3', 'E4', 'E3', 'E4',
                    'G3', 'G3', 'G3', 'G3', 'G3', 'G3', 'G3', 'G3',
                    'A3', 'A3', 'B3', 'B3', 'C3', 'C3', 'D3', 'D3',
                    'E3', 'E3', 'E3', 'E3', 'E3', 'E3', 'E3', 'E3'
                ]
            },
            
            // üêâ BOSS THEME - Dark, menacing, epic
            boss: {
                bpm: 150,
                melody: [
                    // Ominous, powerful theme
                    'E4', 'REST', 'E4', 'REST', 'Eb4', 'REST', 'Eb4', 'REST',
                    'D4', 'REST', 'D4', 'REST', 'Db4', 'REST', 'Db4', 'REST',
                    'C4', 'REST', 'E4', 'REST', 'G4', 'REST', 'B4', 'REST',
                    'C5', 'REST', 'REST', 'REST', 'G4', 'REST', 'REST', 'REST',
                    'Ab4', 'REST', 'Ab4', 'REST', 'G4', 'REST', 'G4', 'REST',
                    'Gb4', 'REST', 'Gb4', 'REST', 'F4', 'REST', 'F4', 'REST',
                    'E4', 'G4', 'B4', 'E5', 'Eb5', 'B4', 'G4', 'Eb4',
                    'E4', 'REST', 'REST', 'REST', 'REST', 'REST', 'REST', 'REST'
                ],
                bass: [
                    'E3', 'E3', 'E3', 'E3', 'Eb3', 'Eb3', 'Eb3', 'Eb3',
                    'D3', 'D3', 'D3', 'D3', 'Db3', 'Db3', 'Db3', 'Db3',
                    'C3', 'C3', 'C3', 'C3', 'C3', 'C3', 'C3', 'C3',
                    'C3', 'G3', 'C3', 'G3', 'C3', 'G3', 'C3', 'G3',
                    'Ab3', 'Ab3', 'Ab3', 'Ab3', 'G3', 'G3', 'G3', 'G3',
                    'Gb3', 'Gb3', 'Gb3', 'Gb3', 'F3', 'F3', 'F3', 'F3',
                    'E3', 'E3', 'E3', 'E3', 'E3', 'E3', 'E3', 'E3',
                    'E3', 'B3', 'E3', 'B3', 'E3', 'B3', 'E3', 'B3'
                ]
            },
            
            // üéâ VICTORY FANFARE - Triumphant, short jingle
            victory: {
                bpm: 160,
                loop: false,
                melody: [
                    'C5', 'REST', 'C5', 'REST', 'C5', 'REST', 'C5', 'REST',
                    'Ab4', 'REST', 'Bb4', 'REST', 'C5', 'REST', 'REST', 'Bb4',
                    'C5', 'REST', 'REST', 'REST', 'REST', 'REST', 'REST', 'REST',
                    'E5', 'REST', 'E5', 'REST', 'E5', 'REST', 'E5', 'REST',
                    'C5', 'REST', 'D5', 'REST', 'E5', 'REST', 'REST', 'D5',
                    'E5', 'REST', 'REST', 'REST', 'REST', 'REST', 'REST', 'REST',
                    'G5', 'REST', 'G5', 'REST', 'G5', 'G5', 'E5', 'C5',
                    'G5', 'REST', 'REST', 'REST', 'C6', 'REST', 'REST', 'REST'
                ],
                bass: [
                    'C4', 'G3', 'C4', 'G3', 'C4', 'G3', 'C4', 'G3',
                    'Ab3', 'Eb3', 'Bb3', 'F3', 'C4', 'G3', 'C4', 'G3',
                    'C4', 'REST', 'REST', 'REST', 'REST', 'REST', 'REST', 'REST',
                    'C4', 'G3', 'C4', 'G3', 'C4', 'G3', 'C4', 'G3',
                    'A3', 'E3', 'B3', 'G3', 'C4', 'G3', 'C4', 'G3',
                    'C4', 'REST', 'REST', 'REST', 'REST', 'REST', 'REST', 'REST',
                    'G3', 'D3', 'G3', 'D3', 'C4', 'G3', 'E4', 'C4',
                    'G4', 'REST', 'REST', 'REST', 'C4', 'REST', 'REST', 'REST'
                ]
            },
            
            // üíÄ GAME OVER - Sad, descending melody
            gameover: {
                bpm: 80,
                loop: false,
                melody: [
                    'E5', 'REST', 'REST', 'REST', 'D5', 'REST', 'REST', 'REST',
                    'C5', 'REST', 'REST', 'REST', 'B4', 'REST', 'REST', 'REST',
                    'A4', 'REST', 'REST', 'REST', 'G4', 'REST', 'REST', 'REST',
                    'F4', 'REST', 'REST', 'REST', 'E4', 'REST', 'REST', 'REST',
                    'D4', 'REST', 'E4', 'REST', 'C4', 'REST', 'REST', 'REST',
                    'REST', 'REST', 'REST', 'REST', 'REST', 'REST', 'REST', 'REST'
                ],
                bass: [
                    'A3', 'REST', 'E3', 'REST', 'G3', 'REST', 'D3', 'REST',
                    'F3', 'REST', 'C3', 'REST', 'E3', 'REST', 'B3', 'REST',
                    'A3', 'REST', 'E3', 'REST', 'G3', 'REST', 'D3', 'REST',
                    'F3', 'REST', 'C3', 'REST', 'E3', 'REST', 'B3', 'REST',
                    'D3', 'REST', 'E3', 'REST', 'C3', 'REST', 'REST', 'REST',
                    'REST', 'REST', 'REST', 'REST', 'REST', 'REST', 'REST', 'REST'
                ]
            }
        };
        
        // Play a track
        function playTrack(trackName) {
            if (!audioInitialized) initAudio();
            if (!audioCtx || !TRACKS[trackName]) return;
            
            stopTrack();
            currentTrack = trackName;
            isPlaying = true;
            
            const track = TRACKS[trackName];
            const noteDuration = 60 / track.bpm / 2; // 8th notes
            let noteIndex = 0;
            
            function playNextNotes() {
                if (!isPlaying || currentTrack !== trackName) return;
                
                const time = audioCtx.currentTime;
                
                // Play melody (square wave - classic NES lead)
                if (track.melody[noteIndex]) {
                    playNote(track.melody[noteIndex], noteDuration * 0.9, time, 'square', 0.25);
                }
                
                // Play bass (triangle wave - classic NES bass)
                if (track.bass[noteIndex]) {
                    playNote(track.bass[noteIndex], noteDuration * 0.9, time, 'triangle', 0.35);
                }
                
                noteIndex++;
                
                // Loop or stop
                if (noteIndex >= track.melody.length) {
                    if (track.loop === false) {
                        stopTrack();
                        return;
                    }
                    noteIndex = 0;
                }
            }
            
            // Start sequencer
            playNextNotes();
            sequencerInterval = setInterval(playNextNotes, noteDuration * 1000);
        }
        
        // Stop current track
        function stopTrack() {
            isPlaying = false;
            currentTrack = null;
            if (sequencerInterval) {
                clearInterval(sequencerInterval);
                sequencerInterval = null;
            }
        }
        
        // Music control functions for game states
        function playOverworldMusic() { playTrack('overworld'); }
        function playBattleMusic() { playTrack('battle'); }
        function playBossMusic() { playTrack('boss'); }
        function playVictoryMusic() { playTrack('victory'); }
        function playGameOverMusic() { playTrack('gameover'); }
        
        // Toggle music on/off
        let musicEnabled = true;
        function toggleMusic() {
            musicEnabled = !musicEnabled;
            if (!musicEnabled) {
                stopTrack();
            } else if (gameState === 'MAP') {
                playOverworldMusic();
            } else if (gameState === 'COMBAT') {
                playBattleMusic();
            }
            return musicEnabled;
        }
        
        // Toggle music button handler (also initializes audio on first click)
        function toggleMusicBtn() {
            initAudio(); // Initialize audio context on user interaction
            const enabled = toggleMusic();
            const btn = document.getElementById('music-btn');
            btn.innerText = enabled ? 'üéµ' : 'üîá';
            btn.setAttribute('data-tooltip', enabled ? 'Toggle Music (On)' : 'Toggle Music (Off)');
        }
        
        /* --- CONFIGURATION --- */
        const MAP_SIZE = 15;
        const WORLD_W = 12, WORLD_H = 12;

        const ASSETS = {
            player: 'üßô‚Äç‚ôÇÔ∏è', goblin: 'üë∫', ogre: 'üëπ', dragon: 'Dragon', dragonSprite: 'üêâ',
            harpy: 'ü¶Ö', castle: 'üè∞', tree: 'üå≤', mountain: '‚õ∞Ô∏è', water: 'üåä', grass: 'üü©', 
            road: 'üõ£Ô∏è', bridge: 'üåâ', house: 'üè†', store: 'üè™', campfire: 'üî•', watchtower: 'üóº',
            chest: 'üì¶'
        };

        const SPELL_DB = {
            'attack': { name: '‚öîÔ∏è Attack', cost: 0, desc: 'Basic', tooltip: 'Basic strike' },
            'fireball': { name: 'üî• Fireball', cost: 5, desc: 'High Dmg', tooltip: 'High damage fire spell' },
            'heal': { name: '‚ù§Ô∏è Heal', cost: 8, desc: '+30 HP', tooltip: 'Restore 30 HP' },
            'run': { name: 'üí® Run', cost: 0, desc: 'Escape', tooltip: 'Attempt to flee' },
            'lightning': { 
                name: '‚ö° Lightning', 
                cost: 5, 
                desc: 'High Dmg', 
                tooltip: 'Devastating lightning strike', 
                flavor: 'Channel the storm itself, ancient magic that splits the sky and reduces enemies to ash.\n\nüíô Cost: 5 MP | ‚öîÔ∏è Damage: 2.5√ó Attack' 
            },
            'iceball': { 
                name: '‚ùÑÔ∏è Iceball', 
                cost: 20, 
                desc: 'Freeze', 
                tooltip: 'Freeze enemy for 2 turns', 
                flavor: 'Summon the eternal frost: encase your foe in crystalline prison, buying precious time for victory.\n\nüíô Cost: 20 MP | ‚öîÔ∏è Damage: 1.5√ó Attack | ‚ùÑÔ∏è Freeze: 2 turns' 
            },
            'megaheal': { 
                name: 'üíñ Mega Heal', 
                cost: 15, 
                desc: 'Full HP', 
                tooltip: 'Fully restore HP', 
                flavor: 'Draw upon life magic itself, the ultimate restorative spell that mends even mortal wounds.\n\nüíô Cost: 15 MP | ‚ù§Ô∏è Heal: Full HP' 
            },
            'revealShops': {
                name: 'üè™ Reveal Shops',
                cost: 10,
                desc: 'Show Stores',
                tooltip: 'Shops glow through fog',
                flavor: 'Ancient merchant magic reveals the location of all trading posts in this region.\n\nüíô Cost: 10 MP | Reveals all shops through fog'
            },
            'revealCamps': {
                name: 'üî• Reveal Camps',
                cost: 20,
                desc: 'Show Campfires',
                tooltip: 'Campfires glow through fog',
                flavor: 'Sense the warmth of distant fires and reveal all campfire locations in this region.\n\nüíô Cost: 20 MP | Reveals all campfires through fog'
            },
            'revealDragon': {
                name: 'üêâ Reveal Dragon',
                cost: 50,
                desc: 'Find Dragon',
                tooltip: 'Show dragon on world map',
                flavor: 'Ancient scrying magic pinpoints the Dragon\'s lair on the world map.\n\nüíô Cost: 50 MP | Shows exact dragon location'
            },
            'revealCastle': {
                name: 'üè∞ Reveal Castle',
                cost: 50,
                desc: 'Find Castle',
                tooltip: 'Show castle on world map',
                flavor: 'Royal magic reveals the Princess\'s hidden sanctuary on the world map.\n\nüíô Cost: 50 MP | Shows exact castle location'
            },
            'revealChests': {
                name: 'üì¶ Reveal Chests',
                cost: 15,
                desc: 'Show Chests',
                tooltip: 'Chests glow through fog',
                flavor: 'Treasure-sensing magic reveals hidden chests in this region.\n\nüíô Cost: 15 MP | Reveals all chests through fog'
            },
            // NEW TACTICAL SPELLS
            'bleed': {
                name: 'ü©∏ Bleed',
                cost: 8,
                desc: 'Stop Regen',
                tooltip: 'Apply bleeding - prevents regen + DOT',
                flavor: 'Cursed wound magic that prevents healing and causes ongoing damage.\n\nüíô Cost: 8 MP | ‚öîÔ∏è Damage: 1√ó Attack | ü©∏ Bleed: 3 turns (stops regen, 5 dmg/turn)'
            },
            'cleanse': {
                name: 'üíö Cleanse',
                cost: 6,
                desc: 'Remove Debuff',
                tooltip: 'Remove poison and other debuffs',
                flavor: 'Purifying light washes away all ailments from your body.\n\nüíô Cost: 6 MP | üíö Removes: Poison, Curse, and other debuffs'
            },
            'shatter': {
                name: 'üî® Shatter',
                cost: 12,
                desc: 'Break Armor',
                tooltip: 'Ignores armor, bonus vs armored foes',
                flavor: 'Summon a devastating force that shatters even the toughest defenses.\n\nüíô Cost: 12 MP | ‚öîÔ∏è Damage: 2√ó Attack (ignores armor) | üí• Bonus: 50% extra vs armored'
            },
            'truestrike': {
                name: 'üéØ True Strike',
                cost: 10,
                desc: 'Never Miss',
                tooltip: 'Guaranteed hit, counters evasion',
                flavor: 'Channel absolute focus. Your strike finds its mark no matter what.\n\nüíô Cost: 10 MP | ‚öîÔ∏è Damage: 2√ó Attack | üéØ Cannot be evaded'
            },
            'slow': {
                name: 'üåÄ Slow',
                cost: 15,
                desc: 'Reduce Speed',
                tooltip: 'Prevents multi-attacks for 3 turns',
                flavor: 'Warp time around your foe, reducing them to a crawl.\n\nüíô Cost: 15 MP | ‚öîÔ∏è Damage: 1√ó Attack | üåÄ Slowed: 3 turns (prevents multi-attack)'
            },
            'drainlife': {
                name: 'üíÄ Drain Life',
                cost: 18,
                desc: 'Steal HP',
                tooltip: 'Deal damage and heal yourself',
                flavor: 'Dark magic that siphons the life essence from your enemy.\n\nüíô Cost: 18 MP | ‚öîÔ∏è Damage: 1.5√ó Attack | ‚ù§Ô∏è Heal: 50% of damage dealt'
            }

        };

        /* --- QUEST SYSTEM DATABASE --- */
        const QUEST_GIVERS = [
            { name: "Old Hermit Marcus", icon: "üë¥", personality: "cryptic and wise" },
            { name: "Merchant Gilda", icon: "üë©‚Äçü¶∞", personality: "shrewd but fair" },
            { name: "Farmer Tobias", icon: "üë®‚Äçüåæ", personality: "humble and hardworking" },
            { name: "Scholar Elwin", icon: "üßì", personality: "curious and bookish" },
            { name: "Widow Maren", icon: "üëµ", personality: "kind but sorrowful" },
            { name: "Hunter Kira", icon: "üßù‚Äç‚ôÄÔ∏è", personality: "brave and resourceful" },
            { name: "Blacksmith Durgan", icon: "üßî", personality: "gruff but honorable" },
            { name: "Healer Senna", icon: "üë©", personality: "gentle and compassionate" },
            { name: "Retired Knight Aldric", icon: "üßî‚Äç‚ôÇÔ∏è", personality: "proud and nostalgic" },
            { name: "Orphan Pip", icon: "üë¶", personality: "eager and hopeful" }
        ];

        const QUEST_TEMPLATES = {
            collect_wood: {
                type: 'collect',
                target: 'wood',
                amounts: [3, 5, 8],
                rewards: { gold: [30, 50, 80], xp: [20, 35, 50] },
                giverDialogues: [
                    "My roof leaks something terrible, and winter approaches. The Dragon's curse has made good timber scarce...",
                    "I'm building a shrine to honor those we've lost. Would you gather wood for me?",
                    "The children need a new school. The old one burned when the Dragon passed overhead last moon."
                ],
                journalEntries: [
                    "Met a villager in need of lumber. In these dark times, even simple construction materials are precious. The Dragon's shadow has touched every aspect of life here.",
                    "A humble request for wood. Though my quest is to slay the Dragon, helping these people reminds me why I fight.",
                    "Agreed to gather timber. The forests here are dense but dangerous, so I must stay vigilant while I work."
                ]
            },
            collect_fish: {
                type: 'collect',
                target: 'fish',
                amounts: [2, 4, 6],
                rewards: { gold: [25, 45, 70], xp: [15, 30, 45] },
                giverDialogues: [
                    "The fishing boats don't dare go out anymore, not since the Dragon started hunting over the waters...",
                    "My family hasn't had a proper meal in days. The markets are empty, friend.",
                    "I'm too old to fish myself now, but I remember when these waters teemed with life."
                ],
                journalEntries: [
                    "Promised to bring fish to a hungry family. The Dragon's terror has disrupted even the most basic needs of these people.",
                    "A simple request for food. I'll fish the nearby waters and hope the Dragon doesn't notice.",
                    "Agreed to help with fishing. Even heroes need to eat, and helping others along the way feels right."
                ]
            },
            collect_gold: {
                type: 'collect',
                target: 'gold',
                amounts: [50, 100, 200],
                rewards: { xp: [40, 70, 120] },
                giverDialogues: [
                    "The Dragon's minions demand tribute. If we don't pay, they'll burn what little we have left...",
                    "I need to buy medicine for my sick child, but I've nothing left to sell.",
                    "Bandits took everything. I hate to ask a stranger, but we're desperate."
                ],
                journalEntries: [
                    "These people need gold to survive. I'll gather what I can; monster slaying pays well enough.",
                    "Agreed to help with finances. Gold flows freely from defeated foes; I can spare some for those in need.",
                    "A request for coin. The economy here has collapsed under the Dragon's reign. I'll do what I can."
                ]
            },
            kill_monsters: {
                type: 'kill',
                targets: ['goblin', 'wolf', 'skeleton', 'orc', 'spider', 'slime'],
                amounts: [2, 3, 5],
                rewards: { gold: [40, 70, 120], xp: [30, 55, 90] },
                giverDialogues: [
                    "Those creatures have been terrorizing the roads. No merchant dares travel anymore.",
                    "My brother went to hunt them... he never came back. Will you avenge him?",
                    "The monsters grow bolder each day. Soon they'll be at our doorstep."
                ],
                journalEntries: [
                    "Accepted a bounty on local monsters. The Dragon's presence has emboldened all manner of dark creatures.",
                    "Promised to thin the monster population. Each beast I slay makes these lands a little safer.",
                    "A hunter's task. These creatures are symptoms of the greater evil, but removing symptoms still helps."
                ]
            },
            craft_item: {
                type: 'craft',
                targets: ['repairKit', 'smokeBomb', 'barricade', 'grilledFish'],
                amounts: [1, 2, 2],
                rewards: { gold: [35, 60, 90], xp: [25, 45, 70] },
                giverDialogues: [
                    "I've heard you're skilled with your hands. Could you craft something for me?",
                    "The old recipes are being forgotten. Show me you still know the craft of our ancestors.",
                    "I'd make it myself, but these old hands aren't what they used to be..."
                ],
                journalEntries: [
                    "A request to demonstrate the old crafts. I'll need to find a campfire and the right materials.",
                    "Promised to craft supplies. Knowledge of wilderness survival is as valuable as combat prowess.",
                    "Agreed to help with crafting. A campfire and some resources should do the trick."
                ]
            },
            buy_spell: {
                type: 'buyspell',
                targets: ['revealShops', 'revealCamps', 'revealChests'],
                rewards: { gold: [60, 80, 100], xp: [50, 70, 90] },
                giverDialogues: [
                    "There's a spell scroll I've always wanted to study... if you acquire it, I'll pay handsomely.",
                    "My grandmother spoke of reveal magic. Please, learn it and show me it's real!",
                    "The old magic is fading from this land. Prove to me it still exists."
                ],
                journalEntries: [
                    "A scholar seeks proof that reveal magic still works. I should visit a shop and purchase the scroll they desire.",
                    "Promised to acquire a spell scroll. The shops in this land sell various magical knowledge.",
                    "Agreed to learn a specific spell. This will require gold and a visit to a merchant."
                ]
            },
            find_castle: {
                type: 'findcastle',
                rewards: { gold: [150, 200, 250], xp: [100, 150, 200] },
                giverDialogues: [
                    "The Princess... she's alive, hidden somewhere. Find her sanctuary, and our hope is restored!",
                    "Legends speak of a secret castle where the royal family fled. Could you find it?",
                    "My son served in the Royal Guard. If the castle still stands, perhaps he lives..."
                ],
                journalEntries: [
                    "A desperate plea to find the hidden castle. The Princess represents hope for all these people. I can use the Reveal Castle spell or search tile by tile.",
                    "Agreed to locate the royal sanctuary. This aligns with my own quest, and the Princess may have answers.",
                    "Promised to find the secret castle. It's said to be hidden far from the Dragon's lair."
                ]
            }
        };

        const ITEM_DB = {
    'fish': { name: 'üêü Fish', type: 'hp', val: 10, desc: '+10 HP' },
    'potion': { name: 'üç∑ Health Potion', type: 'hp', val: 25, desc: '+25 HP' },
    'ether': { name: 'üíß Mana Potion', type: 'mp', val: 10, desc: '+10 MP' },
    'wood': { name: 'ü™µ Wood', type: 'mat', val: 0, desc: 'Sell for Gold' },
    // NEW CRAFTABLE ITEMS
    'repairKit': { name: 'üîß Repair Kit', type: 'hp', val: 50, desc: '+50 HP' },
    'manaSplinters': { name: '‚ú® Mana Splinters', type: 'mp', val: 15, desc: '+15 MP' },
    'smokeBomb': { name: 'üí® Smoke Bomb', type: 'special', val: 0, desc: 'Guaranteed escape' },
    'barricade': { name: 'üöß Barricade', type: 'special', val: 0, desc: 'Block next attack' },
    'woodenStakes': { name: 'üó°Ô∏è Wooden Stakes', type: 'special', val: 0, desc: '25 damage' },
      'woodenShield': { name: 'üî∞ Wooden Shield', type: 'equipment', val: 0, desc: '20% damage reduction', defense: 20 },
    'reinforcedStaff': { name: 'ü™Ñ Reinforced Staff', type: 'equipment', val: 0, desc: '+8 ATK', attack: 8 },
    'legacyShield': { name: 'üõ°Ô∏è Enchanted Wooden Shield', type: 'equipment', val: 0, desc: '40% damage reduction', defense: 40 },
'woodenSword': { name: 'üó°Ô∏è Wooden Sword', type: 'equipment', val: 0, desc: 'Basic starter weapon', attack: 5 },
    'bladeOfDawn': { name: '‚öîÔ∏è Blade of Dawn', type: 'equipment', val: 0, desc: 'The King\'s legendary sword', attack: 15 },
'grilledFish': { name: 'üçñ Grilled Fish', type: 'hp', val: 15, desc: '+15 HP' },
    'skeweredFish': { name: 'üç¢ Skewered Fish', type: 'mp', val: 15, desc: '+15 MP' },
    'leatherHelmet': { name: 'ü™ñ Leather Helmet', type: 'equipment', val: 0, desc: '+10 Max HP', maxHp: 10 },
    'stone': { name: 'ü™® Stone', type: 'throwable', val: 10, desc: 'Throw for 10 damage or collect 5 for helmet' },
    'rockHelmet': { name: '‚õëÔ∏è Rock Helmet', type: 'equipment', val: 0, desc: '+25 Max HP', maxHp: 25 }
};

        // Chest reward tables - weighted by rarity
        const CHEST_REWARDS = {
            common: [
                { type: 'gold', amount: [10, 25], weight: 30 },
                { type: 'item', item: 'potion', amount: [1, 2], weight: 25 },
                { type: 'item', item: 'ether', amount: [1, 2], weight: 20 },
                { type: 'item', item: 'wood', amount: [2, 5], weight: 15 },
                { type: 'item', item: 'fish', amount: [2, 4], weight: 10 }
            ],
            uncommon: [
                { type: 'gold', amount: [30, 60], weight: 25 },
                { type: 'item', item: 'repairKit', amount: [1, 1], weight: 20 },
                { type: 'item', item: 'manaSplinters', amount: [1, 2], weight: 20 },
                { type: 'item', item: 'smokeBomb', amount: [1, 2], weight: 15 },
                { type: 'item', item: 'barricade', amount: [1, 2], weight: 10 },
                { type: 'item', item: 'woodenStakes', amount: [1, 2], weight: 10 }
            ],
            rare: [
                { type: 'gold', amount: [75, 150], weight: 30 },
                { type: 'equipment', item: 'woodenShield', weight: 25 },
                { type: 'equipment', item: 'reinforcedStaff', weight: 25 },
                { type: 'multi', rewards: ['gold', 'potion'], weight: 20 }
            ]
        };


      const LORE_STRINGS = [
            "The Dragon wakes every century to burn the crops.",
            "My grandfather tried to fight the beast. He never returned.",
            "I saw a Goblin stealing my pie yesterday!",
            "If you cut down trees, you can clear a path!",
            "The King fled long ago. We are on our own now.",
            "Fishing is peaceful, but the waters are dangerous.",
            "The merchant buys Wood. It's good honest work.",
            "Why do all the trees look identical? Strange magic.",
            "I've heard the Dragon hates Ice magic.",
            "My cat keeps staring at the mountains. What does she see?",
            "Prices are rising at the store. Must be the economy.",
            "Don't eat the yellow snow. Just trust me.",
            "The roads used to be safe before the monsters came.",
            "I once caught a fish this big! I swear!",
            "Is it true? Can you really shoot lightning?",
            "My roof leaks every time it rains.",
            "We used to have a hero, but he retired to open a bakery.",
            "Watch out for Ogres, they hit harder than they look.",
            "Do you think the Dragon is lonely?",
            "I found a gold coin in the river once.",
            "The fog gets thicker every year.",
            "Have you seen the castle? It glows with evil energy.",
            "I'm saving up to move to a safer map.",
            "Potions taste like cherry syrup. I love them.",
            "Magic drains your energy. Use it wisely.",
            "I wish I had an axe like you.",
            "They say the world is just a grid. Nonsense!",
            "Be careful at the edge of the world.",
            
            // NEW FLAVOR TEXT
            "My son wants to be a wizard when he grows up. I told him to learn a trade instead.",
            "The baker down the road makes the best bread in three regions.",
            "I heard someone found a glowing mushroom in the forest. Kept it as a nightlight!",
            "My neighbor claims he saw a ghost, but I think he just drank too much.",
            "The well water tastes funny lately. Something's not right.",
            "I lost my favorite hat to a strong wind. Never saw it again.",
            "Do you believe in parallel worlds? Sometimes I feel like I'm living in one.",
            "The road workers never come this far out anymore.",
            "I tried to grow tomatoes once. The goblins ate them all.",
            "My wife makes the best stew. Come back sometime and try it!",
            "I've been living here for twenty years and I've never been bored. Well, maybe once.",
            "The mountains are beautiful at sunset. Almost makes you forget about the monsters.",
            "Someone should really organize these houses better. The layout is chaotic.",
            "I wonder what's beyond the fog. Probably more fog.",
            "My uncle was a cartographer. He mapped every tile in three kingdoms!",
            "The grass is always greener on the other side. Unless there's fog.",
            "I saw a shooting star last night. Made a wish for safer times.",
            "The old chapel bell hasn't rung in years. Nobody remembers why.",
            "Fishing is meditation for the soul, my father used to say.",
            "I keep hearing strange music at night. Beautiful, but haunting.",
            "The merchant's prices are outrageous but where else can you go?",
            "My daughter draws pictures of the Dragon. She's never even seen it!",
            "I planted a tree once. It grew into a door. Magic is weird.",
            "The postman never comes out this far. I haven't gotten mail in years.",
            "I found a book in my attic written in a language I don't recognize.",
            "The weather's been strange lately. Raining in some areas but not others.",
            "Do wizards ever retire? What do they do, open wizard schools?",
            "I heard there's a secret underground network of tunnels. Probably just rumors.",
            "My grandmother used to tell stories about the old kingdom. Golden days, she called them.",
            "The stars seem brighter here than in the city. Less torches, I suppose.",
            
            // LUMINOS HINTS
            "My grandmother spoke of ancient light magic that reveals all secrets. She said only true explorers could unlock it.",
            "They say if you explore every corner of a region, the land itself grants you mystical sight.",
            "I once met a wizard who could see through fog. He said he earned that power by walking every path.",
            
            // ENCHANTED SHIELD HINTS
            "Old woodcutters' tales speak of enchanted wood that reveals itself to those who need protection most.",
            "My father once carved a shield from a magical tree. The wood grain formed ancient protective runes!",
            "Be careful chopping trees near the Dragon's lair. The wood there is said to be... different.",
            
            // CRAFTING HINTS
            "You know, campfires aren't just for resting. A clever person could craft useful items from wood!",
            "I heard you can make all sorts of things at a campfire if you have enough wood.",
            "Wood is more valuable than you think. At a campfire, it can become tools, weapons, even magical trinkets!",
            "Smart adventurers use campfires to craft supplies. Saves a lot of gold at the shop!",
            
            // ROCK HELMET HINTS
            "The dwarves of old had a saying: 'Five stones from five peaks, and the mountain shall protect you.'",
            "My grandfather was a miner. He said the mountains hold ancient magic for those patient enough to gather their stones.",
            "I heard a traveler once cleared five mountain paths and found himself wearing a helm of solid rock! Can you imagine?",
            "The stones from cleared mountains aren't ordinary. Collect enough and something magical happens, they say.",
            
            // THE SHADOW HINT (extremely rare)
            "...*the old man looks around nervously*... They say the Dragon is not the true evil. There is something older, darker. A Shadow that lurks beyond mortal sight. Some say if one were to pierce every veil of fog across the entire world, to leave no corner unexplored... the Shadow itself would be forced to reveal itself. But that's just an old legend. No one could ever explore EVERYTHING... could they?"
        ];

const CRAFT_RECIPES = {
    items: [
        { id: 'woodenShield', name: 'üî∞ Wooden Shield', cost: 5, desc: '20% damage reduction' },
        { id: 'repairKit', name: 'üîß Repair Kit', cost: 3, desc: 'Restores 50 HP' },
        { id: 'manaSplinters', name: '‚ú® Mana Splinters', cost: 4, desc: 'Restores 15 MP' },
       { id: 'reinforcedStaff', name: 'ü™Ñ Reinforced Staff', cost: 10, desc: '+8 ATK permanently' },
        { id: 'smokeBomb', name: 'üí® Smoke Bomb', cost: 3, desc: 'Guaranteed escape' },
        { id: 'barricade', name: 'üöß Barricade', cost: 4, desc: 'Blocks next attack' },
        { id: 'woodenStakes', name: 'üó°Ô∏è Wooden Stakes', cost: 2, desc: '25 damage, no MP cost' }
    ],
    enhancements: [
        { id: 'upgradeCampfire', name: '‚ö° Upgrade Campfire', cost: 4, desc: '+20 MP when resting here' },
        { id: 'woodenTotem', name: 'üóø Wooden Totem', cost: 10, desc: '-50% encounters in this area' }
    ],
    cooking: [
        { id: 'grilledFish', name: 'üçñ Grilled Fish', fishCost: 1, woodCost: 0, desc: '+15 HP' },
        { id: 'skeweredFish', name: 'üç¢ Skewered Fish', fishCost: 1, woodCost: 1, desc: '+15 MP' }
    ]
};

const TERRAIN_RECIPES = [
    { id: 'clearPath', name: 'ü™ì Clear Path', cost: 3, desc: 'Convert mountain to grass' },
    { id: 'buildBridge', name: 'üåâ Build Bridge', cost: 5, desc: 'Convert water to walkable bridge' },
    { id: 'buildWatchtower', name: 'üóº Build Watchtower', cost: 8, desc: 'Reveal small fog area' }
];

let currentCampfireLocation = null;
let currentCampfireTile = null;
let craftMenuStates = { items: false, enhancements: false, cooking: false };
let terrainMenuExpanded = false;
let spellsMenuExpanded = false;
let itemsMenuExpanded = false;

        const CAMPFIRE_REFLECTIONS = [
            "You sit by the crackling flames, remembering your master's final words: 'Magic is not power, it is responsibility.' As warmth spreads through your weary bones, you wonder if you're truly ready for what lies ahead. But the people need hope, and you're all they have left.",
            
            "The fire dances before your eyes. You think back to the orphanage where you grew up, watching older wizards practice spells through the window. They said you'd never amount to anything. Now here you are, hunting a dragon. Funny how life works. Your wounds fade as the flames embrace you.",
            
            "Resting here, you recall the village elder's plea: 'Someone has to stand up to the beast.' You didn't ask to be a hero, but when you saw the fear in the children's eyes, you knew you couldn't walk away. The campfire's magic restores your strength. You'll need it.",
            
            "The flames whisper ancient secrets as you rest. Your grandmother used to say you had 'old magic' in your blood, passed down from the First Wizards. You never believed her until the day your powers awakened. Now, facing this dragon, you finally understand what she meant. You rise, fully healed.",
            
            "As the fire crackles, you think of all the lives destroyed by the Dragon's terror. Your best friend's farm, reduced to ash. The merchant who always gave you free bread, gone. This isn't about glory. It's about justice. The magical flames knit your wounds closed. Time to press on.",
            
            "You warm your hands by the fire, feeling its restorative magic flow through you. They called you foolish for leaving the safety of the Academy to hunt legends. But you've seen too much suffering to hide behind stone walls and dusty books. This dragon ends with you. Fully restored, you stand with renewed purpose.",
            
            "The campfire's glow reminds you of simpler times: evenings spent studying spell books by candlelight, dreaming of adventure. Well, you got your adventure. And it's far more terrifying than you imagined. But there's no turning back now. The fire heals your body and steadies your resolve.",
            
            "Sitting in silence, you think about the weight of the amulet you wear. The King's Light, entrusted to you by the Princess. Generations of heroes failed against this dragon. What makes you different? Perhaps nothing. Perhaps everything. The flames restore you completely. One way or another, you'll find out soon."
        ];
        
        const UPGRADED_CAMPFIRE_REFLECTIONS = [
            "The enchanted flames burn brighter than any natural fire, pulsing with the magic you wove into them. As mana flows back into your weary spirit, you marvel at how far you've come. The scared apprentice who left the Academy is becoming something more. Something the Dragon should fear.",
            
            "Your upgrades to this campfire have transformed it into a wellspring of power. The flames dance in patterns that match your heartbeat, restoring not just your body but your very essence. You remember your master saying, 'A wise wizard shapes the world to aid their journey.' You're finally becoming wise.",
            
            "The magical fire you enhanced crackles with grateful energy, as if thanking you for the gift of power. In return, it floods your body with warmth and your mind with clarity. For a moment, the weight of your quest feels lighter. You are not alone in this fight. Even the land itself rises to help you.",
            
            "Blue and gold flames spiral upward from the campfire you improved, weaving together like old friends reuniting. The magic seeps into your bones, mending what was broken, restoring what was spent. Your grandmother would smile to see this. 'Old magic helps those who help themselves,' she used to say.",
            
            "The enhanced campfire hums with stored power, releasing it gently into your tired form. As mana replenishes your spirit, you think about the villagers you've helped, the monsters you've slain, the distance you've traveled. Every step has led here, to this moment of rest before the final battle.",
            
            "Resting beside the fire you upgraded feels like coming home. The flames recognize your magical signature, burning warmer and brighter in your presence. For the first time in weeks, you allow yourself to hope. With power like this at your command, perhaps the Dragon isn't invincible after all."
        ];
        
        const DRAGON_QUOTES = [
            "You are but a gnat against the storm!",
            "The Void chose me as its champion!",
            "Your magic is a flickering candle in my darkness.",
            "I have seen empires crumble. You are nothing.",
            "My scales are forged from the ashes of heroes like you.",
            "Is that the best you can do, mortal?",
            "Burn in my eternal flame!",
            "Your world ends today!"
        ];

        /* --- STATE --- */
        let player = {};
        let worldMaps = {}; 
        let map = [];
        let gameState = 'START';
        let previousGameState = 'MAP';
        let currentEnemy = null;
        let combatTile = null; 
        let combatActive = false; 
        let worldX = 0, worldY = 2; 
        let bossLoc = { x: 0, y: 0 };
        let castleLoc = { x: 0, y: 0 };
        let onAlertClose = null; 
        let isInputBlocked = false; 
        let inputCooldown = false;
        
        let combatIdx = 0;
        let levelUpIdx = 0;
        let modalIdx = 0;
        let combatActionKeys = []; 
        let levelUpSpells = [];
        let modalButtons = [];
        let enemyFrozenTurns = 0; // Track freeze duration
        let enemyBleedingTurns = 0; // Track bleed duration
        let enemySlowedTurns = 0; // Track slow duration
        let playerPoisonTurns = 0; // Track poison on player
        let playerPoisonDamage = 0; // Track poison damage per turn

        /* --- INIT --- */
        function initGame(mode = 'RESET') {
            if (mode === 'NG+') {
                player.x = 7; player.y = 7;
                player.hp = player.maxHp;
                player.mp = player.maxMp;
            } else {
                player = { 
                    x: 7, y: 7, lvl: 1, 
                    hp: 110, maxHp: 110, 
                    mp: 20, maxMp: 20, 
                   xp: 0, nextXp: 100, atk: 10, gold: 0,
                    spells: ['attack', 'fireball', 'heal', 'run'],
         inventory: { fish: 0, potion: 0, ether: 0, wood: 0, repairKit: 0, manaSplinters: 0, smokeBomb: 0, barricade: 0, woodenStakes: 0, woodenShield: 0, reinforcedStaff: 0, legacyShield: 0, woodenSword: 0, bladeOfDawn: 0, grilledFish: 0, skeweredFish: 0, leatherHelmet: 0, stone: 0, rockHelmet: 0 },
equipment: { 
    weapon: { id: 'woodenSword', name: 'üó°Ô∏è Wooden Sword', attack: 5 }, 
    shield: null,
    helmet: { id: 'leatherHelmet', name: 'ü™ñ Leather Helmet', maxHp: 10 }
},
campfireUpgrades: {},
barricadeActive: false,
                    hasSword: false,
                    hasShield: false,
                    foundEnchantedShield: false,
                    foundRockHelmet: false,
                      hasLuminos: false,
                    revealedShops: {},
                    revealedCamps: {},
                    revealedChests: {},
                    revealedDragon: false,
                    revealedCastle: false,
                    // Quest system
                    quests: [], // Active quests
                    completedQuests: 0, // Total completed count
                    monstersKilled: {}, // Track monster kills for quests
                    craftedItems: {}, // Track crafted items for quests
                    noQuestHouses: [] // Houses confirmed to have no quest
                };
            }
            
            worldMaps = {}; 
            
            // First, randomly place the dragon
            bossLoc.x = Math.floor(Math.random() * WORLD_W);
            bossLoc.y = Math.floor(Math.random() * WORLD_H);
            
            // Then spawn player far from dragon (at least 8 tiles away)
            let validSpawn = false;
            while (!validSpawn) {
                worldX = Math.floor(Math.random() * WORLD_W);
                worldY = Math.floor(Math.random() * WORLD_H);
                
                // Calculate distance to dragon
                let distToDragon = Math.abs(worldX - bossLoc.x) + Math.abs(worldY - bossLoc.y);
                
                // Must be at least 8 tiles away from dragon
                if (distToDragon >= 8) {
                    validSpawn = true;
                }
            }

            // Generate castle location closer to the dragon's location
            const maxAttempts = 100;
            let bestCastleLoc = { x: 0, y: 0, distance: Infinity };
            
            for (let attempt = 0; attempt < maxAttempts; attempt++) {
                let cx = Math.floor(Math.random() * WORLD_W);
                let cy = Math.floor(Math.random() * WORLD_H);
                
               // Skip if same as starting or boss location
                if ((cx === worldX && cy === worldY) || (cx === bossLoc.x && cy === bossLoc.y)) continue;
                
                // Calculate distance to boss
                let distToBoss = Math.abs(cx - bossLoc.x) + Math.abs(cy - bossLoc.y);
                
                // Keep the castle location that's closest to the boss
                if (distToBoss < bestCastleLoc.distance) {
                    bestCastleLoc = { x: cx, y: cy, distance: distToBoss };
                }
            }
            
        castleLoc.x = bestCastleLoc.x;
            castleLoc.y = bestCastleLoc.y; 

            // Close any open overlays first
            document.getElementById('modal-screen').style.display = 'none';
            document.getElementById('combat-screen').style.display = 'none';
            document.getElementById('inventory-screen').style.display = 'none';
            document.getElementById('worldmap-screen').style.display = 'none';
            document.getElementById('house-screen').style.display = 'none';
            document.getElementById('campfire-screen').style.display = 'none';
            document.getElementById('levelup-screen').style.display = 'none';
            
            // Then set up the correct overlay based on gameState
            document.querySelectorAll('.overlay').forEach(el => {
                if (gameState === 'START' && el.id === 'start-screen') {
                    el.style.display = 'flex';
                } else {
                    el.style.display = 'none';
                }
            });
            
            if (gameState !== 'START') gameState = 'MAP';
            isInputBlocked = false;
            combatActive = false;
            loadScreen(0,0);
        }

        function showWelcomeScreen() {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('welcome-screen').style.display = 'flex';
            gameState = 'WELCOME';
        }

        function beginAdventure() {
            document.getElementById('welcome-screen').style.display = 'none';
            gameState = 'MAP';
            updateUI();
            // Initialize and start overworld music
            initAudio();
            if (musicEnabled) playOverworldMusic();
        }
        
        function beginQuest() {
            document.getElementById('start-screen').style.display = 'none';
            gameState = 'MAP';
            updateUI();
            // Initialize and start overworld music
            initAudio();
            if (musicEnabled) playOverworldMusic();
        }

        /* --- INPUT HANDLING (KEYBOARD) --- */
        window.addEventListener('keydown', (e) => {
            // Cheat code prompt: Ctrl+Shift+C or F9 opens cheat modal
            if ((e.ctrlKey && e.shiftKey && (e.key === 'C' || e.key === 'c')) || e.key === 'F9') {
                e.preventDefault();
                if (gameState === 'MAP') {
                    openCheatModal();
                }
                return;
            }
            
            // Cheat modal keyboard handling
            if (gameState === 'CHEAT') {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    submitCheatCode();
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    closeCheatModal();
                }
                return;
            }
            
            // Always prevent defaults for arrow keys
            if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].indexOf(e.code) > -1) {
                e.preventDefault();
            }
            
            if (inputCooldown) {
                e.preventDefault();
                e.stopPropagation();
                return;
            }
            if (isInputBlocked && gameState === 'COMBAT') {
                e.preventDefault();
                return;
            }

            if (gameState === 'LEVEL_UP') {
                if (levelUpSpells.length === 0) return;
                if (e.key === 'ArrowDown' || e.key === 's' || e.key === 'S') {
                    levelUpIdx = (levelUpIdx + 1) % levelUpSpells.length;
                    renderLevelUp();
                } else if (e.key === 'ArrowUp' || e.key === 'w' || e.key === 'W') {
                    levelUpIdx = (levelUpIdx - 1 + levelUpSpells.length) % levelUpSpells.length;
                    renderLevelUp();
                } else if (e.key === 'Enter') {
                    learnSpell(levelUpSpells[levelUpIdx]);
                }
                return;
            }

            if (gameState === 'START') {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    showWelcomeScreen();
                }
            }
            else if (gameState === 'WELCOME') {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    beginAdventure();
                }
            }
            else if (gameState === 'MAP') {
                switch(e.key) {
                    case 'ArrowUp': case 'w': case 'W': movePlayer(0, -1); break;
                    case 'ArrowDown': case 's': case 'S': movePlayer(0, 1); break;
                    case 'ArrowLeft': case 'a': case 'A': movePlayer(-1, 0); break;
                    case 'ArrowRight': case 'd': case 'D': movePlayer(1, 0); break;
                    case 'i': case 'I': openInventory(); break;
                    case 'm': case 'M': openWorldMap(); break;
                    case 'j': case 'J': openJournal(); break;
                }
            }
            else if (gameState === 'COMBAT') {
                if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') {
                    combatIdx = (combatIdx + 1) % combatActionKeys.length;
                    updateCombatUI(); 
                } else if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') {
                    combatIdx = (combatIdx - 1 + combatActionKeys.length) % combatActionKeys.length;
                    updateCombatUI();
                } else if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    combatAction(combatActionKeys[combatIdx]);
                }
            }
            else if (gameState === 'INV') {
                if (e.key === 'Escape') closeInventory();
            }
            else if (gameState === 'MSG') {
                if (e.key === 'Enter' || e.key === 'Escape' || e.key === ' ') {
                    e.preventDefault();
                    e.stopPropagation();
                    closeAlert();
                }
            }
            else if (gameState === 'HOUSE') {
                if (e.key === 'Escape') exitHouse();
                // Quest turn-in
                if (window.pendingQuestTurnIn) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        turnInQuestFromHouse(window.pendingQuestTurnIn);
                    }
                }
                // Quest offer navigation
                else if (window.pendingQuest) {
                    if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A' || e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') {
                        questOfferIdx = questOfferIdx === 0 ? 1 : 0;
                        renderQuestOfferButtons();
                    } else if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        if (questOfferIdx === 0) acceptQuest();
                        else declineQuest();
                    }
                }
                // No quest interaction - allow enter/space to exit
                else if (!window.houseHasInteraction) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        exitHouse();
                    }
                }
            }
            else if (gameState === 'WORLD_MAP') {
                if (e.key === 'Escape') closeWorldMap();
            }
else if (gameState === 'CAMPFIRE') {
                if (e.key === 'Escape') closeCampfireMenu();
            }
            else if (gameState === 'JOURNAL') {
                if (e.key === 'Escape') closeJournal();
            }
            else if (gameState === 'MANUAL') {
                if (e.key === 'Escape') closeManual();
            }
            else if (gameState === 'END') {
                if (modalButtons.length === 0) return;
                if (e.key === 'ArrowDown' || e.key === 's' || e.key === 'S') {
                    modalIdx = (modalIdx + 1) % modalButtons.length;
                    renderEndScreen();
                } else if (e.key === 'ArrowUp' || e.key === 'w' || e.key === 'W') {
                    modalIdx = (modalIdx - 1 + modalButtons.length) % modalButtons.length;
                    renderEndScreen();
                } else if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    modalButtons[modalIdx].action();
                }
            }
        });

        /* --- CLICK HANDLING --- */
        function onTileClick(target) {
            if (gameState !== 'MAP') return;
            const dist = Math.abs(player.x - target.x) + Math.abs(player.y - target.y);
            if (dist === 1) {
                if (target.type === 'tree') chopTree(target);
                else if (target.type === 'water') attemptFish(target);
                else if (target.type === 'chest') openChest(target);
            }
        }

        /* --- ALERT SYSTEM --- */
        function showAlert(msg, callback = null) {
            previousGameState = gameState;
            gameState = 'MSG';
            onAlertClose = callback;
            document.getElementById('msg-text').innerText = msg;
            document.getElementById('msg-screen').style.display = 'flex';
            document.getElementById('msg-ok-btn').focus();
        }

        function closeAlert() {
            document.getElementById('msg-screen').style.display = 'none';
            
            if (onAlertClose) {
                const cb = onAlertClose;
                onAlertClose = null;
                // Set cooldown BEFORE callback executes
                inputCooldown = true;
                cb(); 
                // Extended cooldown after callback completes
                setTimeout(() => inputCooldown = false, 500);
                // Don't restore previousGameState when callback exists
                // The callback handles state management
            } else {
                inputCooldown = true;
                setTimeout(() => inputCooldown = false, 300);
                if (player.hp <= 0 && gameState !== 'END') {
                    // Death handled elsewhere
                } else {
                    gameState = previousGameState;
                    if (gameState === 'COMBAT') updateCombatUI();
                    // If returning to INV, make sure inventory is visible
                    if (gameState === 'INV') {
                        document.getElementById('inventory-screen').style.display = 'flex';
                    }
                    // If returning to MAP, re-render to fix fog of war
                    if (gameState === 'MAP') {
                        renderMap();
                    }
                }
            }
        }

        /* --- WORLD SYSTEM --- */
        function loadScreen(dx, dy) {
            if (dx === 1) player.x = 0; else if (dx === -1) player.x = MAP_SIZE-1;
            else if (dy === 1) player.y = 0; else if (dy === -1) player.y = MAP_SIZE-1;
            
            const key = `${worldX},${worldY}`;

            if (worldMaps[key]) {
                map = worldMaps[key];
                let ent = getTile(player.x, player.y);
                if (ent && ['tree','mountain','water'].includes(ent.type)) {
                    ent.type = 'road'; 
                }
            } else {
                generateMapWithChecks();
                worldMaps[key] = map;
            }
            updateFog();
            renderMap();
            updateUI();
        }

        function switchScreen(dx, dy) {
            const nx = worldX + dx, ny = worldY + dy;
            if (nx < 0 || nx >= WORLD_W || ny < 0 || ny >= WORLD_H) return;
            worldMaps[`${worldX},${worldY}`] = map;
            worldX = nx; worldY = ny;
            loadScreen(dx, dy);
        }

        /* --- MAP GENERATION --- */
        function generateMapWithChecks() {
            for(let i=0; i<50; i++) {
                generateRawMap();
                if(checkConnectivity()) return;
            }
            map = map.map(t => ({...t, type: 'grass', entity: null}));
        }

        function generateRawMap() {
            map = [];
            const isBoss = (worldX === bossLoc.x && worldY === bossLoc.y);
            const isCastle = (worldX === castleLoc.x && worldY === castleLoc.y);
            const hasNorthExit = worldY > 0;
            const hasSouthExit = worldY < WORLD_H - 1;
            const hasWestExit = worldX > 0;
            const hasEastExit = worldX < WORLD_W - 1;
            
            let campfireSpawned = false; // Track if campfire already placed
            let chestCount = 0; // Track chest count (max 2 per map)

            for (let y = 0; y < MAP_SIZE; y++) {
                for (let x = 0; x < MAP_SIZE; x++) {
                    let type = 'grass';
                    let entity = null;
                    let meta = null;
                    let dialogue = null;

                    const isEdge = x===0 || x===MAP_SIZE-1 || y===0 || y===MAP_SIZE-1;
                    const isCorner = (x === 0 || x === MAP_SIZE-1) && (y === 0 || y === MAP_SIZE-1);
                    const isMidX = x>5 && x<9;
                    const isMidY = y>5 && y <9;

                    // Corners are always trees
                    if (isCorner) {
                        type = 'tree';
                    } else if (x === 0) type = (hasWestExit && isMidY) ? 'road' : 'tree';
                    else if (x === MAP_SIZE-1) type = (hasEastExit && isMidY) ? 'road' : 'tree';
                    else if (y === 0) type = (hasNorthExit && isMidX) ? 'road' : 'tree';
                    else if (y === MAP_SIZE-1) type = (hasSouthExit && isMidX) ? 'road' : 'tree';
                    else {
                        const rnd = Math.random();
                        if (rnd < 0.12) type = 'tree';
                        else if (rnd < 0.20) type = 'mountain';
                        else if (rnd < 0.25) type = 'water';
                        else if (rnd < 0.30) {
                            type = 'house';
                            // Check if adjacent tiles already have stores
                            const hasAdjacentStore = checkAdjacentStores(x, y);
                            if (Math.random() < 0.35 && !hasAdjacentStore) meta = 'store';
                            else {
                               meta = 'npc';
                                if (Math.random() < 0.08) dialogue = getCastleHint();
                                else if (Math.random() < 0.12) dialogue = getDragonHint();
                                else dialogue = LORE_STRINGS[Math.floor(Math.random() * LORE_STRINGS.length)];
                            }
                        }
                    }

                    // Campfire spawning (15% chance on grass, not on edges, only ONE per map)
if (type === 'grass' && !isEdge && !entity && !campfireSpawned && Math.random() < 0.15) {                        type = 'campfire';
                        campfireSpawned = true;
                    }

                    // Chest spawning (10% chance on grass, not on edges, max 2 per map)
                    if (type === 'grass' && !isEdge && !entity && chestCount < 2 && Math.random() < 0.10) {
                        type = 'chest';
                        // Determine chest rarity based on player level and randomness
                        const rarityRoll = Math.random();
                        if (rarityRoll < 0.60) meta = 'common';
                        else if (rarityRoll < 0.90) meta = 'uncommon';
                        else meta = 'rare';
                        chestCount++;
                    }

                    map.push({ x, y, type, entity, meta, dialogue, explored: false });
                }
            }
            setTile(player.x, player.y, { type: 'road', entity: null });
            if (isBoss) setTile(7, 7, { type: 'castle', entity: 'dragon' });
            if (isCastle && !player.hasSword) setTile(7, 7, { type: 'castle', entity: 'princess', meta: 'friendly' });
        }

        function getDragonHint() {
            let dx = bossLoc.x - worldX;
            let dy = bossLoc.y - worldY;
            if (dx === 0 && dy === 0) return "It's getting hot... The Dragon is on this very map! Check the Castle!";
            let dir = "";
            if (dy < 0) dir += "North";
            if (dy > 0) dir += "South";
            if (dx < 0) dir += "west";
            if (dx > 0) dir += "east";
            return `I hear the Dragon has made his home in the ${dir}.`;
        }

        function getCastleHint() {
            let dx = castleLoc.x - worldX;
            let dy = castleLoc.y - worldY;
            if (dx === 0 && dy === 0) {
                if (player.hasSword) return "The royal castle stood here once. Their legacy lives on in you.";
                return "There's a castle nearby! I've heard the royal family might still be hiding there.";
            }
            let dir = "";
            if (dy < 0) dir += "North";
            if (dy > 0) dir += "South";
            if (dx < 0) dir += "west";
            if (dx > 0) dir += "east";
            
            const hints = [
                `Rumor has it the King's family fled ${dir} to build a hidden sanctuary.`,
                `I've heard whispers of a royal castle ${dir} from here.`,
                `My cousin saw a castle with royal banners flying ${dir} of this region.`,
                `The Princess is said to be hiding ${dir}, waiting for a hero.`,
                `They say the old King's castle lies somewhere ${dir}.`
            ];
            return hints[Math.floor(Math.random() * hints.length)];
        }

        function checkAdjacentStores(x, y) {
            // Check all 8 adjacent tiles for stores
            const adjacents = [
                [-1, -1], [0, -1], [1, -1],
                [-1, 0],           [1, 0],
                [-1, 1],  [0, 1],  [1, 1]
            ];
            
            for (let [dx, dy] of adjacents) {
                const checkX = x + dx;
                const checkY = y + dy;
                if (checkX >= 0 && checkX < MAP_SIZE && checkY >= 0 && checkY < MAP_SIZE) {
                    const tile = getTile(checkX, checkY);
                    if (tile && tile.type === 'house' && tile.meta === 'store') {
                        return true;
                    }
                }
            }
            return false;
        }

        function checkConnectivity() {
            let visited = new Set([`${player.x},${player.y}`]);
            let queue = [`${player.x},${player.y}`];
            let targets = map.filter(t => t.type === 'road' || t.type === 'castle' || t.type === 'house').map(t=>`${t.x},${t.y}`);
            while (queue.length) {
                let [cx, cy] = queue.shift().split(',').map(Number);
                [[0,1],[0,-1],[1,0],[-1,0]].forEach(([dx, dy]) => {
                    let nx = cx+dx, ny = cy+dy;
                    let key = `${nx},${ny}`;
                    let t = getTile(nx, ny);
                    if (t && t.type !== 'mountain' && t.type !== 'water' && !visited.has(key)) {
                        visited.add(key);
                        queue.push(key);
                    }
                });
            }
            return targets.every(t => visited.has(t));
        }

        function movePlayer(dx, dy) {
            if (gameState !== 'MAP') return; 
            const nx = player.x + dx, ny = player.y + dy;
            const targetTile = getTile(nx, ny);
            const currentTile = getTile(player.x, player.y);

            if (!targetTile) { 
                if (currentTile.type === 'road') switchScreen(dx, dy); 
                else {
                    const grid = document.getElementById('grid');
                    grid.style.borderColor = '#c0392b';
                    setTimeout(() => grid.style.borderColor = '#34495e', 200);
                }
                return; 
            }

            if (targetTile.type === 'water') { attemptFish(targetTile); return; }
            if (targetTile.type === 'tree') { chopTree(targetTile); return; }
            if (targetTile.type === 'house') { 
                player.x = nx; player.y = ny;
                updateFog();
                renderMap();
                enterHouse(targetTile); 
                return; 
            }
            if (targetTile.type === 'campfire') { 
                player.x = nx; player.y = ny;
                updateFog();
                renderMap();
                restAtCampfire(targetTile); 
                return; 
            }
            if (targetTile.type === 'chest') { 
                player.x = nx; player.y = ny;
                updateFog();
                renderMap();
                openChest(targetTile); 
                return; 
            }
            
            // Castle with princess
            if (targetTile.type === 'castle' && targetTile.entity === 'princess') {
                player.x = nx; player.y = ny;
                updateFog();
                renderMap();
                player.foundCastleTile = true; // Track for quests
                enterCastle();
                return;
            }
            
            // COMBAT TRIGGER - update fog first so map is correct when combat ends
            if (targetTile.entity) { 
                player.x = nx; player.y = ny;
                updateFog();
                renderMap();
                startCombat(targetTile.entity, targetTile); 
                return; 
            }
            
            if (targetTile.type === 'castle') { endGame(true); return; }

            player.x = nx; player.y = ny;
            
            // Mountain encounter check (30% chance)
            if (targetTile.type === 'mountain') {
    const totemKey = `${worldX},${worldY}-woodenTotem`;
    const encounterChance = player.campfireUpgrades[totemKey] ? 0.15 : 0.30;
    if (Math.random() < encounterChance) { 
        // Mountain enemies: bats, harpies, gargoyles
        const mountainEnemies = ['bat', 'harpy', 'gargoyle'];
        const randomEnemy = mountainEnemies[Math.floor(Math.random() * mountainEnemies.length)];
        updateFog();
        renderMap();
        startCombat(randomEnemy, null); 
        return; 
    }
}

            // Bridge random encounter (15% chance - piranha attack!)
            if (targetTile.type === 'bridge') {
    const totemKey = `${worldX},${worldY}-woodenTotem`;
    const encounterChance = player.campfireUpgrades[totemKey] ? 0.075 : 0.15;
    if (Math.random() < encounterChance) { 
        updateFog();
        renderMap();
        startCombat('piranha', null); 
        return; 
    }
}
            
            // Grass random encounter (5% chance)
           if (targetTile.type !== 'road' && targetTile.type !== 'bridge' && targetTile.type !== 'mountain') {
    const totemKey = `${worldX},${worldY}-woodenTotem`;
    const encounterChance = player.campfireUpgrades[totemKey] ? 0.025 : 0.05;
    if (Math.random() < encounterChance) { 
        // Variety of enemies based on player level and location
        let enemyPool = ['rat', 'slime', 'snake', 'goblin', 'wolf', 'spider'];
        
        // Add tougher enemies at higher levels
        if (player.lvl >= 3) enemyPool.push('skeleton', 'ghost', 'orc');
        if (player.lvl >= 5) enemyPool.push('troll', 'demon', 'ogre');
        
        const randomEnemy = enemyPool[Math.floor(Math.random() * enemyPool.length)];
        updateFog();
        renderMap();
        startCombat(randomEnemy, null); 
        return; 
    }
}
            
            updateFog(); 
            checkFullyExplored();
            renderMap();
        }

        function chopTree(tile) {
            tile.type = 'grass';
            player.inventory.wood++;
            updateUI();
            renderMap();
            
            // Calculate shield drop chance based on proximity to dragon
            // Only drop if player has never found the enchanted shield
            let shieldChance = 0.005; // Base 0.5% chance (very rare)
            if (worldX === bossLoc.x && worldY === bossLoc.y) {
                shieldChance = 0.08; // 8% chance in dragon's area
            }
            
          // Very small chance to find enchanted shield (only once ever)
if (!player.foundEnchantedShield && Math.random() < shieldChance) {
    player.hasShield = true;
    player.foundEnchantedShield = true; // Mark as found permanently
    
    // Equip directly without adding to inventory (will be added when unequipped)
    player.equipment.shield = {
        id: 'legacyShield',
        name: 'üõ°Ô∏è Enchanted Wooden Shield',
        defense: 40
    };
    
    setTimeout(() => { 
        showAlert("üõ°Ô∏è ENCHANTED SHIELD FOUND!\n\nAs the tree falls, you notice the wood grain forms a perfect pattern. Ancient knowledge floods your mind: your grandfather's teachings about battle magic and protection wards!\n\nWith practiced hands, you carve arcane symbols into the wood. The shield pulses with protective energy as you bind it with spellwork.\n\n‚ú® Defense increased! You now take 40% less damage! ‚ú®"); 
    }, 50);
} else {
    setTimeout(() => { showAlert("You chopped down a tree! +1 Wood ü™µ"); }, 50);
}
        }

        function attemptFish(tile) {
            // Check if this water has already been fished
            if (tile.fished) {
                const grid = document.getElementById('grid');
                grid.style.borderColor = '#3498db';
                setTimeout(() => grid.style.borderColor = '#34495e', 200);
                showAlert("üé£ These waters have been fished out...\n\nNothing left to catch here.");
                return;
            }
            
            const roll = Math.random();
            if (roll < 0.40) {
                player.inventory.fish++;
                tile.fished = true; // Mark as fished
                updateUI();
                renderMap();
                showAlert("üé£ Caught a Fish!");
            } else if (roll < 0.55) {
                // 15% chance to find gold instead of fish
                player.gold += 5;
                tile.fished = true; // Mark as fished
                updateUI();
                renderMap();
                showAlert("‚ú® Found 5 Gold in the water!\n\nSomething shiny glints beneath the surface. Someone must have dropped their coin purse!");
            } else {
                const grid = document.getElementById('grid');
                grid.style.borderColor = '#3498db';
                setTimeout(() => grid.style.borderColor = '#34495e', 200);
            }
        }

        function restAtCampfire(tile) {
    currentCampfireLocation = `${tile.x},${tile.y}`;
    currentCampfireTile = tile; // Store tile reference
    gameState = 'CAMPFIRE';
    renderCampfireMenu();
    document.getElementById('campfire-screen').style.display = 'flex';
}

function restAtCampfireAndCraft() {
    // Check if already rested at this campfire
    if (currentCampfireTile && currentCampfireTile.rested) {
        showAlert("üî• You've already rested at this campfire.\n\nThe embers have cooled. Find another fire to rest at.");
        return;
    }
    
    const wasInjured = player.hp < player.maxHp;
    const wasPoisoned = playerPoisonTurns > 0;
    
    player.hp = player.maxHp;
    
    // Cleanse debuffs (poison, etc.) but not buffs
    playerPoisonTurns = 0;
    playerPoisonDamage = 0;
    
    // Mark campfire as rested
    if (currentCampfireTile) {
        currentCampfireTile.rested = true;
    }
    
    // Check for campfire upgrade
    const upgradeKey = `${currentCampfireLocation}-upgradeCampfire`;
    if (player.campfireUpgrades[upgradeKey]) {
        player.mp = Math.min(player.maxMp, player.mp + 20);
        const reflection = UPGRADED_CAMPFIRE_REFLECTIONS[Math.floor(Math.random() * UPGRADED_CAMPFIRE_REFLECTIONS.length)];
        const healMsg = wasInjured ? "\n\n‚ú® Fully healed! +20 MP restored! ‚ú®" : "\n\n‚ú® Refreshed! +20 MP restored! ‚ú®";
        const poisonMsg = wasPoisoned ? "üíö Poison cleansed!\n\n" : "";
        showAlert("üî• Enchanted Campfire\n\n" + poisonMsg + reflection + healMsg);
    } else {
        const reflection = CAMPFIRE_REFLECTIONS[Math.floor(Math.random() * CAMPFIRE_REFLECTIONS.length)];
        const healMsg = wasInjured ? "\n\n‚ú® Fully healed! ‚ú®" : "\n\n‚ú® Refreshed! ‚ú®";
        const poisonMsg = wasPoisoned ? "üíö Poison cleansed!\n\n" : "";
        showAlert("üî• Campfire\n\n" + poisonMsg + reflection + healMsg);
    }
    
    updateUI();
    renderMap();
    renderCampfireMenu(); // Re-render to update rest button state
}

function closeCampfireMenu() {
    document.getElementById('campfire-screen').style.display = 'none';
    
    // Reset craft menu states so they're collapsed next time
    craftMenuStates = { items: false, enhancements: false, cooking: false };
    
    // Collapse the menus visually
    document.getElementById('craft-items-menu').classList.remove('expanded');
    document.getElementById('craft-enhancements-menu').classList.remove('expanded');
document.getElementById('craft-cooking-menu').classList.remove('expanded');
    document.getElementById('items-arrow').innerText = '‚ñº';
    document.getElementById('enhancements-arrow').innerText = '‚ñº';
    document.getElementById('cooking-arrow').innerText = '‚ñº';
    
    currentCampfireLocation = null;
    currentCampfireTile = null;
    gameState = 'MAP';
    renderMap();
}

        /* --- CHEST SYSTEM --- */
        function openChest(tile) {
            const rarity = tile.meta || 'common';
            const rewardPool = CHEST_REWARDS[rarity];
            
            // Weighted random selection
            const totalWeight = rewardPool.reduce((sum, r) => sum + r.weight, 0);
            let roll = Math.random() * totalWeight;
            let selectedReward = rewardPool[0];
            
            for (const reward of rewardPool) {
                roll -= reward.weight;
                if (roll <= 0) {
                    selectedReward = reward;
                    break;
                }
            }
            
            // Generate reward message and apply rewards
            let message = '';
            const rarityEmoji = rarity === 'rare' ? '‚ú®' : rarity === 'uncommon' ? 'üéÅ' : 'üì¶';
            const rarityName = rarity.charAt(0).toUpperCase() + rarity.slice(1);
            
            if (selectedReward.type === 'gold') {
                const amount = randomInRange(selectedReward.amount[0], selectedReward.amount[1]);
                player.gold += amount;
                message = `${rarityEmoji} ${rarityName} Chest!\n\nüí∞ Found ${amount} Gold!`;
            } 
            else if (selectedReward.type === 'item') {
                const amount = randomInRange(selectedReward.amount[0], selectedReward.amount[1]);
                const itemData = ITEM_DB[selectedReward.item];
                player.inventory[selectedReward.item] += amount;
                message = `${rarityEmoji} ${rarityName} Chest!\n\n${itemData.name} x${amount}`;
            }
            else if (selectedReward.type === 'equipment') {
                const itemData = ITEM_DB[selectedReward.item];
                // Check if player already has this equipment
                if (player.inventory[selectedReward.item] > 0) {
                    // Convert to gold value instead
                    const goldValue = rarity === 'rare' ? 50 : 30;
                    player.gold += goldValue;
                    message = `${rarityEmoji} ${rarityName} Chest!\n\n${itemData.name} (Already owned)\nüí∞ Sold for ${goldValue} Gold!`;
                } else {
                    player.inventory[selectedReward.item] = 1;
                    message = `${rarityEmoji} ${rarityName} Chest!\n\n${itemData.name}\n${itemData.desc}`;
                }
            }
            else if (selectedReward.type === 'multi') {
                // Multi-reward: give gold + an item
                const goldAmount = randomInRange(25, 50);
                player.gold += goldAmount;
                player.inventory.potion += 1;
                const potionData = ITEM_DB['potion'];
                message = `${rarityEmoji} ${rarityName} Chest!\n\nüí∞ ${goldAmount} Gold\n${potionData.name} x1`;
            }
            
            // Remove the chest from the map (convert to grass)
            tile.type = 'grass';
            tile.meta = null;
            
            // Move player onto the tile
            player.x = tile.x;
            player.y = tile.y;
            
            showAlert(message);
            renderMap();
            updateUI();
        }
        
        function randomInRange(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        /* --- LUMINOS SPELL --- */
        function checkFullyExplored() {
            const key = `${worldX},${worldY}`;
            const allExplored = map.every(t => t.explored);
            
            if (allExplored && !player.hasLuminos) {
                player.hasLuminos = true;
                document.getElementById('luminos-btn').style.display = 'flex';
                setTimeout(() => {
                    showAlert("‚òÄÔ∏è LUMINOS LEARNED!\n\nAs you step into the final unexplored corner, brilliant sunlight breaks through the clouds! The entire region is bathed in golden radiance.\n\nAncient magic stirs within you. The land itself rewards your thorough exploration!\n\nYou've learned LUMINOS, a spell that reveals all secrets in an area.\n\n‚ú® Cost: 20 MP | Reveals entire map ‚ú®");
                }, 100);
            }
            
            // Check if entire world is explored (triggers The Shadow)
            if (checkWorldFullyExplored()) {
                setTimeout(() => triggerShadowBoss(), 500);
            }
        }

        // Check if entire world is explored (triggers The Shadow)
        function checkWorldFullyExplored() {
            if (player.shadowDefeated || player.shadowTriggered) return false;
            
            // Check all 144 world tiles (12x12)
            for (let y = 0; y < WORLD_H; y++) {
                for (let x = 0; x < WORLD_W; x++) {
                    const key = `${x},${y}`;
                    if (!worldMaps[key]) return false; // Map not visited
                    const tileMap = worldMaps[key];
                    if (!tileMap.every(t => t.explored)) return false; // Not all tiles explored
                }
            }
            return true;
        }
        
        function triggerShadowBoss() {
            if (player.shadowTriggered) return;
            player.shadowTriggered = true;
            
            showAlert("üë§ THE WORLD TREMBLES\n\nAs you reveal the final hidden corner of the world, the sky darkens. Stars wink out one by one. The temperature drops to freezing.\n\nA voice, ancient beyond comprehension, echoes across all of existence:\n\n'You... have seen too much. You have peeled back the veil that hides my realm from mortal eyes. For this transgression... there can be only one punishment.'\n\nThe darkness coalesces before you, taking form...", () => {
                startCombat('shadow', null);
            });
        }
        
        // Cheat modal functions
        let previousGameStateBeforeCheat = null;
        
        function openCheatModal() {
            previousGameStateBeforeCheat = gameState;
            gameState = 'CHEAT';
            document.getElementById('cheat-screen').style.display = 'flex';
            const input = document.getElementById('cheat-input');
            input.value = '';
            input.focus();
        }
        
        function closeCheatModal() {
            document.getElementById('cheat-screen').style.display = 'none';
            gameState = previousGameStateBeforeCheat || 'MAP';
            previousGameStateBeforeCheat = null;
        }
        
        function submitCheatCode() {
            const input = document.getElementById('cheat-input');
            const code = input.value.toLowerCase().trim();
            closeCheatModal();
            if (code) {
                handleCheatCode(code);
            }
        }
        
        // Cheat code handler
        function handleCheatCode(code) {
            if (code === 'idkfa') {
                // DOOM: All weapons/keys/ammo - triggers Dragon debug
                debugFightDragon();
            } else if (code === 'iddqd') {
                // DOOM: God mode - triggers Shadow debug
                debugRevealAll();
            } else {
                showAlert("Nothing happens...");
            }
        }
        
        // Debug function: Reveal all tiles (cheat: iddqd)
        function debugRevealAll() {
            // Give max stats
            player.hp = 9999;
            player.maxHp = 9999;
            player.mp = 9999;
            player.maxMp = 9999;
            player.atk = 9999;
            player.gold = 9999;
            player.lvl = 99;
            
            // Give Blade of Dawn and equip it
            player.hasSword = true;
            player.equipment.weapon = {
                id: 'bladeOfDawn',
                name: '‚öîÔ∏è Blade of Dawn',
                attack: 15
            };
            
            // Equip Enchanted Shield
            player.hasShield = true;
            player.foundEnchantedShield = true;
            player.equipment.shield = {
                id: 'legacyShield',
                name: 'üõ°Ô∏è Enchanted Wooden Shield',
                defense: 40
            };
            
            // Equip Rock Helmet
            player.hasRockHelmet = true;
            player.foundRockHelmet = true;
            player.equipment.helmet = {
                id: 'rockHelmet',
                name: '‚õëÔ∏è Rock Helmet',
                maxHp: 25
            };
            
            // Give all spells
            const allSpells = [
                'fireball', 'lightning', 'iceball', 'megaheal', 'heal',
                'bleed', 'cleanse', 'shatter', 'truestrike', 'slow', 'drainlife',
                'revealShops', 'revealCamps', 'revealChests', 'revealDragon', 'revealCastle'
            ];
            allSpells.forEach(spell => {
                if (!player.spells.includes(spell)) {
                    player.spells.push(spell);
                }
            });
            
            // Enable Luminos
            player.hasLuminos = true;
            document.getElementById('luminos-btn').style.display = 'flex';
            
            // Show all spell buttons
            document.getElementById('reveal-shops-btn').style.display = 'flex';
            document.getElementById('reveal-camps-btn').style.display = 'flex';
            document.getElementById('reveal-chests-btn').style.display = 'flex';
            document.getElementById('reveal-dragon-btn').style.display = 'flex';
            document.getElementById('reveal-castle-btn').style.display = 'flex';
            
            // Generate all world maps if they don't exist
            for (let y = 0; y < WORLD_H; y++) {
                for (let x = 0; x < WORLD_W; x++) {
                    const key = `${x},${y}`;
                    if (!worldMaps[key]) {
                        // Temporarily move to that location to generate the map
                        const oldX = worldX;
                        const oldY = worldY;
                        worldX = x;
                        worldY = y;
                        generateMapWithChecks();
                        worldMaps[key] = map;
                        worldX = oldX;
                        worldY = oldY;
                    }
                    // Reveal all tiles in this map
                    worldMaps[key].forEach(t => t.explored = true);
                }
            }
            // Reload current map
            map = worldMaps[`${worldX},${worldY}`];
            renderMap();
            updateUI();
            showAlert("üîì DEBUG MODE ACTIVATED!\n\n‚öîÔ∏è Blade of Dawn equipped!\nüõ°Ô∏è Enchanted Shield equipped!\n‚õëÔ∏è Rock Helmet equipped!\n‚ú® All spells learned!\nüìä All stats maxed!\nüó∫Ô∏è All tiles revealed!\n\nThe Shadow awaits...", () => {
                if (checkWorldFullyExplored()) {
                    triggerShadowBoss();
                }
            });
        }
        
        // Debug function: Max stats and fight Dragon (cheat: idkfa)
        function debugFightDragon() {
            // Give max stats
            player.hp = 9999;
            player.maxHp = 9999;
            player.mp = 9999;
            player.maxMp = 9999;
            player.atk = 9999;
            player.gold = 9999;
            player.lvl = 99;
            
            // Give Blade of Dawn and equip it
            player.hasSword = true;
            player.equipment.weapon = {
                id: 'bladeOfDawn',
                name: '‚öîÔ∏è Blade of Dawn',
                attack: 15
            };
            
            // Equip Enchanted Shield
            player.hasShield = true;
            player.foundEnchantedShield = true;
            player.equipment.shield = {
                id: 'legacyShield',
                name: 'üõ°Ô∏è Enchanted Wooden Shield',
                defense: 40
            };
            
            // Equip Rock Helmet
            player.hasRockHelmet = true;
            player.foundRockHelmet = true;
            player.equipment.helmet = {
                id: 'rockHelmet',
                name: '‚õëÔ∏è Rock Helmet',
                maxHp: 25
            };
            
            // Give all spells
            const allSpells = [
                'fireball', 'lightning', 'iceball', 'megaheal', 'heal',
                'bleed', 'cleanse', 'shatter', 'truestrike', 'slow', 'drainlife',
                'revealShops', 'revealCamps', 'revealChests', 'revealDragon', 'revealCastle'
            ];
            allSpells.forEach(spell => {
                if (!player.spells.includes(spell)) {
                    player.spells.push(spell);
                }
            });
            
            // Enable Luminos
            player.hasLuminos = true;
            document.getElementById('luminos-btn').style.display = 'flex';
            
            // Show all spell buttons
            document.getElementById('reveal-shops-btn').style.display = 'flex';
            document.getElementById('reveal-camps-btn').style.display = 'flex';
            document.getElementById('reveal-chests-btn').style.display = 'flex';
            document.getElementById('reveal-dragon-btn').style.display = 'flex';
            document.getElementById('reveal-castle-btn').style.display = 'flex';
            
            updateUI();
            showAlert("üîì DEBUG MODE ACTIVATED!\n\n‚öîÔ∏è Blade of Dawn equipped!\nüõ°Ô∏è Enchanted Shield equipped!\n‚õëÔ∏è Rock Helmet equipped!\n‚ú® All spells learned!\nüìä All stats maxed!\n\nüêâ The Dragon awaits...", () => {
                startCombat('dragon', null);
            });
        }

        function castLuminos() {
            if (gameState !== 'MAP') return;
            
            // Check if map is already fully explored
            const allExplored = map.every(t => t.explored);
            if (allExplored) {
                showAlert("‚òÄÔ∏è This area is already fully revealed!");
                return;
            }
            
            if (player.mp < 20) {
                showAlert("Not enough MP! Need 20 MP to cast Luminos.");
                return;
            }
            
            player.mp -= 20;
            // Reveal entire map
            map.forEach(t => t.explored = true);
            updateUI();
            renderMap();
            showAlert("‚òÄÔ∏è LUMINOS!\n\nRadiant light floods the region! All secrets are revealed!");
        }
function castRevealShops() {
            if (gameState !== 'MAP') return;
            if (player.mp < 10) {
                showAlert("Not enough MP! Need 10 MP to cast Reveal Shops.");
                return;
            }
            
            // Check if there's a shop on this map
            const shopTiles = map.filter(t => t.type === 'house' && t.meta === 'store');
            
            if (shopTiles.length === 0) {
                showAlert("üè™ No shops detected in this region!");
                return;
            }
            
            // Check if all shops are already explored
            const allShopsExplored = shopTiles.every(t => t.explored);
            if (allShopsExplored) {
                showAlert("üè™ All shops in this region are already visible!");
                return;
            }
            
            // Check if already revealed in this location
            const locationKey = `${worldX},${worldY}`;
            if (player.revealedShops[locationKey]) {
                showAlert("üè™ All shops in this region are already revealed!");
                return;
            }
            
            player.mp -= 10;
            player.revealedShops[locationKey] = true;
            renderMap();
            updateUI();
            showAlert("üè™ REVEAL SHOPS!\n\nMerchant magic pulses through you! All shops in this region now glow through the fog!");
        }
       function castRevealCamps() {
            if (gameState !== 'MAP') return;
            if (player.mp < 20) {
                showAlert("Not enough MP! Need 20 MP to cast Reveal Camps.");
                return;
            }
            
            // Check if there's a campfire on this map
            const campfireTile = map.find(t => t.type === 'campfire');
            
            if (!campfireTile) {
                showAlert("üî• No campfire detected in this region!");
                return;
            }
            
            // Check if campfire is already explored
            if (campfireTile.explored) {
                showAlert("üî• The campfire in this region is already visible!");
                return;
            }
            
            // Check if already revealed in this location
            const locationKey = `${worldX},${worldY}`;
            if (player.revealedCamps[locationKey]) {
                showAlert("üî• The campfire in this region is already revealed!");
                return;
            }
            
            player.mp -= 20;
            player.revealedCamps[locationKey] = true;
            renderMap();
            updateUI();
            showAlert("üî• REVEAL CAMPS!\n\nYou sense the warmth of a distant fire! The campfire in this region now glows through the fog!");
        }

      function castRevealDragon() {
            if (gameState !== 'MAP') return;
            if (player.mp < 50) {
                showAlert("Not enough MP! Need 50 MP to cast Reveal Dragon.");
                return;
            }
            
            player.mp -= 50;
            player.revealedDragon = true;
            updateUI();
            
            // Show alert first, THEN open map
            showAlert("üêâ REVEAL DRAGON!\n\nAncient scrying magic shows you the Dragon's lair! The location glows on your map!", () => {
                gameState = 'MAP'; // Explicitly set to MAP before opening world map
                openWorldMap();
            });
        }

        function castRevealCastle() {
            if (gameState !== 'MAP') return;
            if (player.mp < 50) {
                showAlert("Not enough MP! Need 50 MP to cast Reveal Castle.");
                return;
            }
            
            player.mp -= 50;
            player.revealedCastle = true;
            updateUI();
            
            // Show alert first, THEN open map
            showAlert("üè∞ REVEAL CASTLE!\n\nRoyal magic reveals the Princess's sanctuary! The location glows on your map!", () => {
                gameState = 'MAP'; // Explicitly set to MAP before opening world map
                openWorldMap();
            });
        }

        function castRevealChests() {
            if (gameState !== 'MAP') return;
            if (player.mp < 15) {
                showAlert("Not enough MP! Need 15 MP to cast Reveal Chests.");
                return;
            }
            
            // Check if there are any chests on this map
            const chestTiles = map.filter(t => t.type === 'chest');
            
            if (chestTiles.length === 0) {
                showAlert("üì¶ No chests detected in this region!");
                return;
            }
            
            // Check if all chests are already explored
            const allChestsExplored = chestTiles.every(t => t.explored);
            if (allChestsExplored) {
                showAlert("üì¶ All chests in this region are already visible!");
                return;
            }
            
            // Check if already revealed in this location
            const locationKey = `${worldX},${worldY}`;
            if (player.revealedChests[locationKey]) {
                showAlert("üì¶ All chests in this region are already revealed!");
                return;
            }
            
            player.mp -= 15;
            player.revealedChests[locationKey] = true;
            renderMap();
            updateUI();
            showAlert("üì¶ REVEAL CHESTS!\n\nTreasure-sensing magic pulses through you! All chests in this region now glow through the fog!");
        }
        /* --- HOUSE & STORE --- */
        function enterHouse(tile) {
            gameState = 'HOUSE';
            window.pendingQuestTurnIn = null; // Reset
            window.houseHasInteraction = false; // Track if house has quest/store
            document.getElementById('house-screen').style.display = 'flex';
            const text = document.getElementById('npc-dialogue');
            const store = document.getElementById('store-area');
            const icon = document.getElementById('house-icon');
            const title = document.getElementById('house-title');
            
            if (tile.meta === 'store') {
                icon.innerText = ASSETS.store;
                title.innerText = "Mystic Emporium";
                text.innerText = "\"Potions, provisions, and a few... arcane secrets. I deal in goods and knowledge alike, traveler.\"";
                store.style.display = 'block';
                window.houseHasInteraction = true;
                renderStoreUI();
            } else {
                icon.innerText = ASSETS.house;
                title.innerText = "Villager's Home";
                
                // Check for quest turn-in first
                const completedQuest = checkQuestTurnIn(tile);
                if (completedQuest) {
                    window.pendingQuestTurnIn = completedQuest.id;
                    window.houseHasInteraction = true;
                    const rewardGold = completedQuest.rewardGold || 0;
                    const rewardXp = completedQuest.rewardXp || 0;
                    // Show turn-in dialog
                    text.innerHTML = `
                        <div style="text-align: left;">
                            <p><b>${completedQuest.giver.icon} ${completedQuest.giver.name}</b></p>
                            <p style="margin: 15px 0; font-style: italic; color: #27ae60;">"You've done it! I knew I could count on you, hero!"</p>
                        </div>
                    `;
                    document.getElementById('store-content').innerHTML = `
                        <div style="text-align: center; margin-top: 20px;">
                            <p style="color: #f1c40f;">üìú Quest Complete: ${completedQuest.title}</p>
                            <p style="color: #27ae60; margin: 10px 0;">üéÅ Reward: ${rewardGold} Gold, ${rewardXp} XP</p>
                            <button id="claim-reward-btn" onclick="turnInQuestFromHouse(${completedQuest.id})" style="background: #27ae60; padding: 10px 20px; font-size: 1rem; box-shadow: 0 0 10px #27ae60;">Claim Reward</button>
                        </div>
                    `;
                    store.style.display = 'block';
                    return;
                }
                
                // Check if this house already has an active quest from player (not turned in)
                const houseKey = `${worldX},${worldY}-${tile.x},${tile.y}`;
                const existingQuest = player.quests.find(q => q.houseKey === houseKey && !q.turnedIn);
                if (existingQuest) {
                    window.houseHasInteraction = true;
                    const progress = getQuestProgress(existingQuest);
                    const targetAmount = existingQuest.targetAmount || 1;
                    const progressText = (existingQuest.type === 'buyspell' || existingQuest.type === 'findcastle')
                        ? (isQuestComplete(existingQuest) ? 'Complete!' : 'In Progress')
                        : `${progress}/${targetAmount}`;
                    
                    text.innerHTML = `
                        <div style="text-align: left;">
                            <p><b>${existingQuest.giver.icon} ${existingQuest.giver.name}</b></p>
                            <p style="margin: 15px 0; font-style: italic; color: #f1c40f;">"How goes the task, friend? I'm counting on you!"</p>
                            <hr style="border-color: #555; margin: 15px 0;">
                            <p>üìú <b>${existingQuest.title}</b></p>
                            <p style="color: #e67e22;">Progress: ${progressText}</p>
                        </div>
                    `;
                    store.style.display = 'none';
                    return;
                }
                
                // Try to generate a new quest (or use existing pending quest)
                // Check if this house was already visited and confirmed to have no quest
                if (!player.noQuestHouses) player.noQuestHouses = [];
                if (player.noQuestHouses.includes(houseKey)) {
                    // No quest available at this house - show normal dialogue
                    text.innerText = `"${tile.dialogue}"`;
                    store.style.display = 'none';
                    return;
                }
                
                const quest = tile.pendingQuest || generateQuest(tile);
                if (quest) {
                    tile.pendingQuest = quest; // Store on tile so it persists
                    offerQuest(tile, quest);
                    return;
                }
                
                // No quest generated - mark this house as having no quest permanently
                player.noQuestHouses.push(houseKey);
                
                // No quest - show normal dialogue
                text.innerText = `"${tile.dialogue}"`;
                store.style.display = 'none';
            }
        }

        function turnInQuestFromHouse(questId) {
            const quest = player.quests.find(q => q.id == questId);
            if (!quest) return;
            
            const rewardGold = quest.rewardGold || 0;
            const rewardXp = quest.rewardXp || 0;
            
            // Deduct collected items
            if (quest.type === 'collect' && quest.target !== 'gold') {
                player.inventory[quest.target] -= quest.targetAmount;
            } else if (quest.type === 'collect' && quest.target === 'gold') {
                player.gold -= quest.targetAmount;
            }
            
            // Give rewards
            player.gold += rewardGold;
            player.completedQuests++;
            
            // Mark quest as turned in (not removed)
            quest.turnedIn = true;
            
            exitHouse();
            updateUI();
            
            // Give XP after closing (may trigger level up)
            // Use callback that restores MAP state after XP is granted
            showAlert(`üìú Quest Complete!\n\n"${quest.title}"\n\nüí∞ +${rewardGold} Gold\nüåü +${rewardXp} XP`, () => {
                gainXp(rewardXp);
                gameState = 'MAP'; // Ensure we're back to MAP state
            });
        }

        function renderStoreUI() {
            const container = document.getElementById('store-content');
            
            // Build spell scrolls section
            let spellScrollsHTML = '';
            
            // Reveal Shops - 100 gold
            if (!player.spells.includes('revealShops')) {
                spellScrollsHTML += `
                    <div class="store-item">
                        <span>üè™ Reveal Shops Scroll</span>
                        <span style="color: #95a5a6; font-size: 0.85rem;">Shows stores through fog</span>
                        <span class="cost-text">100 Gold</span>
                        <button onclick="buySpell('revealShops', 100)">Buy</button>
                    </div>`;
            }
            
            // Reveal Camps - 150 gold
            if (!player.spells.includes('revealCamps')) {
                spellScrollsHTML += `
                    <div class="store-item">
                        <span>üî• Reveal Camps Scroll</span>
                        <span style="color: #95a5a6; font-size: 0.85rem;">Shows campfires through fog</span>
                        <span class="cost-text">150 Gold</span>
                        <button onclick="buySpell('revealCamps', 150)">Buy</button>
                    </div>`;
            }
            
            // Reveal Chests - 200 gold
            if (!player.spells.includes('revealChests')) {
                spellScrollsHTML += `
                    <div class="store-item">
                        <span>üì¶ Reveal Chests Scroll</span>
                        <span style="color: #95a5a6; font-size: 0.85rem;">Shows chests through fog</span>
                        <span class="cost-text">200 Gold</span>
                        <button onclick="buySpell('revealChests', 200)">Buy</button>
                    </div>`;
            }
            
            // Reveal Dragon - 500 gold
            if (!player.spells.includes('revealDragon')) {
                spellScrollsHTML += `
                    <div class="store-item">
                        <span>üêâ Reveal Dragon Scroll</span>
                        <span style="color: #95a5a6; font-size: 0.85rem;">Shows dragon on world map</span>
                        <span class="cost-text">500 Gold</span>
                        <button onclick="buySpell('revealDragon', 500)">Buy</button>
                    </div>`;
            }
            
            // Reveal Castle - 500 gold
            if (!player.spells.includes('revealCastle')) {
                spellScrollsHTML += `
                    <div class="store-item">
                        <span>üè∞ Reveal Castle Scroll</span>
                        <span style="color: #95a5a6; font-size: 0.85rem;">Shows castle on world map</span>
                        <span class="cost-text">500 Gold</span>
                        <button onclick="buySpell('revealCastle', 500)">Buy</button>
                    </div>`;
            }
            
            // If all spells purchased, show a message
            if (spellScrollsHTML === '') {
                spellScrollsHTML = `<div style="color: #95a5a6; padding: 10px; text-align: center;">You've learned all my arcane secrets!</div>`;
            }
            
            container.innerHTML = `
                <div class="section-header">üìú Spell Scrolls</div>
                <div class="store-grid">
                    ${spellScrollsHTML}
                </div>
                <div class="section-header">Buy Items</div>
                <div class="store-grid">
                    <div class="store-item">
                        <span>üç∑ Health Potion (+25HP)</span>
                        <span style="color: #95a5a6; font-size: 0.85rem;">You have: ${player.inventory.potion}</span>
                        <span class="cost-text">50 Gold</span>
                        <button onclick="buyItem('potion', 50)">Buy</button>
                    </div>
                    <div class="store-item">
                        <span>üíß Mana Potion (+10MP)</span>
                        <span style="color: #95a5a6; font-size: 0.85rem;">You have: ${player.inventory.ether}</span>
                        <span class="cost-text">40 Gold</span>
                        <button onclick="buyItem('ether', 40)">Buy</button>
                    </div>
                </div>
                <div class="section-header">Sell Items</div>
                <div class="store-grid">
                    ${player.inventory.wood > 0 ? `<div class="store-item">
                        <span>ü™µ Wood (Have: ${player.inventory.wood})</span>
                        <span class="sell-text">Sell: 10 Gold each</span>
                        <button onclick="sellItem('wood', 10)">Sell One</button>
                    </div>` : ''}
                    ${player.inventory.fish > 0 ? `<div class="store-item">
                        <span>üêü Fish (Have: ${player.inventory.fish})</span>
                        <span class="sell-text">Sell: 5 Gold each</span>
                        <button onclick="sellItem('fish', 5)">Sell One</button>
                    </div>` : ''}
                    ${player.inventory.stone > 0 ? `<div class="store-item">
                        <span>ü™® Stone (Have: ${player.inventory.stone})</span>
                        <span class="sell-text">Sell: 8 Gold each</span>
                        <button onclick="sellItem('stone', 8)">Sell One</button>
                    </div>` : ''}
                    ${player.inventory.potion > 0 ? `<div class="store-item">
                        <span>üç∑ Health Potion (Have: ${player.inventory.potion})</span>
                        <span class="sell-text">Sell: 25 Gold each</span>
                        <button onclick="sellItem('potion', 25)">Sell One</button>
                    </div>` : ''}
                    ${player.inventory.ether > 0 ? `<div class="store-item">
                        <span>üíß Mana Potion (Have: ${player.inventory.ether})</span>
                        <span class="sell-text">Sell: 20 Gold each</span>
                        <button onclick="sellItem('ether', 20)">Sell One</button>
                    </div>` : ''}
                    ${player.inventory.woodenShield > 0 ? `<div class="store-item">
                        <span>üî∞ Wooden Shield (Have: ${player.inventory.woodenShield})</span>
                        <span class="sell-text">Sell: 15 Gold each</span>
                        <button onclick="sellItem('woodenShield', 15)">Sell One</button>
                    </div>` : ''}
                    ${player.inventory.reinforcedStaff > 0 ? `<div class="store-item">
                        <span>ü™Ñ Reinforced Staff (Have: ${player.inventory.reinforcedStaff})</span>
                        <span class="sell-text">Sell: 30 Gold each</span>
                        <button onclick="sellItem('reinforcedStaff', 30)">Sell One</button>
                    </div>` : ''}
                    ${player.inventory.woodenSword > 0 ? `<div class="store-item">
                        <span>üó°Ô∏è Wooden Sword (Have: ${player.inventory.woodenSword})</span>
                        <span class="sell-text">Sell: 10 Gold each</span>
                        <button onclick="sellItem('woodenSword', 10)">Sell One</button>
                    </div>` : ''}
                    ${player.inventory.leatherHelmet > 0 ? `<div class="store-item">
                        <span>ü™ñ Leather Helmet (Have: ${player.inventory.leatherHelmet})</span>
                        <span class="sell-text">Sell: 15 Gold each</span>
                        <button onclick="sellItem('leatherHelmet', 15)">Sell One</button>
                    </div>` : ''}
                    ${player.inventory.rockHelmet > 0 ? `<div class="store-item">
                        <span>‚õëÔ∏è Rock Helmet (Have: ${player.inventory.rockHelmet})</span>
                        <span class="sell-text">Sell: 50 Gold each</span>
                        <button onclick="sellItem('rockHelmet', 50)">Sell One</button>
                    </div>` : ''}
                    ${player.inventory.grilledFish > 0 ? `<div class="store-item">
                        <span>üçñ Grilled Fish (Have: ${player.inventory.grilledFish})</span>
                        <span class="sell-text">Sell: 20 Gold each</span>
                        <button onclick="sellItem('grilledFish', 20)">Sell One</button>
                    </div>` : ''}
                    ${player.inventory.skeweredFish > 0 ? `<div class="store-item">
                        <span>üç¢ Skewered Fish (Have: ${player.inventory.skeweredFish})</span>
                        <span class="sell-text">Sell: 25 Gold each</span>
                        <button onclick="sellItem('skeweredFish', 25)">Sell One</button>
                    </div>` : ''}
                    ${Object.values(player.inventory).every(v => v === 0) ? `<div style="color: #95a5a6; padding: 10px; text-align: center;">You have nothing to sell.</div>` : ''}
                </div>
            `;
        }

        function buyItem(key, cost) {
            if (player.gold >= cost) {
                player.gold -= cost;
                player.inventory[key]++;
                showAlert(`Bought ${ITEM_DB[key].name}!`);
                updateUI();
                renderStoreUI();
            } else showAlert("Not enough Gold!");
        }

        function buySpell(spellKey, cost) {
            if (player.gold >= cost) {
                player.gold -= cost;
                player.spells.push(spellKey);
                const spellData = SPELL_DB[spellKey];
                showAlert(`üìú Learned ${spellData.name}!\n\n${spellData.flavor || spellData.tooltip}`);
                updateUI();
                renderStoreUI();
            } else {
                showAlert("Not enough Gold!");
            }
        }

       

        function sellItem(key, price) {
            if (player.inventory[key] > 0) {
                player.inventory[key]--;
                player.gold += price;
                updateUI();
                renderStoreUI();
                showAlert(`Sold ${ITEM_DB[key].name} for ${price} Gold!`);
            } else {
                showAlert(`You have no ${ITEM_DB[key].name} to sell!`);
            }
        }

        function exitHouse() {
            document.getElementById('house-screen').style.display = 'none';
            gameState = 'MAP';
            renderMap();
        }

        /* --- CASTLE SYSTEM --- */
        function enterCastle() {
            gameState = 'HOUSE';
            document.getElementById('house-screen').style.display = 'flex';
            const text = document.getElementById('npc-dialogue');
            const store = document.getElementById('store-area');
            const icon = document.getElementById('house-icon');
            const title = document.getElementById('house-title');
            
            icon.innerText = 'üè∞';
            title.innerText = "The Royal Castle";
            store.style.display = 'none';
            
            // Check if player already has the sword (revisiting)
            if (player.hasSword) {
                const revisitDialogues = [
                    `<div style="text-align: left; line-height: 1.6;">
                        <p><b>Princess Elara smiles warmly at your return...</b></p>
                        <p>"You've come back, brave one. The Blade of Dawn suits you well, I can see it in the way you carry yourself now. My father would be proud to see his sword in such capable hands."</p>
                        <p>"The Dragon still lurks in its lair, spreading darkness across the land. Every day its shadow grows longer. But when I look at you, I feel something I haven't felt in years: hope."</p>
                        <p style="color: #9b59b6; font-style: italic;">"Go now, hero. End this nightmare. And when the beast falls... return to me. We have a kingdom to rebuild together."</p>
                    </div>`,
                    `<div style="text-align: left; line-height: 1.6;">
                        <p><b>Princess Elara looks up from an ancient tome...</b></p>
                        <p>"Ah, you've returned! I've been researching the old texts, searching for anything that might aid you. Did you know the Blade of Dawn was forged during the First Age, when magic was raw and wild?"</p>
                        <p>"They say it was tempered in dragonfire itself, which is why it can pierce even the thickest scales. My father believed the sword chose its wielder, not the other way around."</p>
                        <p style="color: #9b59b6; font-style: italic;">"It chose you, wizard. Trust in that. Trust in yourself."</p>
                    </div>`,
                    `<div style="text-align: left; line-height: 1.6;">
                        <p><b>Princess Elara stands by the window, gazing at the distant mountains...</b></p>
                        <p>"I dream of my father sometimes. He stands before the Dragon, sword raised, fearless to the end. I used to wonder if his sacrifice was in vain."</p>
                        <p>"But then you arrived. Carrying the same courage, the same fire in your eyes. Perhaps his spirit guided you here. Perhaps fate has finally decided to smile upon Vibe."</p>
                        <p style="color: #9b59b6; font-style: italic;">"Whatever happens, know this: you have already given us something precious. You have given us hope."</p>
                    </div>`
                ];
                text.innerHTML = revisitDialogues[Math.floor(Math.random() * revisitDialogues.length)];
                return;
            }
            
            text.innerHTML = `
                <div style="text-align: left; line-height: 1.6;">
                    <p><b>Princess Elara approaches you gracefully...</b></p>
                    <p>"Brave wizard, you have found our hidden sanctuary! Long ago, when the Dragon first awoke from its slumber, 
                    our kingdom fell into darkness. My father, the King, led a battalion of our finest knights to face the beast, 
                    but none returned from that cursed fortress."</p>
                    <p>"We fled here and built this castle in secret, far from the Dragon's burning gaze. For years we have lived 
                    in shadow, hoping that one day a hero would arise."</p>
                    <p style="color: #f39c12;"><b>"Please, take this: the Blade of Dawn, my father's sword. 
                    It is said to cut through the darkest evil. May it serve you well in the battle ahead. 
                    You are our last hope to reclaim our kingdom!"</b></p>
                    <p style="font-size: 1.3rem; text-align: center; margin-top: 10px;">‚öîÔ∏è <b>Attack Power +15!</b> ‚öîÔ∏è</p>
                </div>
            `;
            
            player.hasSword = true;
            
            // Unequip current weapon if any
            if (player.equipment.weapon) {
                player.inventory[player.equipment.weapon.id]++;
                player.atk -= player.equipment.weapon.attack;
            }
            
            // Equip Blade of Dawn (no inventory needed since it's equipped immediately)
            player.equipment.weapon = {
                id: 'bladeOfDawn',
                name: '‚öîÔ∏è Blade of Dawn',
                attack: 15
            };
            player.atk += 15;
            
            updateUI();
        }

        /* --- INVENTORY SYSTEM --- */
       function openInventory() {
    if (gameState === 'START' || gameState === 'WELCOME' || (isInputBlocked && gameState==='COMBAT')) return;
    
    // Hide other overlay screens if open, but preserve their previousGameState
    if (gameState === 'WORLD_MAP') {
        document.getElementById('worldmap-screen').style.display = 'none';
    } else if (gameState === 'JOURNAL') {
        document.getElementById('journal-screen').style.display = 'none';
    } else if (gameState === 'MANUAL') {
        document.getElementById('manual-screen').style.display = 'none';
    } else if (gameState !== 'INV') {
        previousGameState = gameState;
    }
    
    gameState = 'INV';
    
    // Render equipment, terrain menu, spells menu, and items menu
    renderEquipment();
    renderTerrainMenu();
    renderSpellsMenu();
    renderItemsMenu();
    
    document.getElementById('inventory-screen').style.display = 'flex';
}

        function closeInventory() {
            document.getElementById('inventory-screen').style.display = 'none';
            
            // Reset terrain menu state so it's collapsed next time
            terrainMenuExpanded = false;
            document.getElementById('terrain-menu').classList.remove('expanded');
            document.getElementById('terrain-arrow').innerText = '‚ñº';
            
            // Reset spells menu state so it's collapsed next time
            spellsMenuExpanded = false;
            document.getElementById('spells-menu').classList.remove('expanded');
            document.getElementById('spells-arrow').innerText = '‚ñº';
            
            // Reset items menu state so it's collapsed next time
            itemsMenuExpanded = false;
            document.getElementById('items-menu').classList.remove('expanded');
            document.getElementById('items-menu-arrow').innerText = '‚ñº';
            
            gameState = previousGameState;
            if (gameState === 'COMBAT') {
                combatIdx = 0; // Reset combat selection
                isInputBlocked = false; // Ensure input is not blocked
                updateCombatUI();
            } else if (gameState === 'MAP') {
                renderMap();
            }
        }

       function useItem(key) {
    const data = ITEM_DB[key];
    if (data.type === 'mat' || data.type === 'equipment') return;
    
    // Handle special combat items (should only be called during combat now)
    if (data.type === 'special') {
        if (key === 'smokeBomb') {
            player.inventory[key]--;
            closeInventory();
            showAlert("üí® Smoke Bomb! You escaped!", () => {
                endCombat(false);
            });
            return;
        }
        
        if (key === 'barricade') {
            player.inventory[key]--;
            player.barricadeActive = true;
            closeInventory();
            updateCombatUI("üöß Barricade set! Next attack blocked.");
            setTimeout(() => { 
                enemyTurn(); 
            }, 800);
            return;
        }
        
        if (key === 'woodenStakes') {
            player.inventory[key]--;
            currentEnemy.hp -= 25;
            closeInventory();
            updateCombatUI("üó°Ô∏è Wooden Stakes deal 25 damage!");
            if (currentEnemy.hp <= 0) {
                combatActive = false;
                setTimeout(() => victory(), 500);
            } else {
                isInputBlocked = true;
                setTimeout(() => { 
                    enemyTurn(); 
                    isInputBlocked = false;
                }, 800);
            }
            return;
        }
    }
    
    // Handle consumables (HP/MP)
    if (data.type === 'hp') {
        if (player.hp >= player.maxHp) { 
            closeInventory();
            showAlert("HP already full!"); 
            return; 
        }
        player.hp = Math.min(player.maxHp, player.hp + data.val);
    } else if (data.type === 'mp') {
        if (player.mp >= player.maxMp) { 
            closeInventory();
            showAlert("MP already full!"); 
            return; 
        }
        player.mp = Math.min(player.maxMp, player.mp + data.val);
    }
    
    player.inventory[key]--;
    updateUI();
    
    if (previousGameState === 'COMBAT') {
        closeInventory();
        updateCombatUI(`Used ${data.name}.`);
        
        // Check if combat is still active and enemy is alive
        if (combatActive && currentEnemy.hp > 0) {
            isInputBlocked = true;
            setTimeout(() => { 
                enemyTurn(); 
                isInputBlocked = false; 
            }, 800);
        }
    } else {
        openInventory(); 
    }
}

function throwItem(key) {
    const data = ITEM_DB[key];
    if (!data || data.type !== 'throwable') return;
    if (previousGameState !== 'COMBAT') return;
    
    player.inventory[key]--;
    const damage = data.val || 10;
    currentEnemy.hp -= damage;
    
    closeInventory();
    updateCombatUI(`ü™® Threw ${data.name} for ${damage} damage!`);
    
    // Check for victory
    if (currentEnemy.hp <= 0) {
        combatActive = false;
        setTimeout(() => victory(), 500);
        return;
    }
    
    // Enemy turn
    if (combatActive && currentEnemy.hp > 0) {
        isInputBlocked = true;
        setTimeout(() => { 
            enemyTurn(); 
            isInputBlocked = false; 
        }, 800);
    }
}
        /* --- WORLD MAP SYSTEM --- */
      function openWorldMap() {
            if (gameState === 'START' || gameState === 'WELCOME' || gameState === 'COMBAT') return;
            
            // Hide other overlay screens if open, but preserve their previousGameState
            if (gameState === 'INV') {
                document.getElementById('inventory-screen').style.display = 'none';
                // Reset inventory menu states
                terrainMenuExpanded = false;
                document.getElementById('terrain-menu').classList.remove('expanded');
                document.getElementById('terrain-arrow').innerText = '‚ñº';
                spellsMenuExpanded = false;
                document.getElementById('spells-menu').classList.remove('expanded');
                document.getElementById('spells-arrow').innerText = '‚ñº';
                itemsMenuExpanded = false;
                document.getElementById('items-menu').classList.remove('expanded');
                document.getElementById('items-menu-arrow').innerText = '‚ñº';
            } else if (gameState === 'JOURNAL') {
                document.getElementById('journal-screen').style.display = 'none';
            } else if (gameState === 'MANUAL') {
                document.getElementById('manual-screen').style.display = 'none';
            } else if (gameState !== 'WORLD_MAP') {
                previousGameState = gameState;
            }
            
            gameState = 'WORLD_MAP';
            
            // Generate X-axis labels (0-11 across the top)
            const xLabels = document.getElementById('wmap-x-labels');
            xLabels.innerHTML = '';
            for (let x = 0; x < WORLD_W; x++) {
                const label = document.createElement('div');
                label.className = 'wmap-label';
                label.textContent = x;
                xLabels.appendChild(label);
            }
            
            // Generate Y-axis labels (0-11 down the side)
            const yLabels = document.getElementById('wmap-y-labels');
            yLabels.innerHTML = '';
            for (let y = 0; y < WORLD_H; y++) {
                const label = document.createElement('div');
                label.className = 'wmap-label';
                label.textContent = y;
                yLabels.appendChild(label);
            }
            
            const grid = document.getElementById('world-map-grid');
            grid.innerHTML = '';
            
            for(let y=0; y<WORLD_H; y++) {
                for(let x=0; x<WORLD_W; x++) {
                    const key = `${x},${y}`;
                    const cell = document.createElement('div');
                    cell.className = 'wmap-cell';
                    
                    // Highlight dragon location if revealed
                    if (player.revealedDragon && x === bossLoc.x && y === bossLoc.y) {
                        cell.style.backgroundColor = '#e74c3c';
                        cell.style.boxShadow = '0 0 20px rgba(231, 76, 60, 0.8)';
                        cell.innerHTML = '<div style="font-size: 1.5rem;">üêâ</div>';
                    }
                    
                    // Highlight castle location if revealed
                    if (player.revealedCastle && x === castleLoc.x && y === castleLoc.y) {
                        cell.style.backgroundColor = '#9b59b6';
                        cell.style.boxShadow = '0 0 20px rgba(155, 89, 182, 0.8)';
                        cell.innerHTML = '<div style="font-size: 1.5rem;">üè∞</div>';
                    }
                    
                    if (worldMaps[key]) {
                        cell.classList.add('visited');
                        const m = worldMaps[key];
                        if (m[7] && m[7].type === 'road') cell.innerHTML += '<div class="road-ind road-n"></div>';
                        if (m[217] && m[217].type === 'road') cell.innerHTML += '<div class="road-ind road-s"></div>';
                        if (m[105] && m[105].type === 'road') cell.innerHTML += '<div class="road-ind road-w"></div>';
                        if (m[119] && m[119].type === 'road') cell.innerHTML += '<div class="road-ind road-e"></div>';
                        
                        // Check for active quests in this map tile (not turned in)
                        const hasQuest = player.quests && player.quests.some(q => q.worldX === x && q.worldY === y && !q.turnedIn);
                        if (hasQuest) {
                            cell.classList.add('has-quest');
                            cell.innerHTML += '<div style="position: absolute; top: -2px; right: -2px; font-size: 0.6rem;">üìú</div>';
                        }
                    }
                    if (x === worldX && y === worldY) cell.classList.add('current');
                    grid.appendChild(cell);
                }
            }
            document.getElementById('worldmap-screen').style.display = 'flex';
        }

        function closeWorldMap() {
            document.getElementById('worldmap-screen').style.display = 'none';
            gameState = previousGameState;
            if (gameState === 'COMBAT') updateCombatUI();
            else if (gameState === 'MAP') renderMap();
        }

        /* --- COMBAT --- */
        function startCombat(type, tileRef) {
            if (combatActive) return; // Prevention
            gameState = 'COMBAT';
            combatIdx = 0;
            isInputBlocked = false;
            combatActive = true;
            combatTile = tileRef; // SAVE TILE REFERENCE
            enemyFrozenTurns = 0; // Reset freeze counter
            enemyBleedingTurns = 0; // Reset bleed counter
            enemySlowedTurns = 0; // Reset slow counter
            playerPoisonTurns = 0; // Reset player poison
            playerPoisonDamage = 0;
            
            // Start battle music (boss music for dragon/shadow)
            if (musicEnabled) {
                if (type === 'dragon' || type === 'shadow') {
                    playBossMusic();
                } else {
                    playBattleMusic();
                }
            }

            // Enemy database with stats and behaviors
            const enemyDB = {
                rat: { name: 'Giant Rat', hp: 20, atk: 6, xp: 15, gold: 8, sprite: 'üêÄ', behavior: null },
                slime: { name: 'Slime', hp: 25, atk: 5, xp: 12, gold: 10, sprite: 'üíß', behavior: 'regenerating' },
                bat: { name: 'Cave Bat', hp: 18, atk: 7, xp: 16, gold: 7, sprite: 'ü¶á', behavior: 'evasive' },
                snake: { name: 'Viper', hp: 22, atk: 8, xp: 18, gold: 12, sprite: 'üêç', behavior: 'poisonous' },
                goblin: { name: 'Goblin', hp: 30, atk: 8, xp: 20, gold: 15, sprite: 'üë∫', behavior: 'enraged' },
                wolf: { name: 'Wolf', hp: 35, atk: 10, xp: 25, gold: 10, sprite: 'üê∫', behavior: 'multiattack' },
                spider: { name: 'Giant Spider', hp: 25, atk: 7, xp: 18, gold: 12, sprite: 'üï∑Ô∏è', behavior: 'poisonous' },
                skeleton: { name: 'Skeleton', hp: 40, atk: 11, xp: 30, gold: 20, sprite: 'üíÄ', behavior: 'armored' },
                ghost: { name: 'Ghost', hp: 38, atk: 9, xp: 28, gold: 18, sprite: 'üëª', behavior: 'evasive' },
                orc: { name: 'Orc', hp: 50, atk: 12, xp: 35, gold: 25, sprite: 'üßå', behavior: 'enraged' },
                gargoyle: { name: 'Gargoyle', hp: 55, atk: 13, xp: 40, gold: 30, sprite: 'üóø', behavior: 'armored' },
                troll: { name: 'Troll', hp: 70, atk: 15, xp: 50, gold: 40, sprite: 'üë∫', behavior: 'regenerating' },
                demon: { name: 'Demon', hp: 80, atk: 18, xp: 60, gold: 50, sprite: 'üòà', behavior: 'multiattack' },
                harpy: { name: 'Mountain Harpy', hp: 50, atk: 9, xp: 35, gold: 25, sprite: 'ü¶Ö', behavior: 'evasive' },
                ogre: { name: 'Ogre', hp: 80, atk: 12, xp: 50, gold: 40, sprite: 'üëπ', behavior: 'armored' },
                piranha: { name: 'Piranha Swarm', hp: 28, atk: 9, xp: 20, gold: 15, sprite: 'üêü', behavior: 'multiattack' },
                dragon: { name: 'Dragon', hp: 500, atk: 40, xp: 1000, gold: 500, sprite: 'üêâ', behavior: 'boss' },
                shadow: { name: 'The Shadow', hp: 1000, atk: 80, xp: 5000, gold: 0, sprite: 'üë§', behavior: 'shadow' }
            };

            // Get enemy from database or default to goblin
            let s = enemyDB[type] || enemyDB.goblin;
            s = {...s}; // Clone to avoid modifying the database
            
            s.hp += (player.lvl*5); 
            s.max = s.hp; 
            s.atk += player.lvl;
            s.baseAtk = s.atk; // Store base attack for enraged calculation
            currentEnemy = {...s};

            document.getElementById('combat-screen').style.display = 'flex';
            document.getElementById('enemy-avatar').innerText = currentEnemy.sprite;
            document.getElementById('enemy-name').innerText = currentEnemy.name;
            updateCombatUI("Encounter started!");
            
            // Show behavior-specific encounter messages
            if (currentEnemy.name === 'Dragon') {
                showAlert("üê≤ DRAGON: 'Ah, a challenger? I've been waiting for a snack!'");
            } else if (currentEnemy.name === 'The Shadow') {
                showAlert("üë§ THE SHADOW\n\n*A voice echoes from everywhere and nowhere*\n\n'So... you have pierced every veil. You have uncovered every secret. You thought the Dragon was your enemy? The Dragon was merely my puppet, my instrument of chaos.\n\nI am The Shadow. I have existed since before time had a name. I AM the darkness between stars, the fear in mortal hearts, the void that hungers eternal.\n\nYou should not have sought me out, little wizard. Now you will join the endless dark...'");
            } else if (currentEnemy.behavior) {
                const behaviorMessages = {
                    'regenerating': `üíö ${currentEnemy.name} pulses with regenerative energy! It will heal each turn unless you stop it with ü©∏ Bleed.`,
                    'evasive': `üí® ${currentEnemy.name} moves with unnatural speed! It may dodge your attacks. Use üéØ True Strike for guaranteed hits!`,
                    'poisonous': `‚ò†Ô∏è ${currentEnemy.name} drips with venom! Its attacks may poison you. Have üíö Cleanse ready!`,
                    'armored': `üõ°Ô∏è ${currentEnemy.name}'s hide is like iron! Normal attacks deal reduced damage. Use üî® Shatter to break through!`,
                    'multiattack': `‚ö° ${currentEnemy.name} is incredibly swift! It may attack twice per turn. Use üåÄ Slow to prevent this!`,
                    'enraged': `üò° ${currentEnemy.name} has a berserker's fury! It will deal more damage when wounded!`
                };
                if (behaviorMessages[currentEnemy.behavior]) {
                    showAlert(behaviorMessages[currentEnemy.behavior]);
                }
            } else if (currentEnemy.name === 'Mountain Harpy') {
                showAlert("ü¶Ö A fierce Harpy swoops down from the peaks!");
            } else if (['Giant Rat', 'Slime', 'Cave Bat'].includes(currentEnemy.name)) {
                // Weak enemy flavor text
                const weakMessages = [
                    `A ${currentEnemy.name} appears!`,
                    `${currentEnemy.name} blocks your path!`,
                    `Watch out! ${currentEnemy.name} attacks!`
                ];
                showAlert(weakMessages[Math.floor(Math.random() * weakMessages.length)]);
            }
        }

        function updateCombatUI(msg) {
            if (!currentEnemy) return; // Safety check
            
            document.getElementById('enemy-hp-bar').innerText = `HP: ${currentEnemy.hp}/${currentEnemy.max}`;
            if (msg) document.getElementById('combat-log').innerText = msg;
            
            // Build status text for enemy
            let statusParts = [];
            if (enemyFrozenTurns > 0) statusParts.push(`‚ùÑÔ∏è Frozen(${enemyFrozenTurns})`);
            if (enemyBleedingTurns > 0) statusParts.push(`ü©∏ Bleeding(${enemyBleedingTurns})`);
            if (enemySlowedTurns > 0) statusParts.push(`üåÄ Slowed(${enemySlowedTurns})`);
            if (currentEnemy.behavior === 'armored') statusParts.push('üõ°Ô∏è Armored');
            if (currentEnemy.behavior === 'evasive') statusParts.push('üí® Evasive');
            if (currentEnemy.behavior === 'regenerating' && enemyBleedingTurns === 0) statusParts.push('üíö Regen');
            if (currentEnemy.behavior === 'poisonous') statusParts.push('‚ò†Ô∏è Venomous');
            if (currentEnemy.behavior === 'multiattack' && enemySlowedTurns === 0) statusParts.push('‚ö° Swift');
            if (currentEnemy.behavior === 'enraged' && currentEnemy.hp < currentEnemy.max * 0.3) statusParts.push('üò° ENRAGED!');
            
            const status = document.getElementById('enemy-status');
            status.innerHTML = statusParts.join(' ');
            
            // Visual effects for status
            const avatar = document.getElementById('enemy-avatar');
            avatar.className = 'combat-avatar';
            if (enemyFrozenTurns > 0) avatar.classList.add('frozen');
            if (currentEnemy.behavior === 'enraged' && currentEnemy.hp < currentEnemy.max * 0.3) {
                avatar.style.filter = 'hue-rotate(-30deg) saturate(2)';
            } else if (enemyFrozenTurns === 0) {
                avatar.style.filter = '';
            }

            updateUI();
            
            const bar = document.getElementById('combat-actions');
            bar.innerHTML = '';
            
            combatActionKeys = [];
            combatActionKeys.push('attack');
            player.spells.forEach(s => {
                // Exclude reveal spells from combat
                const revealSpells = ['revealShops', 'revealCamps', 'revealChests', 'revealDragon', 'revealCastle'];
                if (s !== 'attack' && s !== 'run' && !revealSpells.includes(s) && SPELL_DB[s]) {
                    combatActionKeys.push(s);
                }
            });
            combatActionKeys.push('run');

            combatActionKeys.forEach((k, index) => {
                const d = SPELL_DB[k];
                if (d) {
                    const btn = document.createElement('button');
                    btn.innerHTML = d.cost ? `${d.name} (${d.cost})` : d.name;
                    btn.onclick = () => combatAction(k);
                    if (d.tooltip) btn.title = d.tooltip;
                    if (index === combatIdx) {
                        btn.className = "selected-btn";
                        btn.focus();
                    }
                    if (d.cost > player.mp) btn.disabled = true;
                    bar.appendChild(btn);
                }
            });
        }

        function combatAction(key) {
            if (gameState !== 'COMBAT' || isInputBlocked || !combatActive) return;
            const spell = SPELL_DB[key];
            if (spell.cost > player.mp) return;
            player.mp -= spell.cost;

            isInputBlocked = true; 
            let log = "";
            let damageDealt = 0;
            let canEvade = currentEnemy.behavior === 'evasive' && key !== 'truestrike';
            let evaded = canEvade && Math.random() < 0.35; // 35% evasion chance
            
            // Check for armor reduction (except for shatter spell)
            let armorReduction = 0;
            if (currentEnemy.behavior === 'armored' && key !== 'shatter') {
                armorReduction = 0.4; // 40% damage reduction for armored enemies
            }
            
            // Blade of Dawn bonus vs The Shadow
            let shadowBonus = 1;
            if (currentEnemy.name === 'The Shadow' && player.hasSword) {
                shadowBonus = 1.5; // 50% extra damage with Blade of Dawn
            }
            
            if (key === 'attack') {
                if (evaded) {
                    log = `${currentEnemy.name} dodges your attack! üí®`;
                } else {
                    damageDealt = player.atk + Math.floor(Math.random()*5);
                    damageDealt = Math.floor(damageDealt * (1 - armorReduction) * shadowBonus);
                    currentEnemy.hp -= damageDealt; 
                    log = `Hit for ${damageDealt}.${armorReduction > 0 ? ' (Armor absorbed some damage)' : ''}${shadowBonus > 1 ? ' ‚öîÔ∏è Blade of Dawn!' : ''}`; 
                    playShake();
                }
            } else if (key === 'fireball' || key === 'lightning') {
                if (evaded) {
                    log = `${currentEnemy.name} evades ${spell.name}! üí®`;
                } else {
                    damageDealt = Math.floor(player.atk * 2.5 * (1 - armorReduction) * shadowBonus); 
                    currentEnemy.hp -= damageDealt; 
                    log = `${spell.name}! ${damageDealt} dmg!${shadowBonus > 1 ? ' ‚öîÔ∏è' : ''}`; 
                    playShake();
                }
            } else if (key === 'iceball') {
                if (evaded) {
                    log = `${currentEnemy.name} dodges the Iceball! üí®`;
                } else {
                    damageDealt = Math.floor(player.atk * 1.5 * (1 - armorReduction) * shadowBonus); 
                    currentEnemy.hp -= damageDealt; 
                    enemyFrozenTurns = 2; // Freeze for 2 turns
                    log = `‚ùÑÔ∏è Frozen for 2 turns! ${damageDealt} dmg.${shadowBonus > 1 ? ' ‚öîÔ∏è' : ''}`; 
                    playShake();
                }
            } else if (key === 'bleed') {
                if (evaded) {
                    log = `${currentEnemy.name} evades your blade! üí®`;
                } else {
                    damageDealt = Math.floor(player.atk * (1 - armorReduction) * shadowBonus);
                    currentEnemy.hp -= damageDealt;
                    enemyBleedingTurns = 3;
                    log = `ü©∏ Applied Bleed! ${damageDealt} dmg + 5/turn for 3 turns.${shadowBonus > 1 ? ' ‚öîÔ∏è' : ''}`;
                    playShake();
                }
            } else if (key === 'cleanse') {
                if (playerPoisonTurns > 0) {
                    playerPoisonTurns = 0;
                    playerPoisonDamage = 0;
                    log = 'üíö Cleansed! Poison removed.';
                } else {
                    log = 'üíö Cleanse... but you had no ailments.';
                }
            } else if (key === 'shatter') {
                // Shatter ignores armor and deals bonus damage to armored
                let baseDamage = player.atk * 2;
                if (currentEnemy.behavior === 'armored') {
                    baseDamage = Math.floor(baseDamage * 1.5); // 50% bonus vs armored
                    log = `üî® SHATTER! Armor broken! ${baseDamage} dmg!`;
                } else {
                    log = `üî® Shatter deals ${baseDamage} dmg!`;
                }
                baseDamage = Math.floor(baseDamage * shadowBonus);
                if (!evaded) {
                    currentEnemy.hp -= baseDamage;
                    playShake();
                } else {
                    log = `${currentEnemy.name} evades Shatter! üí®`;
                }
            } else if (key === 'truestrike') {
                // True Strike cannot be evaded
                damageDealt = Math.floor(player.atk * 2 * (1 - armorReduction) * shadowBonus);
                currentEnemy.hp -= damageDealt;
                log = `üéØ True Strike! ${damageDealt} dmg! (Cannot miss)${shadowBonus > 1 ? ' ‚öîÔ∏è' : ''}`;
                playShake();
            } else if (key === 'slow') {
                if (evaded) {
                    log = `${currentEnemy.name} evades the temporal magic! üí®`;
                } else {
                    damageDealt = Math.floor(player.atk * (1 - armorReduction) * shadowBonus);
                    currentEnemy.hp -= damageDealt;
                    enemySlowedTurns = 3;
                    log = `üåÄ Slowed! ${damageDealt} dmg. No multi-attacks for 3 turns.${shadowBonus > 1 ? ' ‚öîÔ∏è' : ''}`;
                    playShake();
                }
            } else if (key === 'drainlife') {
                if (evaded) {
                    log = `${currentEnemy.name} evades your dark magic! üí®`;
                } else {
                    damageDealt = Math.floor(player.atk * 1.5 * (1 - armorReduction) * shadowBonus);
                    currentEnemy.hp -= damageDealt;
                    const healAmount = Math.floor(damageDealt * 0.5);
                    player.hp = Math.min(player.maxHp, player.hp + healAmount);
                    log = `üíÄ Drain Life! ${damageDealt} dmg, healed ${healAmount} HP!${shadowBonus > 1 ? ' ‚öîÔ∏è' : ''}`;
                    playShake();
                }
            } else if (key === 'heal') {
                player.hp = Math.min(player.maxHp, player.hp+30); log = "‚ù§Ô∏è Healed 30 HP.";
            } else if (key === 'megaheal') {
                player.hp = player.maxHp; log = "üíñ Full Heal.";
            } else if (key === 'run') {
                if (currentEnemy.name === 'Dragon' || currentEnemy.name === 'The Shadow') { log = "Can't run from this fight!"; }
                else if (Math.random() > 0.5) { endCombat(false); return; }
                else log = "Escape failed!";
            }

            updateCombatUI(log);
            if (currentEnemy.hp <= 0) { 
                combatActive = false; // LOCK
                setTimeout(() => victory(), 500); 
                return; 
            }
            setTimeout(() => {
                enemyTurn();
                isInputBlocked = false; 
            }, 800);
        }

        function enemyTurn() {
            if (gameState !== 'COMBAT' || !combatActive) return;
            
            // Process status effects on enemy
            let statusMessages = [];
            
            // Bleed damage (before anything else)
            if (enemyBleedingTurns > 0) {
                currentEnemy.hp -= 5;
                statusMessages.push(`ü©∏ Bleed: -5 HP`);
                enemyBleedingTurns--;
                if (currentEnemy.hp <= 0) {
                    updateCombatUI(`ü©∏ ${currentEnemy.name} bled out!`);
                    combatActive = false;
                    setTimeout(() => victory(), 500);
                    return;
                }
            }
            
            // Regenerating enemies heal (unless bleeding)
            if (currentEnemy.behavior === 'regenerating' && enemyBleedingTurns === 0) {
                const regenAmount = Math.floor(currentEnemy.max * 0.08); // 8% max HP regen
                currentEnemy.hp = Math.min(currentEnemy.max, currentEnemy.hp + regenAmount);
                statusMessages.push(`üíö Regen: +${regenAmount} HP`);
            }
            
            // Decrement slow counter
            if (enemySlowedTurns > 0) {
                enemySlowedTurns--;
            }
            
            // Check if enemy is frozen
            if (enemyFrozenTurns > 0) { 
                enemyFrozenTurns--; 
                let msg = statusMessages.length > 0 ? statusMessages.join(' | ') + ' | ' : '';
                if (enemyFrozenTurns > 0) {
                    updateCombatUI(msg + `Enemy is frozen solid! (${enemyFrozenTurns} turns left)`); 
                } else {
                    updateCombatUI(msg + "The ice shatters! Enemy can move again."); 
                }
                return; 
            }
            
            // Enraged behavior - boost attack when low HP
            if (currentEnemy.behavior === 'enraged' && currentEnemy.hp < currentEnemy.max * 0.3) {
                currentEnemy.atk = Math.floor(currentEnemy.baseAtk * 1.5);
            }
            
            // Dragon quotes
            if (currentEnemy.name === 'Dragon' && Math.random() < 0.4) {
                const quote = DRAGON_QUOTES[Math.floor(Math.random() * DRAGON_QUOTES.length)];
                let msg = statusMessages.length > 0 ? statusMessages.join(' | ') + '\n' : '';
                updateCombatUI(msg + `Dragon: "${quote}"`);
                setTimeout(() => { dealDamage(); }, 1000);
            } else {
                // Check for multi-attack
                if (currentEnemy.behavior === 'multiattack' && enemySlowedTurns === 0 && Math.random() < 0.4) {
                    // Multi-attack: attack twice but with reduced damage each
                    let msg = statusMessages.length > 0 ? statusMessages.join(' | ') + ' | ' : '';
                    dealDamage(0.7, msg + '‚ö° Swift Strike x2! ');
                    setTimeout(() => {
                        if (player.hp > 0 && combatActive) {
                            dealDamage(0.7, '‚ö° Second hit! ');
                        }
                    }, 500);
                } else {
                    let msg = statusMessages.length > 0 ? statusMessages.join(' | ') + ' | ' : '';
                    dealDamage(1, msg);
                }
            }
        }

      function dealDamage(damageModifier = 1, prefix = '') {
    // Check barricade first
    if (player.barricadeActive) {
        player.barricadeActive = false;
        updateCombatUI(prefix + `üöß Barricade blocked the attack!`);
        return;
    }
    
    let dmg = Math.max(0, currentEnemy.atk - Math.floor(Math.random()*3));
    dmg = Math.floor(dmg * damageModifier);
    
    // Shadow takes reduced damage against Enchanted Shield
    if (currentEnemy.name === 'The Shadow' && player.hasShield) {
        dmg = Math.floor(dmg * 0.75); // 25% less damage
    }
    
    // Apply shield defense reduction
    if (player.equipment && player.equipment.shield) {
        const reduction = player.equipment.shield.defense / 100;
        dmg = Math.floor(dmg * (1 - reduction));
    } else if (player.hasShield) {
        dmg = Math.floor(dmg * 0.6);
    }
    
    player.hp -= dmg;
    const shieldText = (player.equipment && player.equipment.shield) || player.hasShield ? " üõ°Ô∏è" : "";
    let logMsg = prefix + `${currentEnemy.name} hits for ${dmg} dmg.${shieldText}`;
    
    // Poison application for poisonous enemies
    if (currentEnemy.behavior === 'poisonous' && Math.random() < 0.5 && playerPoisonTurns === 0) {
        playerPoisonTurns = 3;
        playerPoisonDamage = Math.floor(currentEnemy.atk * 0.3);
        logMsg += ` ‚ò†Ô∏è POISONED! (${playerPoisonDamage}/turn for 3 turns)`;
    }
    
    // Apply existing poison damage to player
    if (playerPoisonTurns > 0) {
        player.hp -= playerPoisonDamage;
        playerPoisonTurns--;
        if (playerPoisonTurns > 0) {
            logMsg += ` | ‚ò†Ô∏è Poison: -${playerPoisonDamage} HP (${playerPoisonTurns} left)`;
        } else {
            logMsg += ` | ‚ò†Ô∏è Poison: -${playerPoisonDamage} HP (Wore off!)`;
        }
    }
    
    updateCombatUI(logMsg);
    if (player.hp <= 0) endGame(false);
}
       function victory() {
            if (currentEnemy.name === 'The Shadow') {
                showAlert("üë§ THE SHADOW\n\n'No... NO! This cannot be! I who have existed for eons... defeated by a mortal?!\n\nVery well, little wizard. You have earned this victory. With my destruction, the curse upon this land is truly broken. The Dragon I summoned, the fog I spread, the fear I sowed... all of it fades with me.\n\nRemember my name... for even shadows... can dream of... light...'\n\n*The Shadow dissolves into a thousand motes of light that rise into the sky, joining the stars*", () => {
                    endGame('shadow');
                });
                return;
            }
            
            if (currentEnemy.name === 'Dragon') {
                showAlert("üê≤ DRAGON: 'You... may have defeated this form... but the Shadow... never dies...'", () => {
                    // Show victory screen after dragon's last words
                    endGame(true);
                });
                return;
            }

            // Track monster kill for quests
            // Find the enemy type key from the name
            const enemyTypeMap = {
                'Giant Rat': 'rat', 'Slime': 'slime', 'Cave Bat': 'bat', 'Viper': 'snake',
                'Goblin': 'goblin', 'Wolf': 'wolf', 'Giant Spider': 'spider', 'Skeleton': 'skeleton',
                'Ghost': 'ghost', 'Orc': 'orc', 'Gargoyle': 'gargoyle', 'Troll': 'troll',
                'Demon': 'demon', 'Mountain Harpy': 'harpy', 'Ogre': 'ogre'
            };
            const enemyType = enemyTypeMap[currentEnemy.name];
            if (enemyType) {
                trackMonsterKill(enemyType);
            }

            // CRITICAL FIX: REMOVE SPECIFIC ENTITY
            if (combatTile) {
                combatTile.entity = null; 
            }

            player.gold += currentEnemy.gold;
            let lootMsg = `+${currentEnemy.gold} Gold.`;
            if (Math.random() < 0.3) {
                const drops = ['potion', 'ether'];
                const drop = drops[Math.floor(Math.random()*drops.length)];
                player.inventory[drop]++;
                lootMsg += ` Dropped: ${ITEM_DB[drop].name}!`;
            }
            
            showAlert(`Victory! ${lootMsg}`, () => {
                // Play victory fanfare
                if (musicEnabled) playVictoryMusic();
                endCombat(true);
            });
        }

       function endCombat(win) {
            document.getElementById('combat-screen').style.display = 'none';
            
            // Close any other open screens
            document.getElementById('inventory-screen').style.display = 'none';
            document.getElementById('worldmap-screen').style.display = 'none';
            
            gameState = 'MAP';
            isInputBlocked = false;
            combatActive = false;
            if (win) gainXp(currentEnemy.xp);
            renderMap();
            
            // Return to overworld music after a delay (let victory fanfare play)
            if (musicEnabled && win) {
                setTimeout(() => {
                    if (gameState === 'MAP' && musicEnabled) playOverworldMusic();
                }, 4000);
            } else if (musicEnabled) {
                playOverworldMusic();
            }
        }

/* --- CRAFTING SYSTEM --- */
function toggleCraftSection(section) {
    craftMenuStates[section] = !craftMenuStates[section];
    const menu = document.getElementById(`craft-${section}-menu`);
    const arrow = document.getElementById(`${section}-arrow`);
    
    if (craftMenuStates[section]) {
        menu.classList.add('expanded');
        arrow.innerText = '‚ñ≤';
    } else {
        menu.classList.remove('expanded');
        arrow.innerText = '‚ñº';
    }
}

function renderCampfireMenu() {
    // Render rest button
    const restBtnContainer = document.getElementById('campfire-rest-btn-container');
    const alreadyRested = currentCampfireTile && currentCampfireTile.rested;
    
    if (alreadyRested) {
        restBtnContainer.innerHTML = `
            <button class="close-btn" style="margin-bottom: 20px; opacity: 0.5;" disabled>
                üí§ Already Rested
            </button>
        `;
    } else {
        restBtnContainer.innerHTML = `
            <button class="close-btn" style="margin-bottom: 20px;" onclick="restAtCampfireAndCraft()">
                üí§ Rest (Restore HP)
            </button>
        `;
    }
    
    // Render craftable items
    const itemsMenu = document.getElementById('craft-items-menu');
    itemsMenu.innerHTML = '';

    CRAFT_RECIPES.items.forEach(recipe => {
        const canAfford = player.inventory.wood >= recipe.cost;
        const alreadyHave = player.inventory[recipe.id] > 0 || 
                           (recipe.id === 'woodenShield' && (player.equipment.shield || player.hasShield)) ||
                           (recipe.id === 'reinforcedStaff' && player.equipment.weapon);
        
        const card = document.createElement('div');
        card.className = 'craft-card';
        
        card.innerHTML = `
            <div class="craft-info">
                <div class="craft-name">${recipe.name}</div>
                <div class="craft-cost">Cost: ${recipe.cost} ü™µ</div>
                <div class="craft-desc">${recipe.desc}</div>
                <div style="color: #95a5a6; font-size: 0.85rem; margin-top: 5px;">You have: ${player.inventory[recipe.id] || 0}</div>
            </div>
            <button class="craft-btn" ${!canAfford ? 'disabled' : ''} 
                    onclick="craftItem('${recipe.id}', ${recipe.cost})">
                Craft
            </button>
        `;
        
        itemsMenu.appendChild(card);
    });

    // Render enhancements
    const enhancementsMenu = document.getElementById('craft-enhancements-menu');
    enhancementsMenu.innerHTML = '';

    CRAFT_RECIPES.enhancements.forEach(recipe => {
        const upgradeKey = `${currentCampfireLocation}-${recipe.id}`;
        const alreadyUpgraded = player.campfireUpgrades[upgradeKey];
        const canAfford = player.inventory.wood >= recipe.cost;
        
        const card = document.createElement('div');
        card.className = 'craft-card';
        
        card.innerHTML = `
            <div class="craft-info">
                <div class="craft-name">${recipe.name}</div>
                <div class="craft-cost">Cost: ${recipe.cost} ü™µ</div>
                <div class="craft-desc">${recipe.desc}</div>
                ${alreadyUpgraded ? '<div style="color: var(--gold); font-size: 0.85rem; margin-top: 5px;">‚úì Already built</div>' : ''}
            </div>
            <button class="craft-btn" ${!canAfford || alreadyUpgraded ? 'disabled' : ''} 
                    onclick="craftEnhancement('${recipe.id}', ${recipe.cost})">
                Build
            </button>
        `;
        
enhancementsMenu.appendChild(card);
    });

    // Render cooking menu
const cookingMenu = document.getElementById('craft-cooking-menu');
    cookingMenu.innerHTML = '';

    CRAFT_RECIPES.cooking.forEach(recipe => {
        const canAffordFish = player.inventory.fish >= recipe.fishCost;
        const canAffordWood = player.inventory.wood >= recipe.woodCost;
        const canAfford = canAffordFish && canAffordWood;
        
        const card = document.createElement('div');
        card.className = 'craft-card';
        
        const costText = recipe.woodCost > 0 
            ? `${recipe.fishCost} üêü + ${recipe.woodCost} ü™µ`
            : `${recipe.fishCost} üêü`;
        
       card.innerHTML = `
            <div class="craft-info">
                <div class="craft-name">${recipe.name}</div>
                <div class="craft-cost">Cost: ${costText}</div>
                <div class="craft-desc">${recipe.desc}</div>
                <div style="color: #95a5a6; font-size: 0.85rem; margin-top: 5px;">You have: ${player.inventory[recipe.id] || 0}</div>
            </div>
            <button class="craft-btn" ${!canAfford ? 'disabled' : ''} 
                    onclick="cookItem('${recipe.id}', ${recipe.fishCost}, ${recipe.woodCost})">
                Cook
            </button>
             `;
        
        cookingMenu.appendChild(card);
    });
}

function craftItem(itemId, cost) {
    if (player.inventory.wood < cost) return;

    player.inventory.wood -= cost;
    player.inventory[itemId]++;
    
    // Track for quests
    trackCraftedItem(itemId);

    const recipe = CRAFT_RECIPES.items.find(r => r.id === itemId);
    showAlert(`üî® Crafted ${recipe.name}!`);
    
    renderCampfireMenu();
    updateUI();
}

function craftEnhancement(enhancementId, cost) {
    if (player.inventory.wood < cost) return;
    
    const upgradeKey = `${currentCampfireLocation}-${enhancementId}`;
    if (player.campfireUpgrades[upgradeKey]) return;

    player.inventory.wood -= cost;
    player.campfireUpgrades[upgradeKey] = true;

    const recipe = CRAFT_RECIPES.enhancements.find(r => r.id === enhancementId);
    showAlert(`‚ö° Built ${recipe.name}!`);
    
    renderCampfireMenu();
    updateUI();
}

function cookItem(itemId, fishCost, woodCost) {
    if (player.inventory.fish < fishCost || player.inventory.wood < woodCost) return;

    player.inventory.fish -= fishCost;
    player.inventory.wood -= woodCost;
    player.inventory[itemId]++;
    
    // Track for quests
    trackCraftedItem(itemId);

    const recipe = CRAFT_RECIPES.cooking.find(r => r.id === itemId);
    showAlert(`üç≥ Cooked ${recipe.name}!`);
    
    renderCampfireMenu();
    updateUI();
}

/* --- TERRAIN MODIFICATIONS --- */
function toggleTerrainMenu() {
    terrainMenuExpanded = !terrainMenuExpanded;
    const menu = document.getElementById('terrain-menu');
    const arrow = document.getElementById('terrain-arrow');
    
    if (terrainMenuExpanded) {
        menu.classList.add('expanded');
        arrow.innerText = '‚ñ≤';
    } else {
        menu.classList.remove('expanded');
        arrow.innerText = '‚ñº';
    }
}

function toggleSpellsMenu() {
    spellsMenuExpanded = !spellsMenuExpanded;
    const menu = document.getElementById('spells-menu');
    const arrow = document.getElementById('spells-arrow');
    
    if (spellsMenuExpanded) {
        menu.classList.add('expanded');
        arrow.innerText = '‚ñ≤';
    } else {
        menu.classList.remove('expanded');
        arrow.innerText = '‚ñº';
    }
}

function renderSpellsMenu() {
    const menu = document.getElementById('spells-menu');
    menu.innerHTML = '';
    
    // Define utility spells that can be used from inventory
    const utilitySpells = [
        { id: 'heal', name: '‚ù§Ô∏è Heal', cost: 5, desc: 'Restore 30 HP', effect: () => {
            if (player.hp >= player.maxHp) return { success: false, msg: "Already at full health!" };
            const healed = Math.min(30, player.maxHp - player.hp);
            player.hp += healed;
            return { success: true, msg: `‚ù§Ô∏è Healed ${healed} HP!` };
        }},
        { id: 'megaheal', name: 'üíñ Mega Heal', cost: 15, desc: 'Fully restore HP', effect: () => {
            if (player.hp >= player.maxHp) return { success: false, msg: "Already at full health!" };
            const healed = player.maxHp - player.hp;
            player.hp = player.maxHp;
            return { success: true, msg: `üíñ Fully healed! Restored ${healed} HP!` };
        }},
        { id: 'cleanse', name: 'üíö Cleanse', cost: 8, desc: 'Remove poison and debuffs', effect: () => {
            if (playerPoisonTurns <= 0) return { success: false, msg: "No debuffs to cleanse!" };
            playerPoisonTurns = 0;
            playerPoisonDamage = 0;
            return { success: true, msg: "üíö Cleansed! All debuffs removed!" };
        }}
    ];
    
    utilitySpells.forEach((spell) => {
        const hasSpell = player.spells.includes(spell.id);
        const canAfford = player.mp >= spell.cost;
        const canUse = hasSpell && canAfford;
        
        const card = document.createElement('div');
        card.className = 'craft-card';
        
        if (!hasSpell) {
            card.innerHTML = `
                <div class="craft-info">
                    <div class="craft-name" style="color: #666;">${spell.name}</div>
                    <div class="craft-cost" style="color: #666;">Cost: ${spell.cost} MP</div>
                    <div class="craft-desc" style="color: #555;">Not learned yet</div>
                </div>
                <button class="craft-btn" disabled>???</button>
            `;
        } else {
            card.innerHTML = `
                <div class="craft-info">
                    <div class="craft-name">${spell.name}</div>
                    <div class="craft-cost">Cost: ${spell.cost} üíô</div>
                    <div class="craft-desc">${spell.desc}</div>
                </div>
                <button class="craft-btn" ${!canAfford ? 'disabled' : ''} 
                        onclick="useUtilitySpell('${spell.id}')">
                    Cast
                </button>
            `;
        }
        
        menu.appendChild(card);
    });
}

function useUtilitySpell(spellId) {
    const spellEffects = {
        'heal': { cost: 5, effect: () => {
            if (player.hp >= player.maxHp) return { success: false, msg: "Already at full health!" };
            const healed = Math.min(30, player.maxHp - player.hp);
            player.hp += healed;
            return { success: true, msg: `‚ù§Ô∏è Healed ${healed} HP!` };
        }},
        'megaheal': { cost: 15, effect: () => {
            if (player.hp >= player.maxHp) return { success: false, msg: "Already at full health!" };
            const healed = player.maxHp - player.hp;
            player.hp = player.maxHp;
            return { success: true, msg: `üíñ Fully healed! Restored ${healed} HP!` };
        }},
        'cleanse': { cost: 8, effect: () => {
            if (playerPoisonTurns <= 0) return { success: false, msg: "No debuffs to cleanse!" };
            playerPoisonTurns = 0;
            playerPoisonDamage = 0;
            return { success: true, msg: "üíö Cleansed! All debuffs removed!" };
        }}
    };
    
    const spell = spellEffects[spellId];
    if (!spell) return;
    
    if (!player.spells.includes(spellId)) {
        closeInventory();
        showAlert("You haven't learned this spell yet!");
        return;
    }
    
    if (player.mp < spell.cost) {
        closeInventory();
        showAlert("Not enough MP!");
        return;
    }
    
    const result = spell.effect();
    
    if (!result.success) {
        closeInventory();
        showAlert(result.msg);
        return;
    }
    
    player.mp -= spell.cost;
    const wasInCombat = previousGameState === 'COMBAT';
    closeInventory();
    updateUI();
    
    if (wasInCombat) {
        updateCombatUI(result.msg);
        // Trigger enemy turn after using spell in combat
        if (combatActive && currentEnemy.hp > 0) {
            isInputBlocked = true;
            setTimeout(() => { 
                enemyTurn(); 
                isInputBlocked = false; 
            }, 800);
        }
    } else {
        showAlert(result.msg);
    }
}

function renderTerrainMenu() {
    const menu = document.getElementById('terrain-menu');
    menu.innerHTML = '';
    
    const inCombat = previousGameState === 'COMBAT';

    TERRAIN_RECIPES.forEach((recipe) => {
        const card = document.createElement('div');
        card.className = 'craft-card';
        
        const canAfford = player.inventory.wood >= recipe.cost;
        const canUse = canAfford && !inCombat;
        
        if (inCombat) {
            card.innerHTML = `
                <div class="craft-info">
                    <div class="craft-name" style="color: #666;">${recipe.name}</div>
                    <div class="craft-cost" style="color: #666;">Cost: ${recipe.cost} ü™µ</div>
                    <div class="craft-desc" style="color: #e74c3c;">Not available in combat</div>
                </div>
                <button class="craft-btn" disabled>Build</button>
            `;
        } else {
            card.innerHTML = `
                <div class="craft-info">
                    <div class="craft-name">${recipe.name}</div>
                    <div class="craft-cost">Cost: ${recipe.cost} ü™µ</div>
                    <div class="craft-desc">${recipe.desc}</div>
                </div>
                <button class="craft-btn" ${!canAfford ? 'disabled' : ''} 
                        onclick="useTerrainModification('${recipe.id}', ${recipe.cost})">
                    Build
                </button>
            `;
        }
        
        menu.appendChild(card);
    });
}

function toggleItemsMenu() {
    itemsMenuExpanded = !itemsMenuExpanded;
    const menu = document.getElementById('items-menu');
    const arrow = document.getElementById('items-menu-arrow');
    
    if (itemsMenuExpanded) {
        menu.classList.add('expanded');
        arrow.innerText = '‚ñ≤';
    } else {
        menu.classList.remove('expanded');
        arrow.innerText = '‚ñº';
    }
}

function renderItemsMenu() {
    const menu = document.getElementById('items-menu');
    menu.innerHTML = '';
    
    const itemKeys = [];
    Object.keys(player.inventory).forEach(key => {
        if (player.inventory[key] > 0) itemKeys.push(key);
    });
    
    if (itemKeys.length === 0) {
        menu.innerHTML = '<div style="padding:10px; color:#aaa; text-align:center;">Your bag is empty.</div>';
        return;
    }
    
    itemKeys.forEach((key) => {
        const count = player.inventory[key];
        const data = ITEM_DB[key];
        const card = document.createElement('div');
        card.className = 'craft-card';
        
        let actionBtn = '';
        
        // Handle equipment items
        if (data.type === 'equipment') {
            const isEquipped = (data.attack && player.equipment.weapon && player.equipment.weapon.id === key) ||
                              (data.defense && player.equipment.shield && player.equipment.shield.id === key) ||
                              (data.maxHp && player.equipment.helmet && player.equipment.helmet.id === key);
            
            if (isEquipped) {
                actionBtn = `<span style="font-size:0.8rem; color:var(--gold);">‚úì Equipped</span>`;
            } else {
                actionBtn = `<button class="craft-btn" onclick="equipItem('${key}')">Equip</button>`;
            }
        } else if (data.type === 'mat') {
            actionBtn = `<span style="font-size:0.8rem; color:#aaa;">Sell at Store</span>`;
        } else if (data.type === 'throwable') {
            // Throwable items (like stones) - can throw in combat, otherwise just material
            if (previousGameState === 'COMBAT') {
                actionBtn = `<button class="craft-btn" onclick="throwItem('${key}')">Throw</button>`;
            } else {
                actionBtn = `<span style="font-size:0.8rem; color:#aaa;">Sell at Store</span>`;
            }
        } else if (data.type === 'special') {
            // Combat-only items
            if (previousGameState === 'COMBAT') {
                actionBtn = `<button class="craft-btn" onclick="useItem('${key}')">Use</button>`;
            } else {
                actionBtn = `<span style="font-size:0.8rem; color:#e74c3c;">Combat only</span>`;
            }
        } else {
            actionBtn = `<button class="craft-btn" onclick="useItem('${key}')">Use</button>`;
        }
        
        card.innerHTML = `
            <div class="craft-info">
                <div class="craft-name">${data.name} (x${count})</div>
                <div class="craft-desc">${data.desc}</div>
            </div>
            ${actionBtn}
        `;
        
        menu.appendChild(card);
    });
}

function useTerrainModification(recipeId, cost) {
    if (player.inventory.wood < cost) return;

    if (recipeId === 'clearPath') {
        // Check current tile and all 4 adjacent tiles for mountains
        const currentTile = getTile(player.x, player.y);
        const adjacentTiles = [
            currentTile, // Current tile (standing on mountain)
            getTile(player.x, player.y - 1), // North
            getTile(player.x, player.y + 1), // South
            getTile(player.x - 1, player.y), // West
            getTile(player.x + 1, player.y)  // East
        ];
        
        let foundMountain = null;
        for (let tile of adjacentTiles) {
            if (tile && tile.type === 'mountain') {
                foundMountain = tile;
                break;
            }
        }

        if (foundMountain) {
            foundMountain.type = 'grass';
            player.inventory.wood -= cost;
            player.inventory.stone++;
            
            // Close inventory BEFORE showing alert
            closeInventory();
            
            // Check if player now has 5 stones and hasn't crafted rock helmet yet
            if (player.inventory.stone >= 5 && !player.foundRockHelmet) {
                player.inventory.stone -= 5;
                player.foundRockHelmet = true;
                
                // Unequip current helmet if any
                if (player.equipment.helmet) {
                    player.inventory[player.equipment.helmet.id]++;
                    player.maxHp -= player.equipment.helmet.maxHp;
                }
                
                // Equip rock helmet
                player.equipment.helmet = {
                    id: 'rockHelmet',
                    name: '‚õëÔ∏è Rock Helmet',
                    maxHp: 25
                };
                player.maxHp += 25;
                player.hp = Math.min(player.hp, player.maxHp);
                
                showAlert("ü™® ROCK HELMET FORGED!\n\nAs you clear the fifth mountain, the stones in your pack begin to vibrate and glow with ancient earth magic. Before your eyes, they fuse together, shaped by forces older than the Dragon itself!\n\nThe dwarves of old knew this secret: the mountains remember, and reward those who reshape the land with patience and purpose.\n\n‚õëÔ∏è Rock Helmet equipped! +25 Max HP!");
            } else {
                showAlert(`ü™ì Cleared path! +1 Stone ü™®\n\nYou now have ${player.inventory.stone} stone${player.inventory.stone !== 1 ? 's' : ''}.`);
            }
            renderMap();
            updateUI();
        } else {
            // Close inventory BEFORE showing alert
            closeInventory();
            
            showAlert("‚ùå No mountain directly adjacent to you!");
        }
    } else if (recipeId === 'buildBridge') {
        // Check all 4 adjacent tiles for water
        const adjacentTiles = [
            getTile(player.x, player.y - 1), // North
            getTile(player.x, player.y + 1), // South
            getTile(player.x - 1, player.y), // West
            getTile(player.x + 1, player.y)  // East
        ];
        
        let foundWater = null;
        for (let tile of adjacentTiles) {
            if (tile && tile.type === 'water') {
                foundWater = tile;
                break;
            }
        }

        if (foundWater) {
            foundWater.type = 'bridge';
            player.inventory.wood -= cost;
            
            // Close inventory BEFORE showing alert
            closeInventory();
            
            showAlert(`üåâ Built bridge! Water is now walkable.`);
            renderMap();
            updateUI();
        } else {
            // Close inventory BEFORE showing alert
            closeInventory();
            
            showAlert("‚ùå No water directly adjacent to you!");
        }
    } else if (recipeId === 'buildWatchtower') {
        // Find an adjacent grass tile to place the watchtower
        const adjacentOffsets = [
            {dx: 0, dy: -1},  // North
            {dx: 0, dy: 1},   // South  
            {dx: -1, dy: 0},  // West
            {dx: 1, dy: 0}    // East
        ];
        
        let towerTile = null;
        for (let offset of adjacentOffsets) {
            const tile = getTile(player.x + offset.dx, player.y + offset.dy);
            if (tile && tile.type === 'grass' && !tile.entity) {
                towerTile = tile;
                break;
            }
        }
        
        if (!towerTile) {
            closeInventory();
            showAlert("‚ùå No suitable grass tile adjacent to build watchtower!");
            return;
        }
        
        // Place the watchtower on the map
        towerTile.type = 'watchtower';
        
        // Reveal 5x5 area around the tower
        for (let dy = -2; dy <= 2; dy++) {
            for (let dx = -2; dx <= 2; dx++) {
                const tile = getTile(towerTile.x + dx, towerTile.y + dy);
                if (tile) tile.explored = true;
            }
        }
        
        player.inventory.wood -= cost;
        
        // Close inventory BEFORE showing alert
        closeInventory();
        
        showAlert(`üóº Built Watchtower! Revealed nearby area.`);
        renderMap();
        updateUI();
    }
}/* --- EQUIPMENT SYSTEM --- */
function renderEquipment() {
    const weaponSlot = document.getElementById('weapon-slot');
    const weaponDisplay = document.getElementById('weapon-display');
    
    if (player.equipment && player.equipment.weapon) {
        weaponSlot.classList.add('has-item');
        weaponDisplay.innerHTML = `
            <div class="equipped-item">‚öî</div>
            <div class="equipped-name">${player.equipment.weapon.name}</div>
            <div class="equipped-stats">+${player.equipment.weapon.attack} ATK</div>
            <button class="unequip-btn" onclick="unequipItem('weapon')">Unequip</button>
        `;
    } else {
        weaponSlot.classList.remove('has-item');
        weaponDisplay.innerHTML = `<div style="color: #555;">Empty</div>`;
    }

    const shieldSlot = document.getElementById('shield-slot');
    const shieldDisplay = document.getElementById('shield-display');
    
    if (player.equipment && player.equipment.shield) {
        shieldSlot.classList.add('has-item');
        shieldDisplay.innerHTML = `
            <div class="equipped-item">üî∞</div>
            <div class="equipped-name">${player.equipment.shield.name}</div>
            <div class="equipped-stats">-${player.equipment.shield.defense}% Damage</div>
            <button class="unequip-btn" onclick="unequipItem('shield')">Unequip</button>
        `;
    } else {
        shieldSlot.classList.remove('has-item');
        shieldDisplay.innerHTML = `<div style="color: #555;">Empty</div>`;
    }

    const helmetSlot = document.getElementById('helmet-slot');
    const helmetDisplay = document.getElementById('helmet-display');
    
    if (player.equipment && player.equipment.helmet) {
        helmetSlot.classList.add('has-item');
        helmetDisplay.innerHTML = `
            <div class="equipped-item">üë∑</div>
            <div class="equipped-name">${player.equipment.helmet.name}</div>
            <div class="equipped-stats">+${player.equipment.helmet.maxHp} Max HP</div>
            <button class="unequip-btn" onclick="unequipItem('helmet')">Unequip</button>
        `;
    } else {
        helmetSlot.classList.remove('has-item');
        helmetDisplay.innerHTML = `<div style="color: #555;">Empty</div>`;
    }
}

function equipItem(itemKey) {
    const item = ITEM_DB[itemKey];
    if (!item || item.type !== 'equipment') return;
    
    // Store the state we want to return to after alert
    const returnState = previousGameState;

    if (item.attack) {
        // It's a weapon
        if (player.equipment.weapon) {
            player.inventory[player.equipment.weapon.id]++;
            player.atk -= player.equipment.weapon.attack;
        }
        
        player.equipment.weapon = {
            id: itemKey,
            name: item.name,
            attack: item.attack
        };
        player.inventory[itemKey]--;
        player.atk += item.attack;
        
        // Hide inventory screen
        document.getElementById('inventory-screen').style.display = 'none';
        
        showAlert(`‚öîÔ∏è Equipped ${item.name}! +${item.attack} ATK`, () => {
            gameState = returnState;
        });
    } else if (item.defense) {
        // It's a shield
        if (player.equipment.shield) {
            player.inventory[player.equipment.shield.id]++;
        }
        
        player.equipment.shield = {
            id: itemKey,
            name: item.name,
            defense: item.defense
        };
        player.inventory[itemKey]--;
        player.hasShield = true;
        
        // Hide inventory screen
        document.getElementById('inventory-screen').style.display = 'none';
        
        showAlert(`üõ°Ô∏è Equipped ${item.name}! -${item.defense}% Damage`, () => {
            gameState = returnState;
        });
    } else if (item.maxHp) {
        // It's a helmet
        if (player.equipment.helmet) {
            player.inventory[player.equipment.helmet.id]++;
            player.maxHp -= player.equipment.helmet.maxHp;
            player.hp = Math.min(player.hp, player.maxHp);
        }
        
        player.equipment.helmet = {
            id: itemKey,
            name: item.name,
            maxHp: item.maxHp
        };
        player.inventory[itemKey]--;
        player.maxHp += item.maxHp;
        
        // Hide inventory screen
        document.getElementById('inventory-screen').style.display = 'none';
        
        showAlert(`ü™ñ Equipped ${item.name}! +${item.maxHp} Max HP`, () => {
            gameState = returnState;
        });
    }

    renderMap();
    updateUI();
}

function unequipItem(slotType) {
    // Store the state we want to return to after alert
    const returnState = previousGameState;
    
    if (slotType === 'weapon' && player.equipment.weapon) {
        const weapon = player.equipment.weapon;
        player.inventory[weapon.id]++;
        player.atk -= weapon.attack;
        player.equipment.weapon = null;
        
        // Hide inventory screen
        document.getElementById('inventory-screen').style.display = 'none';
        
        showAlert(`Unequipped ${weapon.name}`, () => {
            gameState = returnState;
        });
    } else if (slotType === 'shield' && player.equipment.shield) {
        const shield = player.equipment.shield;
        player.inventory[shield.id]++;
        player.equipment.shield = null;
        player.hasShield = false;
        
        // Hide inventory screen
        document.getElementById('inventory-screen').style.display = 'none';
        
        showAlert(`Unequipped ${shield.name}`, () => {
            gameState = returnState;
        });
    } else if (slotType === 'helmet' && player.equipment.helmet) {
        const helmet = player.equipment.helmet;
        player.inventory[helmet.id]++;
        player.maxHp -= helmet.maxHp;
        player.hp = Math.min(player.hp, player.maxHp);
        player.equipment.helmet = null;
        
        // Hide inventory screen
        document.getElementById('inventory-screen').style.display = 'none';
        
        showAlert(`Unequipped ${helmet.name}`, () => {
            gameState = returnState;
        });
    }

    renderMap();
    updateUI();
}        

/* --- QUEST SYSTEM --- */
function generateQuest(tile) {
    // Don't generate quest if this house already has one active
    const houseKey = `${worldX},${worldY}-${tile.x},${tile.y}`;
    if (player.quests.some(q => q.houseKey === houseKey)) return null;
    
    // 35% chance to offer a quest
    if (Math.random() > 0.35) return null;
    
    // Pick a random quest type
    const questTypes = Object.keys(QUEST_TEMPLATES);
    // Make find_castle rare (10% of quests)
    let questType;
    if (Math.random() < 0.1 && !player.quests.some(q => q.type === 'findcastle')) {
        questType = 'find_castle';
    } else {
        const filteredTypes = questTypes.filter(t => t !== 'find_castle');
        questType = filteredTypes[Math.floor(Math.random() * filteredTypes.length)];
    }
    
    const template = QUEST_TEMPLATES[questType];
    const giver = QUEST_GIVERS[Math.floor(Math.random() * QUEST_GIVERS.length)];
    const difficultyTier = Math.min(2, Math.floor(player.lvl / 2)); // 0, 1, or 2
    
    let quest = {
        id: Date.now() + Math.random(),
        houseKey: houseKey,
        worldX: worldX,
        worldY: worldY,
        tileX: tile.x,
        tileY: tile.y,
        giver: giver,
        type: template.type,
        giverDialogue: template.giverDialogues[Math.floor(Math.random() * template.giverDialogues.length)],
        journalEntry: template.journalEntries[Math.floor(Math.random() * template.journalEntries.length)],
        rewardGold: template.rewards.gold ? template.rewards.gold[difficultyTier] : 0,
        rewardXp: template.rewards.xp ? template.rewards.xp[difficultyTier] : 0,
        progress: 0,
        completed: false
    };
    
    // Set quest-specific details
    if (template.type === 'collect') {
        quest.target = template.target;
        quest.targetAmount = template.amounts[difficultyTier];
        quest.targetName = template.target === 'gold' ? 'Gold' : ITEM_DB[template.target]?.name || template.target;
    } else if (template.type === 'kill') {
        quest.target = template.targets[Math.floor(Math.random() * template.targets.length)];
        quest.targetAmount = template.amounts[difficultyTier];
        quest.targetName = quest.target.charAt(0).toUpperCase() + quest.target.slice(1) + 's';
    } else if (template.type === 'craft') {
        quest.target = template.targets[Math.floor(Math.random() * template.targets.length)];
        quest.targetAmount = template.amounts[difficultyTier];
        quest.targetName = ITEM_DB[quest.target]?.name || quest.target;
    } else if (template.type === 'buyspell') {
        quest.target = template.targets[Math.floor(Math.random() * template.targets.length)];
        quest.targetName = SPELL_DB[quest.target]?.name || quest.target;
    } else if (template.type === 'findcastle') {
        quest.targetName = 'The Hidden Castle';
    }
    
    // Generate quest title
    if (template.type === 'collect') {
        quest.title = `Gather ${quest.targetAmount} ${quest.targetName}`;
    } else if (template.type === 'kill') {
        quest.title = `Slay ${quest.targetAmount} ${quest.targetName}`;
    } else if (template.type === 'craft') {
        quest.title = `Craft ${quest.targetAmount} ${quest.targetName}`;
    } else if (template.type === 'buyspell') {
        quest.title = `Learn ${quest.targetName}`;
    } else if (template.type === 'findcastle') {
        quest.title = `Find the Hidden Castle`;
    }
    
    return quest;
}

function getQuestProgress(quest) {
    if (quest.type === 'collect') {
        if (quest.target === 'gold') {
            return Math.min(quest.targetAmount, player.gold);
        } else {
            return Math.min(quest.targetAmount, player.inventory[quest.target] || 0);
        }
    } else if (quest.type === 'kill') {
        return Math.min(quest.targetAmount, player.monstersKilled[quest.target] || 0);
    } else if (quest.type === 'craft') {
        // Track crafted items (we'll need to update crafting functions)
        return Math.min(quest.targetAmount, player.craftedItems?.[quest.target] || 0);
    } else if (quest.type === 'buyspell') {
        return player.spells.includes(quest.target) ? 1 : 0;
    } else if (quest.type === 'findcastle') {
        return (player.revealedCastle || player.foundCastleTile) ? 1 : 0;
    }
    return 0;
}

function isQuestComplete(quest) {
    const progress = getQuestProgress(quest);
    if (quest.type === 'buyspell' || quest.type === 'findcastle') {
        return progress >= 1;
    }
    return progress >= quest.targetAmount;
}

function turnInQuest(questId) {
    const questIndex = player.quests.findIndex(q => q.id === questId);
    if (questIndex === -1) return;
    
    const quest = player.quests[questIndex];
    if (!isQuestComplete(quest)) return;
    
    // Deduct collected items (except gold for gold quests, and except for kill/find quests)
    if (quest.type === 'collect' && quest.target !== 'gold') {
        player.inventory[quest.target] -= quest.targetAmount;
    } else if (quest.type === 'collect' && quest.target === 'gold') {
        player.gold -= quest.targetAmount;
    }
    
    // Give rewards
    player.gold += quest.rewardGold;
    gainXp(quest.rewardXp);
    player.completedQuests++;
    
    // Remove quest
    player.quests.splice(questIndex, 1);
    
    // Close journal and show reward
    closeJournal();
    showAlert(`üìú Quest Complete!\n\n"${quest.title}"\n\n${quest.giver.icon} ${quest.giver.name}:\n"Thank you, hero! Your kindness won't be forgotten."\n\nüí∞ +${quest.rewardGold} Gold\nüåü +${quest.rewardXp} XP`);
    
    updateUI();
}

function openJournal() {
    if (gameState === 'START' || gameState === 'WELCOME' || gameState === 'COMBAT') return;
    
    // Hide other overlay screens if open, but preserve their previousGameState
    if (gameState === 'INV') {
        document.getElementById('inventory-screen').style.display = 'none';
        // Reset inventory menu states
        terrainMenuExpanded = false;
        document.getElementById('terrain-menu').classList.remove('expanded');
        document.getElementById('terrain-arrow').innerText = '‚ñº';
        spellsMenuExpanded = false;
        document.getElementById('spells-menu').classList.remove('expanded');
        document.getElementById('spells-arrow').innerText = '‚ñº';
        itemsMenuExpanded = false;
        document.getElementById('items-menu').classList.remove('expanded');
        document.getElementById('items-menu-arrow').innerText = '‚ñº';
    } else if (gameState === 'WORLD_MAP') {
        document.getElementById('worldmap-screen').style.display = 'none';
    } else if (gameState === 'MANUAL') {
        document.getElementById('manual-screen').style.display = 'none';
    } else if (gameState !== 'JOURNAL') {
        previousGameState = gameState;
    }
    
    gameState = 'JOURNAL';
    
    renderJournal();
    document.getElementById('journal-screen').style.display = 'flex';
}

function closeJournal() {
    document.getElementById('journal-screen').style.display = 'none';
    gameState = previousGameState;
    if (gameState === 'COMBAT') updateCombatUI();
    else if (gameState === 'MAP') renderMap();
}

function openManual() {
    if (gameState === 'START' || gameState === 'WELCOME' || gameState === 'COMBAT') return;
    
    // Hide other overlay screens if open, but preserve their previousGameState
    if (gameState === 'INV') {
        document.getElementById('inventory-screen').style.display = 'none';
        terrainMenuExpanded = false;
        document.getElementById('terrain-menu').classList.remove('expanded');
        document.getElementById('terrain-arrow').innerText = '‚ñº';
        spellsMenuExpanded = false;
        document.getElementById('spells-menu').classList.remove('expanded');
        document.getElementById('spells-arrow').innerText = '‚ñº';
        itemsMenuExpanded = false;
        document.getElementById('items-menu').classList.remove('expanded');
        document.getElementById('items-menu-arrow').innerText = '‚ñº';
    } else if (gameState === 'WORLD_MAP') {
        document.getElementById('worldmap-screen').style.display = 'none';
    } else if (gameState === 'JOURNAL') {
        document.getElementById('journal-screen').style.display = 'none';
    } else if (gameState !== 'MANUAL') {
        previousGameState = gameState;
    }
    
    gameState = 'MANUAL';
    document.getElementById('manual-screen').style.display = 'flex';
}

function closeManual() {
    document.getElementById('manual-screen').style.display = 'none';
    gameState = previousGameState;
    if (gameState === 'COMBAT') updateCombatUI();
    else if (gameState === 'MAP') renderMap();
}

function turnInQuestFromJournal(questId) {
    const quest = player.quests.find(q => q.id === questId);
    if (!quest) return;
    
    closeJournal();
    showAlert(`üìç Return to the glowing house at World (${quest.worldX}, ${quest.worldY}) to turn in "${quest.title}"\n\nLook for the golden glow on the world map! üó∫Ô∏è`);
}

function renderJournal() {
    const container = document.getElementById('journal-content');
    
    if (!player.quests || player.quests.length === 0) {
        container.innerHTML = `
            <div class="no-quests">
                <p>üìú Your journal is empty.</p>
                <p style="margin-top: 10px;">Visit villagers in houses to find quests. Not everyone has a task, but many do!</p>
                <p style="margin-top: 10px; color: #95a5a6;">Completed Quests: ${player.completedQuests || 0}</p>
            </div>
        `;
        return;
    }
    
    const activeQuests = player.quests.filter(q => !q.turnedIn);
    const completedQuests = player.quests.filter(q => q.turnedIn);
    
    let html = `<div style="color: #95a5a6; margin-bottom: 15px; text-align: center;">Active Quests: ${activeQuests.length} | Completed: ${player.completedQuests || 0}</div>`;
    
    // Show active quests first
    activeQuests.forEach(quest => {
        const progress = getQuestProgress(quest);
        const isComplete = isQuestComplete(quest);
        const targetAmount = quest.targetAmount || 1;
        const progressText = (quest.type === 'buyspell' || quest.type === 'findcastle')
            ? (isComplete ? '‚úì Complete!' : 'In Progress...')
            : `${progress}/${targetAmount}`;
        
        const rewardGold = quest.rewardGold || 0;
        const rewardXp = quest.rewardXp || 0;
        
        html += `
            <div class="quest-card ${isComplete ? 'ready' : ''}">
                <div class="quest-title">${isComplete ? '‚úÖ ' : ''}${quest.title}</div>
                <div class="quest-giver">${quest.giver.icon} ${quest.giver.name}</div>
                <div class="quest-journal">"${quest.journalEntry}"</div>
                <div class="quest-progress">üìä Progress: ${progressText}</div>
                <div class="quest-reward">üéÅ Reward: ${rewardGold > 0 ? rewardGold + ' Gold' : ''} ${rewardXp > 0 ? rewardXp + ' XP' : ''}</div>
                <div class="quest-location">üìç ${isComplete ? '<span style="color: #27ae60;">Complete! Return to quest giver at</span>' : 'Return to:'} World (${quest.worldX}, ${quest.worldY})</div>
            </div>
        `;
    });
    
    // Show completed/turned-in quests
    if (completedQuests.length > 0) {
        html += `<div style="color: #27ae60; margin: 20px 0 10px 0; text-align: center; border-top: 1px solid #555; padding-top: 15px;">‚îÄ‚îÄ Completed Quests ‚îÄ‚îÄ</div>`;
        
        completedQuests.forEach(quest => {
            const rewardGold = quest.rewardGold || 0;
            const rewardXp = quest.rewardXp || 0;
            
            html += `
                <div class="quest-card completed" style="opacity: 0.7;">
                    <div class="quest-title" style="color: #27ae60;">‚úÖ ${quest.title}</div>
                    <div class="quest-giver">${quest.giver.icon} ${quest.giver.name}</div>
                    <div class="quest-journal" style="color: #7f8c8d;">"${quest.journalEntry}"</div>
                    <div class="quest-progress" style="color: #27ae60;">üìä Complete</div>
                    <div class="quest-reward" style="color: #7f8c8d;">üéÅ Earned: ${rewardGold > 0 ? rewardGold + ' Gold' : ''} ${rewardXp > 0 ? rewardXp + ' XP' : ''}</div>
                </div>
            `;
        });
    }
    
    container.innerHTML = html;
}

// Quest offer selection state
let questOfferIdx = 0;

function offerQuest(tile, quest) {
    // Store pending quest for acceptance
    window.pendingQuest = quest;
    window.pendingQuestTile = tile;
    questOfferIdx = 0; // Default to Accept
    
    const questOffer = `
        <div style="text-align: left;">
            <p><b>${quest.giver.icon} ${quest.giver.name}</b></p>
            <p style="margin: 15px 0; font-style: italic; color: #f1c40f;">"${quest.giverDialogue}"</p>
            <hr style="border-color: #555; margin: 15px 0;">
            <p><b>üìú Quest: ${quest.title}</b></p>
            <p style="color: #27ae60;">üéÅ Reward: ${quest.rewardGold > 0 ? quest.rewardGold + ' Gold, ' : ''}${quest.rewardXp} XP</p>
        </div>
    `;
    
    document.getElementById('npc-dialogue').innerHTML = questOffer;
    document.getElementById('store-area').style.display = 'block';
    renderQuestOfferButtons();
}

function renderQuestOfferButtons() {
    const acceptClass = questOfferIdx === 0 ? 'background: #27ae60; box-shadow: 0 0 10px #27ae60;' : 'background: #555;';
    const declineClass = questOfferIdx === 1 ? 'background: #e74c3c; box-shadow: 0 0 10px #e74c3c;' : 'background: #555;';
    
    const acceptBtn = `<button id="quest-accept-btn" onclick="acceptQuest()" style="${acceptClass} margin-right: 10px; padding: 10px 20px;">Accept Quest</button>`;
    const declineBtn = `<button id="quest-decline-btn" onclick="declineQuest()" style="${declineClass} padding: 10px 20px;">Decline</button>`;
    
    document.getElementById('store-content').innerHTML = `<div style="display: flex; justify-content: center; margin-top: 20px;">${acceptBtn}${declineBtn}</div>`;
}

function acceptQuest() {
    if (!window.pendingQuest) return;
    
    const quest = window.pendingQuest;
    player.quests.push(quest);
    
    // Mark the tile as having an active quest and clear pending quest
    window.pendingQuestTile.hasActiveQuest = true;
    window.pendingQuestTile.activeQuestId = quest.id;
    window.pendingQuestTile.pendingQuest = null; // Clear pending quest from tile
    
    window.pendingQuest = null;
    window.pendingQuestTile = null;
    
    // Exit house FIRST, then show alert so gameState is correct
    exitHouse();
    showAlert(`üìú Quest Accepted!\n\n"${quest.title}"\n\nCheck your Journal (üìú) for details.`);
}

function declineQuest() {
    // Clear pending quest from tile when explicitly declined
    if (window.pendingQuestTile) {
        window.pendingQuestTile.pendingQuest = null;
    }
    window.pendingQuest = null;
    window.pendingQuestTile = null;
    
    // Exit house FIRST, then show alert
    exitHouse();
    showAlert("Perhaps another time, then...");
}

function checkQuestTurnIn(tile) {
    // Check if player has a completed quest for this house (not already turned in)
    const houseKey = `${worldX},${worldY}-${tile.x},${tile.y}`;
    const quest = player.quests.find(q => q.houseKey === houseKey && isQuestComplete(q) && !q.turnedIn);
    return quest;
}

// Track monster kills for quests
function trackMonsterKill(enemyType) {
    if (!player.monstersKilled) player.monstersKilled = {};
    player.monstersKilled[enemyType] = (player.monstersKilled[enemyType] || 0) + 1;
}

// Track crafted items for quests
function trackCraftedItem(itemId) {
    if (!player.craftedItems) player.craftedItems = {};
    player.craftedItems[itemId] = (player.craftedItems[itemId] || 0) + 1;
}

/* --- UTILS --- */
        function getTile(x, y) { return (x<0||x>=MAP_SIZE||y<0||y>=MAP_SIZE) ? null : map[y*MAP_SIZE+x]; }
        function setTile(x,y,d) { map[y*MAP_SIZE+x] = {...map[y*MAP_SIZE+x], ...d}; }
        function updateFog() {
            for(let y=-1; y<=1; y++) for(let x=-1; x<=1; x++) {
                let t=getTile(player.x+x, player.y+y); if(t) t.explored=true;
            }
        }
      function renderMap() {
            const el = document.getElementById('grid'); el.innerHTML = '';
            map.forEach(t => {
                const div = document.createElement('div');
                div.className = `tile ${t.type}`;
                
                // Add fished class to water tiles that have been fished
                if (t.type === 'water' && t.fished) {
                    div.classList.add('fished');
                }
                
                // Check if tile should be revealed through fog
                const locationKey = `${worldX},${worldY}`;
                const isRevealedShop = !t.explored && player.revealedShops[locationKey] && t.type === 'house' && t.meta === 'store';
                const isRevealedCamp = !t.explored && player.revealedCamps[locationKey] && t.type === 'campfire';
                const isRevealedChest = !t.explored && player.revealedChests[locationKey] && t.type === 'chest';
                const isRevealedDragon = !t.explored && player.revealedDragon && t.entity === 'dragon';
                const isRevealedCastle = !t.explored && player.revealedCastle && t.entity === 'princess';
                
                if (!t.explored && !isRevealedShop && !isRevealedCamp && !isRevealedChest && !isRevealedDragon && !isRevealedCastle) {
                    div.classList.add('fog');
                } else {
                    if (t.x===player.x && t.y===player.y) div.innerText = ASSETS.player;
                    else if (t.entity==='dragon') {
                        if (t.explored || player.revealedDragon) {
                            div.innerText = ASSETS.dragonSprite;
                            if (!t.explored) div.style.filter = 'brightness(1.5) drop-shadow(0 0 10px gold)';
                        } else {
                            div.classList.add('fog');
                        }
                    }
                    else if (t.entity==='princess') {
                        if (t.explored || player.revealedCastle) {
                            div.innerText = 'üë∏';
                            if (!t.explored) div.style.filter = 'brightness(1.5) drop-shadow(0 0 10px gold)';
                        } else {
                            div.classList.add('fog');
                        }
                    }
                    else if (t.entity) div.innerText = ASSETS[t.entity];
                    else if (t.type==='house') {
                        div.innerText = t.meta === 'store' ? ASSETS.store : ASSETS.house;
                        if (isRevealedShop) div.style.filter = 'brightness(1.5) drop-shadow(0 0 10px gold)';
                        
                        // Check if this house has an active quest (not turned in)
                        const houseKey = `${worldX},${worldY}-${t.x},${t.y}`;
                        const hasActiveQuest = player.quests && player.quests.some(q => q.houseKey === houseKey && !q.turnedIn);
                        if (hasActiveQuest) {
                            div.classList.add('quest-house');
                        }
                    }
                    else if (t.type==='campfire') {
                        div.innerText = ASSETS.campfire;
                        if (isRevealedCamp) div.style.filter = 'brightness(1.5) drop-shadow(0 0 10px gold)';
                    }
                    else if (t.type==='chest') {
                        // Show different chest icons based on rarity
                        const chestIcon = t.meta === 'rare' ? 'üíé' : t.meta === 'uncommon' ? 'üéÅ' : 'üì¶';
                        div.innerText = chestIcon;
                        if (isRevealedChest) div.style.filter = 'brightness(1.5) drop-shadow(0 0 10px gold)';
                    }
                    else if (ASSETS[t.type]) div.innerText = ASSETS[t.type];
                }
                div.onclick = () => onTileClick(t);
                el.appendChild(div);
            });
        }
        function updateUI() {
            document.getElementById('ui-lvl').innerText = player.lvl;
            document.getElementById('ui-xp').innerText = player.xp;
            document.getElementById('ui-next-xp').innerText = player.nextXp;
            
            // Show poison indicator on HP
            const hpEl = document.getElementById('ui-hp');
            hpEl.innerText = player.hp;
            if (playerPoisonTurns > 0) {
                hpEl.style.color = '#9b59b6';
                hpEl.title = `Poisoned! ${playerPoisonDamage} dmg/turn for ${playerPoisonTurns} more turns`;
            } else {
                hpEl.style.color = '';
                hpEl.title = '';
            }
            
            document.getElementById('ui-max-hp').innerText = player.maxHp;
            document.getElementById('ui-mp').innerText = player.mp;
            document.getElementById('ui-max-mp').innerText = player.maxMp;
            document.getElementById('ui-gold').innerText = player.gold;
            document.getElementById('ui-wood').innerText = player.inventory.wood;
            document.getElementById('ui-fish').innerText = player.inventory.fish;
            document.getElementById('ui-stone').innerText = player.inventory.stone || 0;
            
           // Show/hide spell buttons based on what player has learned
            if (player.hasLuminos) {
                document.getElementById('luminos-btn').style.display = 'flex';
            }
            if (player.spells.includes('revealShops')) {
                document.getElementById('reveal-shops-btn').style.display = 'flex';
            }
            if (player.spells.includes('revealCamps')) {
                document.getElementById('reveal-camps-btn').style.display = 'flex';
            }
            if (player.spells.includes('revealChests')) {
                document.getElementById('reveal-chests-btn').style.display = 'flex';
            }
            if (player.spells.includes('revealDragon')) {
                document.getElementById('reveal-dragon-btn').style.display = 'flex';
            }
            if (player.spells.includes('revealCastle')) {
                document.getElementById('reveal-castle-btn').style.display = 'flex';
            }
        }
        function playShake() {
            const el = document.getElementById('combat-screen');
            el.classList.add('shake'); setTimeout(()=>el.classList.remove('shake'),300);
        }
        
        function gainXp(amt) {
            if(player.hp<=0)return;
            player.xp+=amt;
            if(player.xp>=player.nextXp) {
                gameState='LEVEL_UP';
                player.lvl++; player.xp-=player.nextXp; player.nextXp=Math.floor(player.nextXp*1.5);
                player.maxHp+=20; player.maxMp+=10; player.atk+=5; player.hp=player.maxHp; player.mp=player.maxMp;
                
levelUpSpells = ['lightning','iceball','megaheal','bleed','cleanse','shatter','truestrike','slow','drainlife'].filter(s=>!player.spells.includes(s));
                levelUpIdx = 0;
                
                if(!levelUpSpells.length) { 
                    showAlert("Level Up! Stats Maxed."); 
                    gameState='MAP'; 
                    updateUI(); 
                    return; 
                }
                
                renderLevelUp();
                document.getElementById('levelup-screen').style.display='flex';
            }
            updateUI();
        }

        function renderLevelUp() {
            const box = document.getElementById('spell-options'); 
            box.innerHTML='';
            levelUpSpells.forEach((k, index) => {
                const spellData = SPELL_DB[k];
                const b=document.createElement('button'); 
                b.className = 'spell-btn';
                if (index === levelUpIdx) b.className += ' selected-spell';
                b.innerHTML=`<b>${spellData.name}</b><br><small>${spellData.desc}</small>`;
                b.onclick=() => learnSpell(k);
                if (spellData.flavor) b.title = spellData.flavor;
                box.appendChild(b);
            });
        }

        function learnSpell(k) {
            player.spells.push(k); 
            document.getElementById('levelup-screen').style.display='none'; 
            gameState='MAP'; 
            updateUI();
            showAlert(`Learned ${SPELL_DB[k].name}!`);
        }
        
        function endGame(win) { 
            gameState='END';
            modalIdx = 0;
            
            // Play appropriate end music
            if (musicEnabled) {
                if (win) {
                    playVictoryMusic();
                } else {
                    playGameOverMusic();
                }
            }
            
            renderEndScreen(win);
            document.getElementById('modal-screen').style.display='flex';
        }

        function renderEndScreen(win) {
            const titleEl = document.getElementById('modal-title');
            const btnGroup = document.getElementById('modal-btns');
            btnGroup.innerHTML = '';
            modalButtons = [];
            
            if (win === 'shadow') {
                // TRUE Victory - Shadow defeated
                titleEl.innerHTML = `
                    <div style="font-size: 3rem; margin-bottom: 20px;">‚ú® üåü üë§ üåü ‚ú®</div>
                    <div style="font-size: 2rem; color: #9b59b6; margin-bottom: 20px;">THE SHADOW IS VANQUISHED!</div>
                    <div style="font-size: 1rem; line-height: 1.6; max-width: 500px; margin: 0 auto; text-align: left;">
                        <p>As The Shadow's essence scatters to the heavens, you feel the world itself breathe a sigh of relief. The fog that has choked the land for centuries lifts completely. Colors seem brighter. The air smells sweeter.</p>
                        <p>You understand now. The Dragon was never the source of evil, merely its servant. The Shadow had manipulated events from beyond mortal perception, feeding on fear and despair for countless ages.</p>
                        <p>But you did what no hero before you could. You explored every corner of existence, pierced every veil of darkness, and faced the primordial evil itself.</p>
                        <p>The Princess crowns you not just as a hero, but as a legend. Songs will be sung of this day for ten thousand years. The World of Vibe enters a new golden age.</p>
                        <p style="color: #9b59b6; text-align: center; margin-top: 20px; font-size: 1.2rem;">You have achieved the TRUE ENDING.</p>
                        <p style="color: #f1c40f; text-align: center; font-size: 1rem;">The Shadow is gone. The land is free. And you... you are eternal.</p>
                    </div>
                `;
                
                modalButtons.push({
                    text: "üåÖ True Victory",
                    className: "ng-plus-btn",
                    action: () => {
                        window.close();
                        setTimeout(() => {
                            showAlert("Congratulations! You have achieved the TRUE ENDING of Vibe Quest!\n\nThank you for playing. You can close this tab now.");
                        }, 100);
                    }
                });
            } else if (win) {
                // Victory message with confetti
                titleEl.innerHTML = `
                    <div style="font-size: 3rem; margin-bottom: 20px;">üéâ ‚ú® üêâ ‚ú® üéâ</div>
                    <div style="font-size: 2rem; color: var(--gold); margin-bottom: 20px;">VICTORY!</div>
                    <div style="font-size: 1rem; line-height: 1.6; max-width: 500px; margin: 0 auto; text-align: left;">
                        <p>The Shadow Dragon falls, its dark form dissolving into mist and memory. As the last echoes of its roar fade, sunlight breaks through the cursed clouds for the first time in a century.</p>
                        <p>The people emerge from their homes, tears of joy streaming down weathered faces. Children who had never seen a clear sky gasp in wonder. The Princess emerges from her sanctuary, ready to rebuild the kingdom.</p>
                        <p>Your name will be sung in taverns and written in history. You are the hero who ended the eternal darkness. But deep in your heart, you remember the Dragon's final words...</p>
                        <p style="color: #e74c3c; font-style: italic;">"The Shadow never dies..."</p>
                        <p style="text-align: center; margin-top: 20px; color: var(--gold); font-size: 1.2rem;">Perhaps this is not the end, but merely the beginning...</p>
                    </div>
                `;
                
                modalButtons.push({
                    text: "üé≠ Quest Again!",
                    className: "ng-plus-btn",
                    action: () => {
                        document.getElementById('modal-screen').style.display = 'none';
                        initGame('NG+');
                    }
                });
                modalButtons.push({
                    text: "üåÖ The End?",
                    className: "",
                    action: () => {
                        window.close();
                        // Fallback if window.close() doesn't work
                        setTimeout(() => {
                            showAlert("Thank you for playing Vibe Quest!\n\nYou can close this tab now.");
                        }, 100);
                    }
                });
            } else {
                // Game Over - with flavor text
                const deathMessages = [
                    "The darkness claims another hero. Your body falls to the cold earth, and the last thing you see is the fog closing in. The people of Vibe will wait for another champion... but hope grows dimmer with each fallen warrior.",
                    "As your vision fades, you hear the Dragon's distant roar of triumph. The kingdom's last hope extinguished. Perhaps in another age, another wizard will rise. But for now, the Shadow's grip on this land tightens ever further.",
                    "Your journey ends here, in this forsaken place. The villagers who placed their faith in you will never know what became of their hero. The fog swallows your story, as it has swallowed so many before.",
                    "The light leaves your eyes. Somewhere, Princess Elara feels a cold wind and knows that another brave soul has fallen. She clutches the Blade of Dawn tighter, waiting, always waiting, for a hero who may never come.",
                    "You fought bravely, but bravery alone cannot conquer evil. As darkness takes you, you wonder if the prophecy was wrong, or if you simply were not the one it spoke of. The world of Vibe remains shrouded in despair."
                ];
                const randomDeath = deathMessages[Math.floor(Math.random() * deathMessages.length)];
                
                titleEl.innerHTML = `
                    <div style="font-size: 3rem; margin-bottom: 20px;">üíÄ</div>
                    <div style="font-size: 2rem; color: #e74c3c; margin-bottom: 20px;">GAME OVER</div>
                    <div style="font-size: 0.9rem; line-height: 1.6; max-width: 450px; margin: 0 auto; color: #bdc3c7; font-style: italic;">
                        <p>${randomDeath}</p>
                    </div>
                `;
                modalButtons.push({
                    text: "üîÑ Try Again",
                    className: "",
                    action: () => {
                        document.getElementById('modal-screen').style.display = 'none';
                        initGame('RESET');
                    }
                });
            }

            modalButtons.forEach((btn, index) => {
                const button = document.createElement('button');
                button.innerText = btn.text;
                button.className = btn.className;
                if (index === modalIdx) {
                    button.classList.add('selected-btn');
                }
                button.onclick = btn.action;
                btnGroup.appendChild(button);
            });
        }
/* --- MOBILE TOUCH CONTROLS --- */
function setupMobileControls() {
    const dpadButtons = document.querySelectorAll('.dpad-btn[data-direction]');
    
    dpadButtons.forEach(btn => {
        const direction = btn.dataset.direction;
        
        // Touch events
        btn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            handleMobileMove(direction);
        });
        
        // Mouse events (for testing on desktop)
        btn.addEventListener('mousedown', (e) => {
            e.preventDefault();
            handleMobileMove(direction);
        });
    });
}

function handleMobileMove(direction) {
    // Only allow movement in MAP state
    if (gameState !== 'MAP' || isInputBlocked) return;
    
    let dx = 0;
    let dy = 0;
    
    switch(direction) {
        case 'up': dy = -1; break;
        case 'down': dy = 1; break;
        case 'left': dx = -1; break;
        case 'right': dx = 1; break;
    }
    
    movePlayer(dx, dy);
}

// Add swipe gesture support
let touchStartX = 0;
let touchStartY = 0;
let touchEndX = 0;
let touchEndY = 0;

const gameContainer = document.getElementById('game-container');

let touchStartTime = 0;

gameContainer.addEventListener('touchstart', (e) => {
    if (gameState !== 'MAP' || isInputBlocked) return;
    
    touchStartTime = Date.now();
    touchStartX = e.changedTouches[0].clientX;
    touchStartY = e.changedTouches[0].clientY;
}, { passive: true });

gameContainer.addEventListener('touchend', (e) => {
    if (gameState !== 'MAP' || isInputBlocked) return;
    
    const touchEndTime = Date.now();
    const touchDuration = touchEndTime - touchStartTime;
    
    touchEndX = e.changedTouches[0].clientX;
    touchEndY = e.changedTouches[0].clientY;
    
    const deltaX = touchEndX - touchStartX;
    const deltaY = touchEndY - touchStartY;
    const totalDistance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
    
    // If it's a quick tap with minimal movement, let the click event through
    if (touchDuration < 200 && totalDistance < 10) {
        // This is a tap, not a swipe - let it propagate to tile clicks
        return;
    }
    
    // Otherwise, treat it as a swipe
    if (totalDistance > 30) {
        e.preventDefault(); // Only prevent default for actual swipes
        handleSwipe();
    }
}, { passive: false });

// Remove the touchmove preventDefault - it blocks tile interactions

function handleSwipe() {
    const deltaX = touchEndX - touchStartX;
    const deltaY = touchEndY - touchStartY;
    
    // Determine if horizontal or vertical swipe
    if (Math.abs(deltaX) > Math.abs(deltaY)) {
        // Horizontal swipe
        if (deltaX > 0) {
            movePlayer(1, 0);  // Right
        } else {
            movePlayer(-1, 0); // Left
        }
    } else {
        // Vertical swipe
        if (deltaY > 0) {
            movePlayer(0, 1);  // Down
        } else {
            movePlayer(0, -1); // Up
        }
    }
}


// Initialize mobile controls
setupMobileControls();
        initGame('RESET');
    </script>

 <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('Service Worker registered'))
                    .catch(err => console.log('Service Worker registration failed:', err));
            });
        }
    </script>

</body>
</html>